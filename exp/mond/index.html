<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Mondego - Controlo de Cotas e Histórico</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #0a0a0f; color: white; display: flex; flex-direction: column; height: 100vh; }
        #map { height: 50vh; width: 100%; background: #111; }
        .main-container { display: flex; flex-wrap: wrap; flex: 1; overflow-y: auto; background: #161625; }
        .panel { flex: 2; padding: 15px; display: flex; flex-direction: column; gap: 10px; border-right: 1px solid #333; }
        .sidebar { flex: 1; padding: 15px; background: #1a1a2e; min-width: 250px; }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .slider-box { background: #1f1f2e; padding: 10px; border-radius: 8px; border-left: 4px solid #00d2ff; }
        
        .monitor-area { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .time-display { background: #000; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #00d2ff; display: flex; justify-content: space-around; }
        .graph-box { background: #1f1f2e; padding: 10px; border-radius: 8px; position: relative; height: 100px; }
        
        .bar-coimbra { position: absolute; bottom: 0; width: 5px; background: #f1c40f; }
        .bar-baixo { position: absolute; bottom: 0; width: 5px; background: #3498db; }
        
        table { width: 100%; font-size: 11px; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #333; padding: 5px; text-align: left; }
        th { background: #00d2ff; color: black; }
        .at-risk { color: #e74c3c; font-weight: bold; }
        
        input[type=range] { width: 100%; accent-color: #00d2ff; cursor: pointer; }
        button { padding: 10px; border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 4px; width: 100%; }
        #btnRun { background: #27ae60; }
        #btnRun.active { background: #e74c3c; }
    </style>
</head>
<body>

<div id="map"></div>
<div class="main-container">
    <div class="panel">
        <div class="controls">
            <div class="slider-box" style="border-left-color: #f1c40f;">
                <label>Ajuste Cota Inicial (Coimbra): <b id="txtInitC">15.42</b>m</label>
                <input type="range" id="inpInitC" min="13.5" max="18.5" step="0.01" value="15.42">
            </div>
            <div class="slider-box">
                <label>Caudal: <b id="txtFlow">2100</b> m³/s</label>
                <input type="range" id="inpFlow" min="500" max="10000" step="100" value="2100">
            </div>
            <div class="slider-box">
                <label>Abertura Açude: <b id="txtGates">90</b>%</label>
                <input type="range" id="inpGates" min="0" max="100" value="90">
            </div>
            <div class="slider-box"><button id="btnRun">INICIAR</button></div>
        </div>

        <div class="monitor-area">
            <div class="time-display">
                <span>TEMPO: <b id="timer" style="color:#00d2ff">00d 00h</b></span>
                <span>COIMBRA: <b id="valC" style="color:#f1c40f">15.42</b>m</span>
            </div>
            <div class="graph-box" id="bars-container"></div>
        </div>
    </div>

    <div class="sidebar">
        <h4 style="margin-top:0; color:#00d2ff;">Registo de Máximos</h4>
        <table>
            <thead><tr><th>Local</th><th>Cota Máx.</th><th>Estado</th></tr></thead>
            <tbody id="logsTable"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([40.2015, -8.4335], 14);
    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png').addTo(map);

    const sensores = [
        {id: "Portela", pos: [40.1945, -8.4055], cota: 20.2, reg: "C"},
        {id: "Pte Sta Clara", pos: [40.2085, -8.4285], cota: 15.8, reg: "C"},
        {id: "Sta Clara Velha", pos: [40.2015, -8.4335], cota: 15.2, reg: "C"},
        {id: "Rotunda Almegue", pos: [40.2115, -8.4480], cota: 15.4, reg: "C"},
        {id: "Pereira", pos: [40.1610, -8.5860], cota: 11.2, reg: "B"}
    ];

    const emissores = [];
    sensores.forEach(s => {
        let circ = L.circle(s.pos, { radius: 10, color: '#3498db', weight: 1 }).addTo(map);
        L.marker(s.pos, { icon: L.divIcon({ className: 'label-ponto', html: s.id, iconAnchor: [30, -10] }) }).addTo(map);
        emissores.push({ obj: circ, ref: s, max: 0 });
    });

    let hC = 15.42, hB = 10.55, tempo = 0, rodando = false;

    // Controlos de UI
    document.getElementById('inpInitC').oninput = function() {
        if(!rodando) {
            hC = parseFloat(this.value);
            document.getElementById('txtInitC').innerText = hC.toFixed(2);
            document.getElementById('valC').innerText = hC.toFixed(2);
        }
    };
    document.getElementById('inpFlow').oninput = function() { document.getElementById('txtFlow').innerText = this.value; };
    document.getElementById('inpGates').oninput = function() { document.getElementById('txtGates').innerText = this.value; };

    function simular() {
        const flow = parseInt(document.getElementById('inpFlow').value);
        const gates = parseInt(document.getElementById('inpGates').value) / 100;

        let targetC = 14.8 + (flow / 1850) * (1.1 - gates);
        hC += (targetC - hC) * 0.03;
        let targetB = 9.0 + (flow / 1400) * (gates + 0.35);
        hB += (targetB - hB) * 0.015;

        updateVisuals();
        tempo++;
        document.getElementById('timer').innerText = `${Math.floor(tempo/24).toString().padStart(2,'0')}d ${(tempo%24).toString().padStart(2,'0')}h`;
        desenharGrafico();
    }

    function updateVisuals() {
        const tableBody = document.getElementById('logsTable');
        tableBody.innerHTML = '';

        emissores.forEach(e => {
            let nivelAt = (e.ref.reg === "C") ? hC : hB;
            if (nivelAt > e.max) e.max = nivelAt;

            let diff = nivelAt - e.ref.cota;
            if (diff > 0) {
                e.obj.setRadius(10 + (diff * 400));
                e.obj.setStyle({ color: '#e74c3c', fillOpacity: 0.5 });
            } else {
                e.obj.setRadius(10);
                e.obj.setStyle({ color: '#3498db', fillOpacity: 0.2 });
            }

            // Atualiza Tabela
            let row = tableBody.insertRow();
            row.insertCell(0).innerText = e.ref.id;
            row.insertCell(1).innerText = e.max.toFixed(2) + "m";
            let status = row.insertCell(2);
            if (e.max > e.ref.cota) { status.innerText = "INUNDADO"; status.className = "at-risk"; }
            else { status.innerText = "SEGURO"; }
        });
        document.getElementById('valC').innerText = hC.toFixed(2);
    }

    function desenharGrafico() {
        const container = document.getElementById('bars-container');
        const x = (tempo * 4) % container.offsetWidth;
        if (x < 4) container.innerHTML = '';
        const bC = document.createElement('div');
        bC.className = 'bar-coimbra';
        bC.style.left = x + 'px';
        bC.style.height = (hC - 13) * 15 + 'px';
        container.appendChild(bC);
    }

    document.getElementById('btnRun').onclick = function() {
        rodando = !rodando;
        this.innerText = rodando ? "PAUSAR" : "RETOMAR";
        this.className = rodando ? "active" : "";
        document.getElementById('inpInitC').disabled = rodando;
    };

    setInterval(() => { if(rodando) simular(); }, 1000);
    updateVisuals();
</script>
</body>
</html>
