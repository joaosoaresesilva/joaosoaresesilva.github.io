<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>MONDEGO MONITOR - PROPAGAÇÃO HIDRÁULICA APA</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Courier New', monospace; background: #050505; color: #d0d0d0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 35vh; width: 100%; background: #000; filter: grayscale(1) contrast(1.2) brightness(0.8); border-bottom: 2px solid #333; }
        .sar-header { background: rgba(0,0,0,0.9); padding: 8px 20px; display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px solid #444; color: #aaa; }
        .sar-header b { color: #f1c40f; }
        #timeDisplay { position: absolute; top: 60px; right: 20px; z-index: 1000; background: rgba(10, 10, 10, 0.9); padding: 12px; border: 1px solid #00d2ff; color: #00d2ff; text-align: right; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .panel { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px; border-right: 1px solid #222; background: #0a0a0a; }
        .sidebar { flex: 2; padding: 15px; background: #050505; overflow-y: auto; }
        .data-card { background: #111; padding: 15px; border-left: 4px solid #f1c40f; margin-bottom: 10px; }
        .data-card h3 { margin: 0 0 5px 0; font-size: 11px; color: #f1c40f; text-transform: uppercase; }
        .value-display { font-size: 1.8em; font-weight: bold; color: #fff; }
        table { width: 100%; font-size: 11px; border-collapse: collapse; }
        th { border-bottom: 2px solid #444; padding: 8px; text-align: left; color: #00d2ff; position: sticky; top: 0; background: #050505; }
        td { padding: 8px; border-bottom: 1px solid #222; }
        .at-risk { background: rgba(241, 196, 15, 0.1); color: #f1c40f; }
        .severe-risk { background: rgba(231, 76, 60, 0.15); color: #e74c3c; font-weight: bold; }
        .status-pulse { height: 8px; width: 8px; background: #2ecc71; border-radius: 50%; display: inline-block; margin-right: 5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>

<div class="sar-header">
    <div><span class="status-pulse"></span>FONTE: <b>APA - ESTAÇÃO COIMBRA AÇUDE (1627743374)</b></div>
    <div>MARÉ ESTIMADA: <b id="txtMare">0.00m</b></div>
    <div>SISTEMA: <b>MODELO DE PROPAGAÇÃO DETERMINÍSTICO</b></div>
</div>

<div id="timeDisplay">
    <small>LEITURA APA</small>
    <span id="simClock" style="font-size: 1.4em; font-weight: bold; display: block;">--:--:--</span>
</div>

<div id="map"></div>

<div class="main-container">
    <div class="panel">
        <div class="data-card">
            <h3>CAUDAL INSTANTÂNEO (Q)</h3>
            <div id="valFlow" class="value-display">---</div> <small>m³/s</small>
        </div>
        <div class="data-card">
            <h3>COTA NO AÇUDE (H)</h3>
            <div id="valCota" class="value-display">---</div> <small>m (Nível Real APA)</small>
        </div>
        
        <div style="background: #1a1a1a; padding: 10px; font-size: 10px; color: #888; border: 1px solid #333;">
            <b>LÓGICA DE CÁLCULO:</b><br>
            O sistema assume que a Cota (H) lida já contempla a gestão física do Açude. A propagação para jusante é calculada via perda de carga manning-dependente e bloqueio de maré na foz.
        </div>
    </div>

    <div class="sidebar">
        <table id="mainTable">
            <thead>
                <tr><th>ZONA MONITORIZADA</th><th>COTA CRÍTICA</th><th>NÍVEL ESTIMADO</th><th>ESTADO</th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', {zoomControl: false}).setView([40.1850, -8.6000], 11); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const localidades = [
        {id: "PONTE STA CLARA", pos: [40.2085, -8.4285], cota: 23.0, dist: 0.1},
        {id: "BAIXA (P. COMÉRCIO)", pos: [40.2092, -8.4298], cota: 21.0, dist: 0.3},
        {id: "ESTADIO UNIVERSITÁRIO", pos: [40.2045, -8.4345], cota: 21.0, dist: 0.6},
        {id: "MOSTEIRO STA CLARA", pos: [40.2018, -8.4340], cota: 19.5, dist: 1.0},
        {id: "TAVEIRO", pos: [40.1910, -8.5060], cota: 14.0, dist: 8.5},
        {id: "AMEAL", pos: [40.1750, -8.5350], cota: 13.2, dist: 11.0},
        {id: "ARZILA", pos: [40.1650, -8.5550], cota: 12.5, dist: 14.2},
        {id: "MONTEMOR (VILA)", pos: [40.1745, -8.6815], cota: 10.5, dist: 23.0},
        {id: "EREIRA", pos: [40.1420, -8.6950], cota: 9.8, dist: 26.5},
        {id: "FIGUEIRA (FOZ)", pos: [40.1450, -8.8250], cota: 4.5, dist: 41.0}
    ];

    let currentQ = 0, currentH = 0;
    let markers = {};

    localidades.forEach(l => {
        markers[l.id] = L.circle(l.pos, {radius: 250, color: '#00d2ff', weight: 1, fillOpacity: 0.1}).addTo(map);
    });

    async function fetchData() {
        try {
            const url = 'https://infoagua.apambiente.pt/pt/cheias/cheia-detalhe/1627743374';
            const res = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent(url));
            const json = await res.json();
            
            const flowMatch = json.contents.match(/(\d+[.,]?\d*)\s*m3\/s/);
            const cotaMatch = json.contents.match(/(\d+[.,]\d+)\s*m(?!\d|\/|3)/);
            
            if (flowMatch) currentQ = parseFloat(flowMatch[1].replace(',', '.'));
            if (cotaMatch) currentH = parseFloat(cotaMatch[1].replace(',', '.'));
            
            document.getElementById('valFlow').innerText = currentQ;
            document.getElementById('valCota').innerText = currentH.toFixed(2);
            document.getElementById('simClock').innerText = new Date().toLocaleTimeString();
            
            updateSimulation();
        } catch (e) { 
            console.error("Falha na sincronização APA");
            document.querySelector('.status-pulse').style.background = '#e74c3c';
        }
    }

    function updateSimulation() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        // Cálculo da Maré Baseado no Tempo (Ciclo de 12.4h)
        const agora = new Date();
        const cicloMare = 12.42 * 3600000;
        const nivelMare = Math.sin((agora.getTime() % cicloMare) / cicloMare * 2 * Math.PI) * 1.6;
        document.getElementById('txtMare').innerText = nivelMare.toFixed(2) + "m";

        localidades.forEach(l => {
            // FÓRMULA DE PROPAGAÇÃO:
            // O nível local depende de H_Coimbra, mas a influência do caudal (Q) aumenta à medida que 
            // descemos o rio e o canal se torna menos profundo ou mais estreito (efeito cumulativo).
            
            let decliveNatural = l.dist * 0.045; // Queda média por km
            let efeitoCaudal = (currentQ / 1800) * (1 + (l.dist / 35)); 
            
            // A maré tem influência máxima (100%) na Figueira e decresce até Coimbra (quase 0%)
            let influenciaMareLocal = nivelMare * (l.dist / 41);
            
            let hLocal = currentH - decliveNatural + efeitoCaudal + influenciaMareLocal;
            let diff = hLocal - l.cota;
            
            let row = tbody.insertRow();
            let status = "NORMAL";
            
            if (diff > 1.2) { 
                status = "CRÍTICO"; row.className = 'severe-risk'; 
                markers[l.id].setStyle({color: '#e74c3c', fillOpacity: 0.6, radius: 400});
            } else if (diff > 0) { 
                status = "ALERTA"; row.className = 'at-risk';
                markers[l.id].setStyle({color: '#f1c40f', fillOpacity: 0.4, radius: 300});
            } else {
                markers[l.id].setStyle({color: '#00d2ff', fillOpacity: 0.1, radius: 250});
            }

            row.insertCell(0).innerText = l.id;
            row.insertCell(1).innerText = l.cota.toFixed(1) + "m";
            row.insertCell(2).innerText = hLocal.toFixed(2) + "m";
            row.insertCell(3).innerText = status;
        });
    }

    // Ciclo de atualização: Dados APA a cada 5 min / Maré a cada 1 min
    fetchData();
    setInterval(fetchData, 300000); 
    setInterval(updateSimulation, 60000);

</script>
</body>
</html>
