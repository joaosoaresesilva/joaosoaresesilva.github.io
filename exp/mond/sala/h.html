<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Simulador Hidrodinâmico: Aguieira - Figueira da Foz</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #f4f4f9; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        canvas { width: 100% !important; height: 400px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Simulação de Fluxo: Rio Mondego</h2>
    <p>Simula o impacto da descarga da <strong>Barragem da Aguieira</strong> até à <strong>Figueira da Foz</strong>, considerando a maré.</p>
    
    <div class="controls">
        <label>Vazão de Descarga Aguieira (m³/s): 
            <input type="number" id="qIn" value="150" step="10">
        </label>
        <label>Coeficiente de Maré (Amplitude em metros): 
            <input type="number" id="mareAmp" value="1.5" step="0.1" min="0">
        </label>
        <button onclick="simular()">Atualizar Simulação</button>
    </div>

    <canvas id="graficoMondego"></canvas>
    
    <div style="margin-top: 20px; font-size: 0.9em; color: #555;">
        <strong>Nota Técnica:</strong> 
        <ul>
            <li><strong>Bloco 1 & 2:</strong> Atraso de ~4h até Coimbra.</li>
            <li><strong>Bloco 3:</strong> Açude de Coimbra (Efeito acumulador).</li>
            <li><strong>Bloco 4:</strong> Canal Estreito com resistência hidráulica aumentada.</li>
            <li><strong>Fronteira:</strong> Nível na foz oscila conforme $H_{mar} = A \cdot \sin(\omega t)$.</li>
        </ul>
    </div>
</div>

<script>
let chart;

function simular() {
    const qAguieira = parseFloat(document.getElementById('qIn').value);
    const ampMare = parseFloat(document.getElementById('mareAmp').value);
    
    const pontos = 48; // 24 horas em intervalos de 30min
    const dt = 0.5;    // passo de tempo
    
    let tempo = [];
    let vazaoCoimbra = [];
    let vazaoFoz = [];
    let nivelMare = [];

    // Parâmetros simplificados das Funções de Transferência
    const atrasoRio = 8;     // 4 horas = 8 passos de 30min
    const atrasoCanal = 4;   // 2 horas = 4 passos de 30min
    const kAçude = 0.8;      // Amortecimento do Açude
    
    for (let t = 0; t < pontos; t++) {
        tempo.push(t/2 + "h");
        
        // 1. Simulação do Atraso Aguieira -> Coimbra
        let qC = t > atrasoRio ? qAguieira * 0.95 : 0;
        vazaoCoimbra.push(qC);
        
        // 2. Simulação do Canal Estreito (Maior velocidade, menor largura)
        // A vazão na foz sofre influência da maré (contra-pressão)
        let hora = t/2;
        let mar = ampMare * Math.sin((2 * Math.PI * hora / 12.4)); // Ciclo de 12.4h
        nivelMare.push(mar);

        let qF = t > (atrasoRio + atrasoCanal) ? qC * 0.9 : 0;
        
        // Efeito da maré na vazão de saída (Simplificação da perda de carga)
        // Se a maré está alta, a vazão de saída diminui ligeiramente
        let qFinal = qF - (mar * 10); 
        vazaoFoz.push(Math.max(qFinal, 0));
    }

    renderizarGrafico(tempo, vazaoCoimbra, vazaoFoz, nivelMare);
}

function renderizarGrafico(labels, d1, d2, d3) {
    const ctx = document.getElementById('graficoMondego').getContext('2d');
    
    if (chart) chart.destroy();
    
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Vazão em Coimbra (m³/s)',
                    data: d1,
                    borderColor: 'blue',
                    fill: false,
                    tension: 0.3
                },
                {
                    label: 'Vazão na Figueira da Foz (m³/s)',
                    data: d2,
                    borderColor: 'green',
                    fill: false,
                    tension: 0.3
                },
                {
                    label: 'Nível da Maré na Foz (m)',
                    data: d3,
                    borderColor: 'red',
                    borderDash: [5, 5],
                    yAxisID: 'y1',
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: { title: { display: true, text: 'Vazão (m³/s)' } },
                y1: { 
                    position: 'right', 
                    title: { display: true, text: 'Nível Mar (m)' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

// Inicializar
simular();
</script>
</body>
</html>
