<!DOCTYPE html>
<html>
<head>
    <title>MODELO HIDRODINÂMICO MONDEGO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; }
        .container { width: 900px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-top: 20px; }
        .controls { display: flex; justify-content: space-around; padding: 20px; background: #e9ecef; border-radius: 8px; margin-bottom: 20px; }
        .status { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }
        .critical { color: #dc3545; }
    </style>
</head>
<body>

<div class="container">
    <h2>Coração do Modelo: Aguieira vs Coimbra</h2>
    
    <div class="controls">
        <div>
            <label>Comportas Açude (G): <b id="gVal">10</b>%</label><br>
            <input type="range" id="gateCtrl" min="0" max="100" value="10">
        </div>
        <div>
            <button id="stormBtn" style="padding: 10px 20px; cursor:pointer;">Simular Pico da Aguieira (2200 m³/s)</button>
        </div>
    </div>

    <div class="status" id="statusTxt">Estado: Estável</div>
    <canvas id="hidrograma"></canvas>
</div>

<script>
    const ctx = document.getElementById('hidrograma').getContext('2d');
    
    // Variáveis do Modelo
    let tempo = Array.from({length: 60}, (_, i) => i); // 60 minutos/pontos
    let qIn = new Array(60).fill(200);   // Caudal vindo de montante
    let qOut = new Array(60).fill(200);  // Caudal saindo no açude
    let hCoimbra = new Array(60).fill(15); // Nível em Coimbra (metros)
    
    let gateAperture = 0.1; // 10% inicial
    const tau = 10; // Atraso simulado (ticks)
    const area = 5000; // Área do reservatório urbano

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: tempo,
            datasets: [
                { label: 'Caudal Aguieira (m³/s)', data: qIn, borderColor: '#ff9f43', fill: false, tension: 0.4 },
                { label: 'Caudal Açude (m³/s)', data: qOut, borderColor: '#2e86de', fill: false },
                { label: 'Nível Coimbra (m)', data: hCoimbra, borderColor: '#ee5253', yAxisID: 'y1' }
            ]
        },
        options: {
            scales: {
                y: { title: { display: true, text: 'Caudal (m³/s)' } },
                y1: { position: 'right', title: { display: true, text: 'Nível (m)' }, min: 14, max: 22 }
            }
        }
    });

    function simularPasso() {
        // 1. Deslocar dados para a esquerda
        qIn.shift();
        qOut.shift();
        hCoimbra.shift();

        // 2. Novo Caudal de Entrada (Mantém ou sobe se houver tempestade)
        let novoQin = qIn[qIn.length-1];
        qIn.push(novoQin);

        // 3. Cálculo da Saída (Física do Açude)
        let nivelAtual = hCoimbra[hCoimbra.length-1];
        let calculoSaida = gateAperture * 2000 * Math.sqrt(nivelAtual - 14); 
        qOut.push(calculoSaida);

        // 4. Balanço de Massa (Equação Diferencial Discreta)
        // O caudal que chega a Coimbra é o qIn de 10 passos atrás (Tau)
        let qChegada = qIn[qIn.length - tau] || qIn[0];
        let deltaH = (qChegada - calculoSaida) / area;
        let novoH = nivelAtual + deltaH;
        hCoimbra.push(novoH);

        // 5. Update Visual
        if(novoH > 20) {
            document.getElementById('statusTxt').innerHTML = "ALERTA: INUNDAÇÃO NA BAIXA!";
            document.getElementById('statusTxt').className = "status critical";
        } else {
            document.getElementById('statusTxt').innerHTML = "Estado: Controlado";
            document.getElementById('statusTxt').className = "status";
        }

        chart.update('none');
    }

    // Controles
    document.getElementById('gateCtrl').oninput = function() {
        gateAperture = this.value / 100;
        document.getElementById('gVal').innerText = this.value;
    };

    document.getElementById('stormBtn').onclick = function() {
        // Simular uma subida brusca na Aguieira
        for(let j=0; j<20; j++) qIn[qIn.length-1-j] = 2200;
    };

    setInterval(simularPasso, 500);
</script>
</body>
</html>
