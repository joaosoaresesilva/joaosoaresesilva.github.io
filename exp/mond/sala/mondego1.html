<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>MONDEGO AC CIRCUIT: Modelação por Impedância</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Courier New', monospace; background: #0a0a0a; color: #00ff41; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .dashboard { width: 1150px; background: #111; padding: 25px; border: 2px solid #00ff41; border-radius: 5px; box-shadow: 0 0 20px rgba(0,255,65,0.2); }
        .status-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #000; padding: 15px; border: 1px solid #00ff41; text-align: center; }
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 20px 0; padding: 20px; border: 1px dashed #00ff41; }
        .btn-auto { width: 100%; padding: 12px; font-weight: bold; cursor: pointer; background: #000; color: #00ff41; border: 1px solid #00ff41; }
        .auto-on { background: #00ff41; color: #000; }
        .indicator { font-size: 1.4em; font-weight: bold; }
        label { font-size: 0.8em; color: #00ff41; text-transform: uppercase; }
        input[type=range] { width: 100%; accent-color: #00ff41; }
    </style>
</head>
<body>

<div class="dashboard">
    <h2 style="text-align: center;">SISTEMA MONDEGO: MODELO DE IMPEDÂNCIA AC</h2>
    
    <div class="status-grid">
        <div class="stat-card">
            <label>Fonte: Aguieira [I_in]</label><br>
            <span id="qIn_txt" class="indicator">250</span> <small>m³/s</small>
        </div>
        <div class="stat-card">
            <label>Nó Coimbra [V_cota]</label><br>
            <span id="hC_txt" class="indicator">15.50</span> <small>m</small>
        </div>
        <div class="stat-card">
            <label>Nó Alfarelos [V_cota]</label><br>
            <span id="hA_txt" class="indicator">8.50</span> <small>m</small>
        </div>
        <div class="stat-card">
            <label>Oposição: Maré [V_ext]</label><br>
            <span id="mare_txt" class="indicator">15.00</span> <small>m</small>
        </div>
    </div>

    <div class="controls">
        <div>
            <label>Amplitude da Fonte (Caudal)</label>
            <input type="range" id="qInCtrl" min="200" max="2800" value="250">
        </div>
        <div style="text-align: center;">
            <button id="btnAuto" class="btn-auto">FILTRO DE COMPENSAÇÃO: OFF</button>
            <div id="strategy_txt" style="font-size: 0.7em; margin-top: 8px;">MODO: MANUAL (Z_FIXO)</div>
        </div>
        <div>
            <label>Gate Transístor (Açude)</label>
            <input type="range" id="gateCtrl" min="0" max="100" value="20">
            <div style="text-align:right; font-size:0.8em;">Abertura: <span id="gVal">20</span>%</div>
        </div>
    </div>

    <canvas id="mainChart" height="100"></canvas>
</div>

<script>
    const ctx = document.getElementById('mainChart').getContext('2d');
    const samples = 120;
    
    // Arrays de sinais (Circuit signals)
    let signalIn = new Array(samples).fill(250);     // Corrente de entrada
    let signalOutC = new Array(samples).fill(15.5);  // Tensão em Coimbra
    let signalOutA = new Array(samples).fill(8.5);   // Tensão em Alfarelos
    let signalTide = new Array(samples).fill(15);    // Fonte de oposição AC
    let signalGate = new Array(samples).fill(0.2);   // Sinal de controlo da Gate

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: samples}, (_, i) => i),
            datasets: [
                { label: 'Caudal Fonte [I] (m3/s)', data: signalIn, borderColor: '#ff9f43', pointRadius: 0, borderWidth: 1 },
                { label: 'Cota Coimbra [V1] (m)', data: signalOutC, borderColor: '#f85149', yAxisID: 'y1', pointRadius: 0, borderWidth: 2 },
                { label: 'Cota Alfarelos [V2] (m)', data: signalOutA, borderColor: '#3fb950', yAxisID: 'y1', pointRadius: 0, borderWidth: 3 },
                { label: 'Oposição Maré [V_ac] (m)', data: signalTide, borderColor: '#555', borderDash: [5, 5], yAxisID: 'y1', pointRadius: 0, borderWidth: 1 }
            ]
        },
        options: { 
            animation: false, 
            scales: { 
                y: { min: 0, max: 3000, grid: { color: '#222' } }, 
                y1: { position: 'right', min: 7, max: 22, grid: { display: false } } 
            },
            plugins: { legend: { labels: { color: '#00ff41' } } }
        }
    });

    let tick = 0, gatePos = 0.2, autoMode = false, qAmplitude = 250;

    // FILTRO DE COMPENSAÇÃO (Lead-Lag Compensator)
    function compensadorFiltro(vC, vA, iFuturo, vMare) {
        let targetGate = 0.2;
        let msg = "IMPEDÂNCIA NOMINAL";

        // Se a corrente de entrada sobe (Transiente positivo)
        if (iFuturo > 800) {
            targetGate = 0.5 + (iFuturo - 800) * 0.0001;
            msg = "COMPENSAÇÃO DE TRANSIENTE";
        }

        // Se a voltagem em Coimbra atinge o limite de rutura
        if (vC > 19.5) {
            targetGate = 1.0; 
            msg = "PROTEÇÃO DE SOBRETENSÃO (CITY)";
        } 
        // Lógica de proteção de Alfarelos (Shunting)
        else if (iFuturo > 1200 && vC < 19.4) {
            targetGate = 0.75; // Limita a corrente para jusante
            msg = "LIMITADOR DE CORRENTE (ALFARE)";
        }

        gatePos += (targetGate - gatePos) * 0.1;
        document.getElementById('gateCtrl').value = Math.round(gatePos * 100);
        document.getElementById('gVal').innerText = Math.round(gatePos * 100);
        document.getElementById('strategy_txt').innerText = "MODO: " + msg;
    }

    function simular() {
        tick++;
        // 1. GERADOR AC (Maré)
        let vMare = 15.0 + Math.sin(tick * 0.1) * 1.5;
        
        // 2. FONTE DE CORRENTE (Aguieira)
        let iIn = qAmplitude + Math.sin(tick * 0.3) * (qAmplitude > 600 ? 50 : 0);
        
        if(autoMode) compensadorFiltro(signalOutC[samples-1], signalOutA[samples-1], iIn, vMare);

        // --- DINÂMICA DO CIRCUITO ---
        
        // Nó 1: Coimbra (Capacitância C1)
        let vC_old = signalOutC[samples-1];
        let iC_in = signalIn[samples-20]; // Delay de propagação na linha
        // Corrente que atravessa o Açude (Lei de Ohm: I = V/R ou I = V * G)
        let iAçude = gatePos * 5000 * Math.sqrt(Math.max(0.1, vC_old - vMare) / 1.1);
        let vC_new = vC_old + (iC_in - iAçude) / 9500;
        if(vC_new < 14.2) vC_new = 14.2;

        // Nó 2: Alfarelos (Capacitância C2 + Resistência de Carga)
        let vA_old = signalOutA[samples-1];
        let iA_in = signalGate[samples-12] * 4600; // Corrente vinda de Coimbra
        
        // RESISTÊNCIA DE CARGA (A Foz): A corrente de saída (iOut) 
        // aumenta com a voltagem acumulada (vA_old).
        // Isto impede que a cota suba infinitamente.
        let iOut = 480 * Math.pow(Math.max(0.1, vA_old - 7.8), 1.6);
        
        // Impedância da maré (Oposição)
        if (vMare > 15.3) iOut *= (1 - (vMare - 15.3) * 0.25);

        let vA_new = vA_old + (iA_in - iOut) / 42000;
        if(vA_new < 8.5) vA_new = 8.5;

        // ATUALIZAÇÃO DOS SINAIS
        signalIn.shift(); signalIn.push(iIn);
        signalOutC.shift(); signalOutC.push(vC_new);
        signalOutA.shift(); signalOutA.push(vA_new);
        signalTide.shift(); signalTide.push(vMare);
        signalGate.shift(); signalGate.push(gatePos);

        // UI INTERFACE
        document.getElementById('qIn_txt').innerText = Math.round(iIn);
        document.getElementById('hC_txt').innerText = vC_new.toFixed(2);
        document.getElementById('hA_txt').innerText = vA_new.toFixed(2);
        document.getElementById('mare_txt').innerText = vMare.toFixed(2);
        
        chart.update('none');
    }

    document.getElementById('qInCtrl').oninput = function() { qAmplitude = parseInt(this.value); };
    document.getElementById('gateCtrl').oninput = function() { if(!autoMode) gatePos = this.value / 100; };
    document.getElementById('btnAuto').onclick = function() { 
        autoMode = !autoMode; 
        this.className = "btn-auto " + (autoMode ? "auto-on" : "");
        this.innerText = autoMode ? "FILTRO DE COMPENSAÇÃO: ON" : "FILTRO DE COMPENSAÇÃO: OFF";
    };

    setInterval(simular, 400);
</script>
</body>
</html>
