<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>MONDEGO SMART CONTROL: Coimbra & Alfarelos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b0e14; color: #e0e0e0; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        .dashboard { width: 1100px; background: #161b22; padding: 25px; border-radius: 12px; border: 1px solid #30363d; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .flood-zones { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .zone-card { background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; position: relative; height: 100px; overflow: hidden; }
        .water-fill { position: absolute; bottom: 0; left: 0; width: 100%; background: #58a6ff; transition: height 0.3s ease; opacity: 0.6; }
        .danger-fill { background: #f85149 !important; }
        .zone-label { position: relative; z-index: 2; font-weight: bold; }
        .controls { display: grid; grid-template-columns: 1.5fr 1fr 1.5fr; gap: 20px; background: #0d1117; padding: 20px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 20px; align-items: center; }
        .btn-auto { padding: 15px; font-weight: bold; border-radius: 6px; border: none; cursor: pointer; transition: 0.3s; }
        .auto-off { background: #30363d; color: white; }
        .auto-on { background: #3fb950; color: white; box-shadow: 0 0 15px rgba(63, 185, 80, 0.4); }
        button#stormBtn { background: #da3633; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>

<div class="dashboard">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Gestão Preditiva de Bacia</h2>
        <div id="clock" style="font-family: monospace; font-size: 1.5em;">00:00</div>
    </div>

    <div class="flood-zones">
        <div class="zone-card">
            <div class="zone-label">COIMBRA (Limite 20.0m)<br><span id="hC_txt">15.50</span>m</div>
            <div id="fillCoimbra" class="water-fill"></div>
        </div>
        <div class="zone-card">
            <div class="zone-label">ALFARELOS (Limite 11.5m)<br><span id="hA_txt">9.50</span>m</div>
            <div id="fillAlfarelos" class="water-fill"></div>
        </div>
    </div>

    <div class="controls">
        <div>
            <label>Comportas: <b id="gVal" style="color:#d29922">20</b>%</label>
            <input type="range" id="gateCtrl" min="0" max="100" value="20">
        </div>
        <div style="text-align: center;">
            <button id="btnAuto" class="btn-auto auto-off">PILOTO AUTOMÁTICO: OFF</button>
        </div>
        <div>
            <button id="stormBtn" style="width: 100%;">DESCARGA AGUIEIRA (2500 m³/s)</button>
        </div>
    </div>

    <canvas id="mainChart"></canvas>
</div>

<script>
    const ctx = document.getElementById('mainChart').getContext('2d');
    const totalPontos = 96;
    let labelsHoras = [];
    for(let i=0; i<totalPontos; i++) {
        let h = Math.floor(i / 4).toString().padStart(2,'0');
        let m = ((i % 4) * 15).toString().padStart(2,'0');
        labelsHoras.push(`${h}:${m}`);
    }

    let qIn = new Array(totalPontos).fill(250);
    let qOutCoimbra = new Array(totalPontos).fill(250);
    let hCoimbra = new Array(totalPontos).fill(15.5);
    let hAlfarelos = new Array(totalPontos).fill(9.5);
    let hMare = new Array(totalPontos).fill(15.0);
    
    let tick = 0;
    let gateAperture = 0.2;
    let autoMode = false;

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labelsHoras,
            datasets: [
                { label: 'Aguieira (m³/s)', data: qIn, borderColor: '#ff9f43', pointRadius: 0 },
                { label: 'Coimbra (m)', data: hCoimbra, borderColor: '#f85149', yAxisID: 'y1', borderWidth: 3, pointRadius: 0 },
                { label: 'Alfarelos (m)', data: hAlfarelos, borderColor: '#3fb950', yAxisID: 'y1', borderWidth: 2, pointRadius: 0 },
                { label: 'Maré (m)', data: hMare, borderColor: '#444', borderDash: [5,5], yAxisID: 'y1', pointRadius: 0 }
            ]
        },
        options: { animation: false, scales: { y: { min: 0, max: 3500 }, y1: { position: 'right', min: 8, max: 24 } } }
    });

    function processar() {
        tick = (tick + 1) % totalPontos;
        document.getElementById('clock').innerText = labelsHoras[tick];

        let nivelMare = 15.0 + Math.sin((tick / totalPontos) * Math.PI * 4) * 1.5;
        let hC = hCoimbra[hCoimbra.length - 1];
        let hA = hAlfarelos[hAlfarelos.length - 1];

        // --- ALGORITMO DE CONTROLO PREDITIVO ---
        if (autoMode) {
            let qFuturo = qIn[qIn.length - 1]; // Monitoriza a Aguieira
            let alvo = 0.2; // Posição padrão (20%)

            // Se vem cheia, abre ANTES da água chegar
            if (qFuturo > 1000) alvo = 0.05; 
            if (qFuturo > 2000) alvo = 0.0;

            // Se Alfarelos está a subir demais, tenta segurar (se Coimbra permitir)
            if (hA > 11.2 && hC < 19.5) alvo = 0.35;

            // Suavização do movimento das comportas
            gateAperture += (alvo - gateAperture) * 0.1;
            document.getElementById('gateCtrl').value = gateAperture * 100;
            document.getElementById('gVal').innerText = Math.round(gateAperture * 100);
        }

        // FÍSICA DO SISTEMA
        let descarga = gateAperture * 2800 * Math.sqrt(Math.max(0.1, hC - nivelMare) / 2);
        let qChegadaC = qIn[qIn.length - 20] || qIn[0];
        let novoHC = hC + (qChegadaC - descarga) / 7000;

        let qChegadaA = qOutCoimbra[qOutCoimbra.length - 8] || qOutCoimbra[0];
        let novoHA = hA + (qChegadaA - 180 * Math.sqrt(Math.max(0.1, hA - 8.5))) / 15000;

        // Atualizar Arrays
        qIn.shift(); qIn.push(qIn[qIn.length-1]);
        qOutCoimbra.shift(); qOutCoimbra.push(descarga);
        hCoimbra.shift(); hCoimbra.push(novoHC);
        hAlfarelos.shift(); hAlfarelos.push(novoHA);
        hMare.shift(); hMare.push(nivelMare);

        // UI
        document.getElementById('hC_txt').innerText = novoHC.toFixed(2);
        document.getElementById('hA_txt').innerText = novoHA.toFixed(2);
        document.getElementById('fillCoimbra').style.height = (novoHC - 14) * 15 + "%";
        document.getElementById('fillAlfarelos').style.height = (novoHA - 8.5) * 25 + "%";
        
        if(novoHC > 20) document.getElementById('fillCoimbra').classList.add('danger-fill');
        else document.getElementById('fillCoimbra').classList.remove('danger-fill');
        
        if(novoHA > 11.5) document.getElementById('fillAlfarelos').classList.add('danger-fill');
        else document.getElementById('fillAlfarelos').classList.remove('danger-fill');

        chart.update('none');
    }

    document.getElementById('gateCtrl').oninput = function() {
        if(!autoMode) gateAperture = this.value / 100;
        document.getElementById('gVal').innerText = this.value;
    };

    document.getElementById('btnAuto').onclick = function() {
        autoMode = !autoMode;
        this.innerText = autoMode ? "PILOTO AUTOMÁTICO: ON" : "PILOTO AUTOMÁTICO: OFF";
        this.className = autoMode ? "btn-auto auto-on" : "btn-auto auto-off";
    };

    document.getElementById('stormBtn').onclick = function() {
        qIn[qIn.length - 1] = 2500;
        setTimeout(() => { qIn[qIn.length-1] = 300; }, 5000);
    };

    setInterval(processar, 500);
</script>
</body>
</html>
