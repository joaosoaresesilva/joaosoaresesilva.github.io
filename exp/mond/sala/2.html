<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Simulador de Controlo de Fluxo - Mondego</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; text-align: center; }
        .controls { display: grid; grid-template-columns: 1-1-1; gap: 20px; margin-bottom: 30px; padding: 15px; background: #eef2f3; border-radius: 5px; }
        .status { font-weight: bold; color: #e74c3c; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Controlo de Caudal: Modelo Telecomunicações</h1>
    
    <div class="controls">
        <div>
            <label>Caudal Aguieira (Entrada):</label>
            <input type="range" id="inputAguieira" min="0" max="2500" value="800" oninput="updateVal('vAguieira', this.value)">
            <span id="vAguieira">800</span> m³/s
        </div>
        <div>
            <label>Afluentes (Ruído/Ceira):</label>
            <input type="range" id="inputCeira" min="0" max="1000" value="200" oninput="updateVal('vCeira', this.value)">
            <span id="vCeira">200</span> m³/s
        </div>
        <div>
            <label>Amplitude da Maré:</label>
            <input type="range" id="inputMare" min="0" max="4" step="0.5" value="2" oninput="updateVal('vMare', this.value)">
            <span id="vMare">2</span> m
        </div>
    </div>

    <canvas id="riverChart"></canvas>
    
    <div id="statusAlert" class="status">SISTEMA ESTÁVEL</div>
</div>

<script>
    const ctx = document.getElementById('riverChart').getContext('2d');
    const labels = Array.from({length: 48}, (_, i) => i + "h");
    
    // Latências (em horas)
    const tau_coimbra = 4; 
    const tau_alfarelos = 6;

    let dataAguieira = Array(48).fill(800);
    let dataAlfarelos = Array(48).fill(0);
    let dataMare = Array(48).fill(0);

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'Caudal Aguieira (T-0)', data: dataAguieira, borderColor: '#3498db', fill: false },
                { label: 'Caudal Alfarelos (Com Latência)', data: dataAlfarelos, borderColor: '#e67e22', fill: true, backgroundColor: 'rgba(230, 126, 34, 0.1)' },
                { label: 'Efeito Maré (Resistência)', data: dataMare, borderColor: '#9b59b6', borderDash: [5, 5], fill: false }
            ]
        },
        options: {
            scales: { y: { beginAtZero: true, title: { display: true, text: 'm³/s | Nível Maré' } } },
            animation: false
        }
    });

    function updateVal(id, val) { document.getElementById(id).innerText = val; simulate(); }

    function simulate() {
        const qIn = parseFloat(document.getElementById('inputAguieira').value);
        const qCeira = parseFloat(document.getElementById('inputCeira').value);
        const mareAmp = parseFloat(document.getElementById('inputMare').value);

        // Atualizar dados no tempo
        for(let t=0; t<48; t++) {
            // Simular Maré Sinusoidal (Período de 12h)
            let mareEfeito = Math.sin((t * Math.PI) / 6) * mareAmp;
            dataMare[t] = (mareEfeito * 100) + 500; // Normalizado para visualização

            // Alfarelos recebe o que saiu da Aguieira há 6 horas + afluentes
            let tLag = t - tau_alfarelos;
            let caudalBase = tLag >= 0 ? qIn : 800;
            
            // O caudal em Alfarelos é influenciado pela "rolha" da maré (Backpressure)
            // Se a maré está alta, a capacidade de escoamento diminui, aumentando o nível local
            dataAlfarelos[t] = caudalBase + qCeira + (mareEfeito * 50);
        }

        // Alerta de Cheia
        const maxFlow = Math.max(...dataAlfarelos);
        const alert = document.getElementById('statusAlert');
        if (maxFlow > 1500) {
            alert.innerText = "ALERTA DE CHEIA EM ALFARELOS! Reduzir Aguieira imediatamente.";
            alert.style.color = "red";
        } else {
            alert.innerText = "SISTEMA OPERACIONAL - DENTRO DOS LIMITES";
            alert.style.color = "green";
        }

        chart.update();
    }

    simulate();
</script>
</body>
</html>
