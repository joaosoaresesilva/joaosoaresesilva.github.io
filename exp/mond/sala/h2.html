<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Controlo de Cheias: Mondego</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #1a1a2e; color: white; }
        .container { max-width: 1100px; margin: auto; background: #16213e; padding: 25px; border-radius: 12px; }
        .status-panel { display: flex; justify-content: space-around; margin-bottom: 20px; padding: 15px; background: #0f3460; border-radius: 10px; }
        .alert { color: #e94560; font-weight: bold; }
        .safe { color: #0f3460; background: #22eaaa; padding: 5px 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Sistema Automático de Proteção: Coimbra & Alfarelos</h2>
    
    <div class="status-panel">
        <div>Caudal Crítico Alfarelos: <span class="alert">1200 m³/s</span></div>
        <div>Estado do Açude: <span id="statusAçude" class="safe">AUTOMÁTICO</span></div>
    </div>

    <canvas id="graficoCheia"></canvas>

    <div style="margin-top: 20px; font-size: 0.9em; opacity: 0.8;">
        <p><strong>Cenário:</strong> Tempestade Histórica (Simulação de 2200 m³/s na Aguieira).<br>
        O algoritmo de controle calcula a taxa de abertura das comportas para retardar a onda de cheia, usando o volume de armazenamento do espelho de água de Coimbra para proteger Alfarelos.</p>
    </div>
</div>

<script>
let chart;

function simularTempestade() {
    const passos = 120; // 60 horas
    const dt = 0.5;
    const limiteSeguranca = 1200;
    
    let tempo = [];
    let qAguieira = [];
    let qCoimbraOut = [];
    let nivelMare = [];

    // Variáveis de estado para o controle
    let volumeArmazenado = 0; 
    const capacidadeMaxAçude = 5000000; // m3 de reserva estratégica teórica

    for (let t = 0; t < passos; t++) {
        let hora = t * dt;
        tempo.push(hora + "h");

        // 1. Perfil da Tempestade Histórica (Pulso de Gauss)
        // O pico ocorre às 20h de simulação
        let vazaoPico = 2200 * Math.exp(-Math.pow(hora - 20, 2) / 40);
        let qIn = Math.max(vazaoPico, 150);
        qAguieira.push(qIn);

        // 2. Lógica de Controle do Açude (PID Simplificado)
        // O açude tenta não deixar a saída ultrapassar 1200 m3/s enquanto tiver volume
        let qOut;
        if (qIn > limiteSeguranca && volumeArmazenado < capacidadeMaxAçude) {
            qOut = limiteSeguranca; // Retém o excesso
            volumeArmazenado += (qIn - limiteSeguranca) * 1800; // m3 acumulados em 30min
        } else if (volumeArmazenado > 0) {
            // Liberta a água acumulada lentamente quando a tempestade abranda
            qOut = Math.min(qIn + 200, limiteSeguranca);
            volumeArmazenado -= (qOut - qIn) * 1800;
        } else {
            qOut = qIn;
        }

        // 3. Efeito da Maré na Foz (Afeta a capacidade de escoamento final)
        let mar = 2.0 * Math.sin((2 * Math.PI * hora / 12.4));
        nivelMare.push(mar);

        // O caudal que efetivamente passa por Alfarelos sofre influência do "represamento" da maré
        let qFinalAlfarelos = qOut - (mar > 1 ? mar * 50 : 0);
        qCoimbraOut.push(qFinalAlfarelos);
    }

    renderizar(tempo, qAguieira, qCoimbraOut, nivelMare);
}

function renderizar(labels, d1, d2, d3) {
    const ctx = document.getElementById('graficoCheia').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Descarga Aguieira (Tempestade)',
                    data: d1,
                    borderColor: '#e94560',
                    borderWidth: 1,
                    fill: false,
                    pointRadius: 0
                },
                {
                    label: 'Caudal Controlado (Coimbra/Alfarelos)',
                    data: d2,
                    borderColor: '#22eaaa',
                    backgroundColor: 'rgba(34, 234, 170, 0.2)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Ciclo de Marés (m)',
                    data: d3,
                    borderColor: '#fdbb2d',
                    yAxisID: 'y1',
                    borderDash: [5, 5],
                    pointRadius: 0
                }
            ]
        },
        options: {
            scales: {
                y: { title: { display: true, text: 'Vazão (m³/s)', color: '#fff' } },
                y1: { position: 'right', min: -5, max: 5 }
            },
            plugins: { legend: { labels: { color: '#fff' } } }
        }
    });
}

simularTempestade();
</script>
</body>
</html>
