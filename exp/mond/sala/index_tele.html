<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>MONDEGO DSP: Filtro Ativo com Sobreposição de Marés</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0d1117; color: #c9d1d9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .dashboard { width: 1100px; background: #161b22; padding: 25px; border-radius: 12px; border: 1px solid #30363d; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 20px 0; background: #0d1117; padding: 20px; border-radius: 8px; border: 1px solid #30363d; }
        .btn-auto { width: 100%; padding: 12px; font-weight: bold; cursor: pointer; border-radius: 6px; border: none; transition: 0.3s; }
        .auto-on { background: #238636; color: white; }
        .auto-off { background: #30363d; color: white; }
        .indicator { font-size: 1.2em; color: #58a6ff; font-family: monospace; font-weight: bold; }
        h2 { color: #58a6ff; margin-top: 0; text-align: center; text-transform: uppercase; letter-spacing: 2px; }
        label { display: block; margin-bottom: 8px; font-size: 0.85em; color: #8b949e; }
    </style>
</head>
<body>

<div class="dashboard">
    <h2>Análise de Sinais: Filtro Preditivo Mondego</h2>
    
    <div style="display: flex; justify-content: space-around; margin-bottom: 20px; background: #0d1117; padding: 15px; border-radius: 8px;">
        <div style="text-align:center">SAÍDA (Coimbra)<br><span id="hC_txt" class="indicator">15.50</span>m</div>
        <div style="text-align:center">RUÍDO (Maré)<br><span id="mare_txt" class="indicator">15.00</span>m</div>
        <div style="text-align:center">SINAL IN (Aguieira)<br><span id="qIn_txt" class="indicator">250</span> m³/s</div>
    </div>

    <div class="controls">
        <div>
            <label>AMPLITUDE DO SINAL (AGUIEIRA)</label>
            <input type="range" id="qInCtrl" min="200" max="2800" value="250" style="width: 100%;">
            <div style="text-align:right; font-size:0.8em; margin-top:5px;"><span id="qInVal">250</span> m³/s</div>
        </div>
        <div style="text-align: center;">
            <button id="btnAuto" class="btn-auto auto-off">FILTRO PREDITIVO: OFF</button>
            <div style="margin-top:10px; font-size:0.7em; color: #8b949e;">FRAME: <span id="tickVal">0</span></div>
        </div>
        <div>
            <label>GANHO DO FILTRO (ABERTURA AÇUDE)</label>
            <input type="range" id="gateCtrl" min="0" max="100" value="20" style="width: 100%;">
            <div style="text-align:right; font-size:0.8em; margin-top:5px;"><span id="gVal">20</span>% Aberto</div>
        </div>
    </div>

    <canvas id="mainChart" height="100"></canvas>
</div>

<script>
    const ctx = document.getElementById('mainChart').getContext('2d');
    const totalSamples = 96; 
    let labels = Array.from({length: totalSamples}, (_, i) => i);
    
    // Arrays de sinais
    let signalIn = new Array(totalSamples).fill(250);
    let signalOut = new Array(totalSamples).fill(15.5);
    let signalComp = new Array(totalSamples).fill(20);
    let signalTide = new Array(totalSamples).fill(15);
    
    let tick = 0, gatePos = 0.2, autoMode = false, qAmplitude = 250;

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'Aguieira (Sinal Entrada)', data: signalIn, borderColor: '#ff9f43', pointRadius: 0, borderWidth: 2 },
                { label: 'Coimbra (Resposta Sistema)', data: signalOut, borderColor: '#f85149', yAxisID: 'y1', pointRadius: 0, borderWidth: 3 },
                { label: 'Maré (Ruído de Saída)', data: signalTide, borderColor: '#8b949e', borderDash: [5, 5], yAxisID: 'y1', pointRadius: 0, borderWidth: 1 },
                { label: 'Açude (Ação do Filtro %)', data: signalComp, borderColor: '#58a6ff', pointRadius: 0, fill: true, backgroundColor: 'rgba(88,166,255,0.05)', borderWidth: 1 }
            ]
        },
        options: { 
            animation: false, 
            scales: { 
                y: { min: 0, max: 3000, title: {display: true, text: 'Caudal (m3/s)'} }, 
                y1: { position: 'right', min: 13, max: 23, title: {display: true, text: 'Cota (m)'} } 
            } 
        }
    });

    // Lógica do Filtro com Compensação de Maré
    function aplicarFiltro(mareAtual) {
        let sinalEntradaPreditivo = signalIn[signalIn.length - 1];
        let cotaAtual = signalOut[signalOut.length - 1];
        
        let alvoAperture = 20; // 20% default

        // 1. Feed-forward: Antecipa a onda da Aguieira
        if (sinalEntradaPreditivo > 800) {
            alvoAperture = 20 + (sinalEntradaPreditivo - 800) * 0.15;
        }

        // 2. Compensação de Impedância: Se a maré sobe, abre mais para manter vazão
        if (mareAtual > 15.5) {
            alvoAperture += (mareAtual - 15.5) * 15;
        }

        // 3. Segurança Crítica (Feedback)
        if (cotaAtual > 18.5) alvoAperture += 20;
        if (cotaAtual > 19.5) alvoAperture = 100;

        // Limitar a 100%
        alvoAperture = Math.min(100, alvoAperture);

        // Suavização do Atuador
        let erro = (alvoAperture/100) - gatePos;
        gatePos += erro * 0.3; 

        document.getElementById('gateCtrl').value = Math.round(gatePos * 100);
        document.getElementById('gVal').innerText = Math.round(gatePos * 100);
    }

    function simular() {
        tick++;
        document.getElementById('tickVal').innerText = tick;

        // Gerar Sinal da Maré (Oscilação lenta)
        let currentTide = 15.0 + Math.sin(tick * 0.1) * 1.5; 

        // Sinal de Entrada com ruído sinusoidal
        let sIn = qAmplitude + Math.sin(tick * 0.3) * (qAmplitude > 600 ? 40 : 5);
        
        if(autoMode) aplicarFiltro(currentTide);

        let hPrev = signalOut[signalOut.length - 1];
        
        // Modelo Físico: Vazão depende da Abertura * Raiz do Diferencial de Cota (Açude - Maré)
        let diferencialHidraulico = Math.max(0.05, hPrev - currentTide);
        let vazaoSaida = gatePos * 5000 * Math.sqrt(diferencialHidraulico / 1.05);
        
        // Atraso de transporte (20 frames)
        let vazaoChegada = signalIn[signalIn.length - 20];
        let novoH = hPrev + (vazaoChegada - vazaoSaida) / 9500;
        
        if(novoH < 14.2) novoH = 14.2;

        // Update Arrays
        signalIn.shift(); signalIn.push(sIn);
        signalOut.shift(); signalOut.push(novoH);
        signalComp.shift(); signalComp.push(gatePos * 100);
        signalTide.shift(); signalTide.push(currentTide);

        // UI Updates
        document.getElementById('hC_txt').innerText = novoH.toFixed(2);
        document.getElementById('mare_txt').innerText = currentTide.toFixed(2);
        document.getElementById('qIn_txt').innerText = Math.round(sIn);
        document.getElementById('qInVal').innerText = qAmplitude;
        
        chart.update('none');
    }

    document.getElementById('qInCtrl').oninput = function() { qAmplitude = parseInt(this.value); };
    document.getElementById('gateCtrl').oninput = function() { if(!autoMode) { gatePos = this.value / 100; document.getElementById('gVal').innerText = this.value; } };
    document.getElementById('btnAuto').onclick = function() { 
        autoMode = !autoMode; 
        this.className = "btn-auto " + (autoMode ? "auto-on" : "auto-off");
        this.innerText = autoMode ? "FILTRO PREDITIVO: ON" : "FILTRO PREDITIVO: OFF";
    };

    setInterval(simular, 400);
</script>
</body>
</html>
