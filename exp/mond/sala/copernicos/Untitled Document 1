<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>MONDEGO SAR - COIMBRA INTEGRADA</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #050505; color: #00d2ff; font-family: 'Courier New', monospace; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        #map { flex: 1; filter: contrast(1.3) brightness(0.8); }
        .ui-header { background: #111; padding: 10px; border-bottom: 2px solid #0044ff; display: flex; justify-content: space-between; font-size: 11px; }
        .panel { position: absolute; bottom: 30px; left: 20px; z-index: 1000; background: rgba(0,0,0,0.9); padding: 15px; border-left: 4px solid #0044ff; width: 280px; }
        .stat-line { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 10px; }
        .critical-id { color: #fff; font-weight: bold; border-bottom: 1px solid #333; margin-bottom: 10px; padding-bottom: 5px; }
    </style>
</head>
<body>

<div class="ui-header">
    <div>ESTENSÃO TOTAL: COIMBRA [KM 0] ➔ FIGUEIRA DA FOZ [KM 45]</div>
    <div>SISTEMA: <b id="sysStatus">ATIVO</b></div>
</div>

<div id="map"></div>

<div class="panel">
    <div class="critical-id">SETOR 01: COIMBRA URBANA</div>
    <div class="stat-line"><span>Caudal Açude:</span> <b id="qVal">---</b></div>
    <div class="stat-line"><span>Nível em Coimbra:</span> <b id="hCbr">---</b></div>
    <hr style="border:0; border-top:1px solid #333; margin:10px 0;">
    <div style="font-size:9px; opacity:0.7">ESTADO DAS CORREIAS (0-100m)</div>
    <div id="beltDisplay"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', {zoomControl: false}).setView([40.2030, -8.4300], 14); // Inicia focado em Coimbra
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    // EIXO MESTRE: De Coimbra (Km 0) até à Figueira (Km 45)
    const eixoMestre = [
        [40.2105, -8.4370], // Km 0: Açude-Ponte Coimbra
        [40.2025, -8.4315], // Km 1: Santa Clara / Parque
        [40.1880, -8.5080], // Km 8: Taveiro
        [40.1650, -8.5700], // Km 18: Pereira
        [40.1620, -8.6480], // Km 25: Montemor
        [40.1450, -8.8450]  // Km 45: Figueira da Foz
    ];

    const correiasDist = [0, 1, 10, 20, 50, 100];
    const nuvemSAR = [];

    function initGlobal() {
        correiasDist.forEach((dist) => {
            // Geramos 800 pontos para garantir densidade em Coimbra e extensão no vale
            for (let i = 0; i < 800; i++) {
                const perc = i / 800;
                const pBase = interpolate(eixoMestre, perc);
                
                const offset = (dist / 111000); 
                const lado = i % 2 === 0 ? 1 : -1; 
                const pos = [pBase[0] + (offset * 0.4 * lado), pBase[1] + (offset * lado)];
                
                // Cota Z: 18.5m em Coimbra, desce para 2m na Figueira
                const cotaBase = 18.5 - (perc * 16.5);
                const zPonto = cotaBase + (dist * 0.05);

                const marker = L.circleMarker(pos, {
                    radius: 1.2,
                    weight: 0,
                    fillOpacity: 0.6
                }).addTo(map);

                nuvemSAR.push({
                    id: (perc < 0.1 ? 'U' : 'R') + `-${dist}m-${i}`, // U para Urbano (Coimbra)
                    marker: marker,
                    distM: dist,
                    progresso: perc,
                    z: zPonto
                });
            }
        });
    }

    function interpolate(points, percent) {
        const idx = Math.floor(percent * (points.length - 1));
        const p1 = points[idx];
        const p2 = points[idx + 1] || p1;
        const sPerc = (percent * (points.length - 1)) - idx;
        return [p1[0] + (p2[0] - p1[0]) * sPerc, p1[1] + (p2[1] - p1[1]) * sPerc];
    }

    function engine() {
        const Q = 1050 + (Math.sin(Date.now()/5000) * 250); // Oscilação simulada
        const M = 1.1 + (Math.cos(Date.now()/7000) * 1.5);

        document.getElementById('qVal').innerText = Q.toFixed(0) + " m3/s";
        const hCoimbra = 19.5 + (Q/2000);
        document.getElementById('hCbr').innerText = hCoimbra.toFixed(2) + " m";

        const beltDisplay = document.getElementById('beltDisplay');
        beltDisplay.innerHTML = '';

        correiasDist.forEach(d => {
            const pts = nuvemSAR.filter(p => p.distM === d);
            let submersos = 0;

            pts.forEach(p => {
                // Influência de Q (Caudal) vs M (Maré) conforme a posição no rio
                const hLocal = 2.5 + (Q/2400 * (1-p.progresso)) + (M * 0.9 * p.progresso);
                const diff = hLocal - p.z;

                let color = "#00ff77"; // Verde
                if (diff >= 0.4) color = "#0044ff"; // Azul Forte
                else if (diff >= 0) color = "#00d2ff"; // Azul Claro
                
                p.marker.setStyle({fillColor: color});
                if (diff >= 0) submersos++;
            });

            const percIn = (submersos / pts.length) * 100;
            beltDisplay.innerHTML += `
                <div style="font-size:9px; margin-top:3px;">
                    ${d}m: <span style="color:${percIn > 30 ? '#ff4444' : '#00ff77'}">${percIn.toFixed(0)}% Ativo</span>
                </div>`;
        });
    }

    initGlobal();
    setInterval(engine, 3000);
    engine();

</script>
</body>
</html>
