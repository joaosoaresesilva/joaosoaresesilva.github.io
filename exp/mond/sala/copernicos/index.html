<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>MONDEGO MONITOR MASTER - COPERNICUS INTEGRATION</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Courier New', monospace; background: #050505; color: #d0d0d0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 35vh; width: 100%; background: #000; filter: contrast(1.1) brightness(0.8); border-bottom: 2px solid #444; }
        .sar-header { background: #111; padding: 8px 20px; display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px solid #00d2ff; color: #00d2ff; }
        .sar-link { color: #fff; text-decoration: underline; cursor: pointer; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .panel { flex: 0.8; padding: 15px; display: flex; flex-direction: column; gap: 8px; border-right: 1px solid #222; background: #0a0a0a; overflow-y: auto; }
        .sidebar { flex: 2.2; padding: 10px; background: #050505; overflow-y: auto; }
        .data-card { background: #111; padding: 8px; border: 1px solid #333; border-left: 4px solid #00d2ff; }
        .value-display { font-size: 1.6em; font-weight: bold; color: #fff; letter-spacing: -0.5px; }
        table { width: 100%; font-size: 10px; border-collapse: collapse; }
        th { border-bottom: 2px solid #444; padding: 10px; text-align: left; color: #00d2ff; position: sticky; top: 0; background: #050505; z-index: 10; }
        td { padding: 8px; border-bottom: 1px solid #222; color: #ffffff; }
        .status-alagado { color: #ff0000 !important; font-weight: bold; } 
        .status-sat { color: #0044ff !important; font-weight: bold; }
        .historic-tag { color: #f1c40f; font-size: 9px; border: 1px solid #f1c40f; padding: 1px 3px; border-radius: 2px; margin-right: 5px; }
        #btnLog { color: #00d2ff; border: 1px solid #00d2ff; background: transparent; padding: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: auto; }
        #updateProgress { height: 2px; background: #00d2ff; width: 0%; transition: width 0.5s; }
    </style>
</head>
<body>

<div class="sar-header">
    <div>MONITOR MASTER | DATASET: <a href="https://mapping.emergency.copernicus.eu/activations/EMSR864/" target="_blank" class="sar-link">COPERNICUS EMSR864</a></div>
    <div id="syncStatus">INICIALIZANDO...</div>
    <div>MAR√â: <b id="mareStatus">---</b></div>
</div>
<div id="updateProgress"></div>

<div id="map"></div>

<div class="main-container">
    <div class="panel">
        <div class="data-card" style="border-left-color: #9b59b6;">
            <h3>VOLUME ARMAZENADO</h3>
            <div id="valVol" class="value-display">0.00</div><small>hm¬≥</small>
        </div>
        <div class="data-card">
            <h3>COTA APA (hA)</h3>
            <div id="valCota" class="value-display">0.00</div><small>m (A√ßude)</small>
        </div>
        <div class="data-card" style="border-left-color: #f1c40f;">
            <h3>AFLUENTE (Qin)</h3>
            <div id="valFlowIn" class="value-display">0.00</div><small>m¬≥/s</small>
        </div>
        <div class="data-card" style="border-left-color: #e67e22;">
            <h3>EFLUENTE (Qout)</h3>
            <div id="valFlowOut" class="value-display">0.00</div><small>m¬≥/s</small>
        </div>
        <div class="data-card" id="cardBalance">
            <h3>BALAN√áO H√çDRICO</h3>
            <div id="valBalance" class="value-display">0.00</div>
            <div id="balanceDesc" style="font-size: 0.8em; font-weight: bold;">AGUARDANDO...</div>
        </div>
        <button id="btnLog">GERAR DATASET (.CSV)</button>
    </div>

    <div class="sidebar">
        <table id="mainTable">
            <thead>
                <tr><th>PONTO DE INTERESSE</th><th>SOLO (Z)</th><th>N√çVEL (h)</th><th>FONTE / ESTADO</th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', {zoomControl: false}).setView([40.1800, -8.5500], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    const localidades = [
        // Pontos de C√°lculo Matem√°tico
        {id: "MOSTEIRO STA CLARA-VELHA", pos: [40.2018, -8.4340], cota: 18.0, reg: "A", src: "CALC", dist: 0.1},
        {id: "PARQUE DA CAN√á√ÉO (MARGEM)", pos: [40.2032, -8.4315], cota: 18.2, reg: "A", src: "CALC", dist: 0.2},
        {id: "BAIXA DE COIMBRA (RIO)", pos: [40.2091, -8.4320], cota: 19.5, reg: "A", src: "CALC", dist: 0.1},
        {id: "TAVEIRO (CENTRO)", pos: [40.1880, -8.5080], cota: 14.2, reg: "B", src: "CALC", dist: 8.5},
        // Pontos Cr√≠ticos Copernicus EMSR864
        {id: "CAMPOS DO BOL√ÉO (DET.)", pos: [40.2245, -8.4682], cota: 17.5, reg: "B", src: "SAT", dist: 1.8},
        {id: "LEITOS TAVEIRO (DET.)", pos: [40.1865, -8.5125], cota: 13.8, reg: "B", src: "SAT", dist: 9.0},
        {id: "BACIA PEREIRA (DET.)", pos: [40.1652, -8.5741], cota: 11.2, reg: "B", src: "SAT", dist: 18.0},
        {id: "VALA REAL (DET.)", pos: [40.1488, -8.6820], cota: 8.5, reg: "B", src: "SAT", dist: 25.0},
        {id: "VILA VERDE (DET.)", pos: [40.1385, -8.8120], cota: 4.2, reg: "B", src: "SAT", dist: 38.0}
    ];

    let apaVol = 0, apaH = 0, apaQin = 0, apaQout = 0, hMare = 0;
    let dataset = "TIMESTAMP,LOCAL,FONTE,VOL,H_APA,Q_IN,Q_OUT,H_RIO,STATUS\n";
    let markers = {};

    localidades.forEach(l => {
        const style = l.src === "SAT" ? 
            {radius: 400, weight: 3, fillOpacity: 0.5, color: '#0044ff'} : 
            {radius: 250, weight: 1, fillOpacity: 0.2, color: '#ffffff'};
        
        markers[l.id] = L.circle(l.pos, style).addTo(map);
        markers[l.id].bindPopup(`<b>${l.id}</b><br>Fonte: ${l.src === "SAT" ? 'Copernicus Satellite' : 'C√°lculo Hidr√°ulico'}`);
    });

    function scrape(html, label) {
        const regex = new RegExp(label + "[\\s\\S]*?>\\s*([\\d,.]+)", "i");
        const match = html.match(regex);
        return match ? parseFloat(match[1].replace(',', '.')) : 0;
    }

    async function sync() {
        document.getElementById('updateProgress').style.width = "30%";
        try {
            const resAPA = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://infoagua.apambiente.pt/pt/cheias/cheia-detalhe/1627743374') + '&cache=' + new Date().getTime());
            const dataAPA = await resAPA.json();
            const html = dataAPA.contents;

            apaVol = scrape(html, "Volume");
            apaH = scrape(html, "Cota");
            apaQin = scrape(html, "Afluente");
            apaQout = scrape(html, "Efluente");

            const resMare = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://tabuademares.com/pt/coimbra/figueira-da-foz'));
            const dataMare = await resMare.json();
            const mMatch = dataMare.contents.match(/class="estado_actual_valor">([\d,.]+) m/);
            if (mMatch) hMare = parseFloat(mMatch[1].replace(',', '.')) - 2.00;

            document.getElementById('updateProgress').style.width = "100%";
            document.getElementById('syncStatus').innerText = "ATUALIZADO: " + new Date().toLocaleTimeString();
            document.getElementById('mareStatus').innerText = hMare.toFixed(2) + "m";
            
            updateUI();
        } catch (e) { document.getElementById('syncStatus').innerText = "ERRO SINC"; }
    }

    function updateUI() {
        document.getElementById('valVol').innerText = apaVol.toFixed(2);
        document.getElementById('valCota').innerText = apaH.toFixed(2);
        document.getElementById('valFlowIn').innerText = apaQin.toFixed(2);
        document.getElementById('valFlowOut').innerText = apaQout.toFixed(2);

        const diff = apaQin - apaQout;
        const bVal = document.getElementById('valBalance');
        bVal.innerText = (diff > 0 ? "+" : "") + diff.toFixed(2);
        bVal.style.color = diff > 0.5 ? "#00ff00" : (diff < -0.5 ? "#ff4444" : "#fff");

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        localidades.forEach(l => {
            let hFinal = (l.reg === "A") ? 
                apaH + (apaQout / 7500) : 
                (apaH - 4.1) + (apaQout / 2600) + (hMare * 0.55 * Math.max(0, 1 - (l.dist / 40)));

            let d = hFinal - l.cota;
            let st = d >= 0 ? "CHEIA" : (d >= -0.40 ? "ALERTA" : "NORMAL");
            let row = tbody.insertRow();
            
            row.innerHTML = `<td>${l.src === "SAT" ? 'üõ∞Ô∏è ' : ''}${l.id}</td>
                             <td>${l.cota.toFixed(2)}m</td>
                             <td>${hFinal.toFixed(2)}m</td>
                             <td class="${d >= 0 ? (l.src === "SAT" ? 'status-sat' : 'status-alagado') : ''}">${st}</td>`;

            let color = d >= 0 ? (l.src === "SAT" ? '#0044ff' : '#ff0000') : (d >= -0.40 ? '#ffa500' : (l.src === "SAT" ? '#0044ff' : '#ffffff'));
            markers[l.id].setStyle({color: color, fillOpacity: d >= 0 ? 0.7 : 0.3});
            
            dataset += `${new Date().toISOString()},"${l.id}","${l.src}",${apaVol},${apaH},${apaQin},${apaQout},${hFinal.toFixed(2)},${st}\n`;
        });
    }

    document.getElementById('btnLog').onclick = () => {
        const blob = new Blob([dataset], {type: 'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `MONITOR_COPERNICUS_DATA.csv`;
        a.click();
    };

    sync();
    setInterval(sync, 60000);
</script>
</body>
</html>
