<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Controlo Mondego - Cota 20 Baixa Coimbra</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #2c3e50; color: white; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: #34495e; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h1 { text-align: center; color: #ecf0f1; text-transform: uppercase; letter-spacing: 2px; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; }
        .panel { display: flex; flex-direction: column; }
        input[type=range] { cursor: pointer; margin-top: 10px; }
        .btn-auto { width: 100%; padding: 15px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .btn-auto.off { background: #e67e22; color: white; }
        .btn-auto.on { background: #2ecc71; color: white; }
        .alert-bar { padding: 15px; text-align: center; font-weight: bold; border-radius: 5px; margin-top: 20px; font-size: 1.2em; }
        .safe { background: #27ae60; }
        .danger { background: #c0392b; animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="container">
    <h1>Controlo de Cheias: Monitorização Cota 20</h1>
    
    <div class="controls">
        <div class="panel">
            <label>Caudal Aguieira: <span id="vAguieira">1200</span> m³/s</label>
            <input type="range" id="inputAguieira" min="400" max="3000" value="1200" oninput="update()">
        </div>
        <div class="panel">
            <label>Rio Ceira (Injeção Direta): <span id="vCeira">400</span> m³/s</label>
            <input type="range" id="inputCeira" min="0" max="1500" value="400" oninput="update()">
        </div>
        <div class="panel">
            <label>Maré (Figueira): <span id="vMare">3.0</span> m</label>
            <input type="range" id="inputMare" min="0" max="5" step="0.1" value="3.0" oninput="update()">
        </div>
    </div>

    <button id="btnAuto" class="btn-auto off" onclick="toggleAuto()">AUTO-REGULAÇÃO (AÇUDE): DESATIVADA</button>

    <canvas id="riverChart" height="450"></canvas>
    
    <div id="statusAlert" class="alert-bar safe">BAIXA DE COIMBRA: SEGURA (ABAIXO DA COTA 20)</div>
</div>

<script>
    const ctx = document.getElementById('riverChart').getContext('2d');
    let autoMode = false;
    const labels = Array.from({length: 48}, (_, i) => i + "h");
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'Nível Alfarelos (m³/s)', data: [], borderColor: '#e67e22', backgroundColor: 'rgba(230, 126, 34, 0.2)', fill: true, tension: 0.3 },
                { label: 'Cota 20 (Limite Crítico Baixa)', data: Array(48).fill(2100), borderColor: '#ff0000', borderDash: [10,5], borderWidth: 3, fill: false, pointRadius: 0 },
                { label: 'Nível Maré (m)', data: [], borderColor: '#9b59b6', yAxisID: 'y1', fill: false, tension: 0.4 }
            ]
        },
        options: {
            scales: { 
                y: { title: { display: true, text: 'Caudal Equivalente (m³/s)', color: '#fff' }, ticks: { color: '#fff' } },
                y1: { position: 'right', title: { display: true, text: 'Nível Maré (m)', color: '#fff' }, ticks: { color: '#fff' } }
            },
            plugins: { legend: { labels: { color: '#fff' } } }
        }
    });

    function toggleAuto() {
        autoMode = !autoMode;
        const btn = document.getElementById('btnAuto');
        btn.innerText = autoMode ? "AUTO-REGULAÇÃO ATIVA (PROTEÇÃO COTA 20)" : "AUTO-REGULAÇÃO (AÇUDE): DESATIVADA";
        btn.className = autoMode ? "btn-auto on" : "btn-auto off";
        update();
    }

    function update() {
        const qAguieira = parseFloat(document.getElementById('inputAguieira').value);
        const qCeira = parseFloat(document.getElementById('inputCeira').value);
        const mareAmp = parseFloat(document.getElementById('inputMare').value);
        
        document.getElementById('vAguieira').innerText = qAguieira;
        document.getElementById('vCeira').innerText = qCeira;
        document.getElementById('vMare').innerText = mareAmp;

        let nivelAlfarelos = [];
        let curvaMare = [];
        let inundacao = false;

        for(let t=0; t<48; t++) {
            let mareH = Math.sin((t * Math.PI) / 6) * mareAmp;
            curvaMare.push(mareH);

            let qEntradaTotal = qAguieira + qCeira;
            let qSaidaAcude = qEntradaTotal;

            // Lógica de Controlo do Açude focada na Cota 20
            if (autoMode) {
                // Se a maré futura ou o caudal atual ameaçam os 2100 m3/s (Equivalente à Cota 20)
                let riscoMare = Math.sin(((t + 2) * Math.PI) / 6) * mareAmp;
                if (qEntradaTotal + (riscoMare * 150) > 1900) {
                    qSaidaAcude = 1600 - (riscoMare * 100); // "Throttling" do fluxo
                }
            }

            // O impacto em Alfarelos considera a "Rolha Hidráulica" da Maré
            let fluxoFinal = qSaidaAcude + (mareH * 180); 
            nivelAlfarelos.push(fluxoFinal);

            if (fluxoFinal > 2100) inundacao = true; 
        }

        chart.data.datasets[0].data = nivelAlfarelos;
        chart.data.datasets[2].data = curvaMare;
        
        const status = document.getElementById('statusAlert');
        if (inundacao) {
            status.innerText = "CRÍTICO: CAUDAL ACIMA DA COTA 20 - BAIXA EM RISCO!";
            status.className = "alert-bar danger";
        } else {
            status.innerText = "BAI_XA DE COIMBRA: SEGURA (ABAIXO DA COTA 20)";
            status.className = "alert-bar safe";
        }
        chart.update();
    }
    update();
</script>
</body>
</html>
