<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>ALVA - RIO</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Courier New', monospace; background: #050505; color: #d0d0d0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 30vh; width: 100%; filter: grayscale(1) contrast(1.2) brightness(0.8); border-bottom: 2px solid #ff3333; }
        .sar-header { background: #111; padding: 10px 20px; display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px solid #333; color: #ff3333; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .panel { flex: 0.9; padding: 15px; background: #0a0a0a; border-right: 1px solid #222; display: flex; flex-direction: column; gap: 10px; }
        .sidebar { flex: 2.1; padding: 10px; background: #050505; overflow-y: auto; }
        .data-card { background: #111; padding: 10px; border: 1px solid #333; border-left: 4px solid #ff3333; }
        .sensor-label { font-size: 0.7em; color: #888; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .value-display { font-size: 1.8em; font-weight: bold; color: #fff; letter-spacing: -1px; }
        table { width: 100%; font-size: 10px; border-collapse: collapse; }
        th { border-bottom: 2px solid #444; padding: 8px; text-align: left; color: #ff3333; position: sticky; top: 0; background: #050505; }
        td { padding: 8px; border-bottom: 1px solid #1a1a1a; }
        .status-alagado { color: #ff3333; font-weight: bold; background: rgba(255,0,0,0.1); animation: blink 1s infinite; }
        .status-seco { color: #00ff77; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="sar-header">
    <div>MONITORIZAÇÃO RIO ALVA</div>
    <div>SINC: <b id="syncStatus">---</b></div>
</div>

<div id="map"></div>

<div class="main-container">
    <div class="panel">
        <div class="data-card">
            <span class="sensor-label">SEnsor APA 1: Ponte de Mucela (Jusante)</span>
            <div id="valFlow1" class="value-display">---</div><small>m³/s (Real)</small>
        </div>
        
        <div class="data-card">
            <span class="sensor-label">Estimativa 2: São Gião (Montante)</span>
            <div id="valFlow2" class="value-display">---</div><small>m³/s (Estimado)</small>
        </div>

        <div class="data-card" style="border-left-color: #ffa500;">
            <span class="sensor-label">Variação do Nível (Δh)</span>
            <div id="valDanger" class="value-display" style="color: #ffa500;">---</div><small>Metros acima do normal</small>
        </div>
    </div>

    <div class="sidebar">
        <table>
            <thead>
                <tr>
                    <th>LOCALIDADE</th>
                    <th>COTA LEITO</th>
                    <th>COTA TERRENO</th>
                    <th>MARGEM ÚTIL</th>
                    <th>ESTADO</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', {zoomControl: false}).setView([40.2300, -8.0200], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    // Dados baseados na topografia do Alva
    const localidades = [
        {id: "BARRIL DO ALVA (PASTOS)", z_leito: 157.5, z_terreno: 159.3, pos: [40.2225, -7.9472], k: 1.1},
        {id: "SECARIAS (PRAIA)", z_leito: 43.5, z_terreno: 45.0, pos: [40.2274, -8.0841], k: 0.9},
        {id: "CÔJA (PONTE ROMANA)", z_leito: 135.5, z_terreno: 138.0, pos: [40.2672, -7.9892], k: 1.0},
        {id: "AVÔ (ILHA DO PICOTO)", z_leito: 218.5, z_terreno: 220.0, pos: [40.2938, -7.9055], k: 1.3}
    ];

    let markers = {};
    localidades.forEach(l => {
        markers[l.id] = L.circle(l.pos, { radius: 350, color: '#444', weight: 1, fillOpacity: 0.2 }).addTo(map);
    });

    async function fetchData() {
        try {
            const proxy = 'https://api.allorigins.win/get?url=';
            const res = await fetch(proxy + encodeURIComponent('https://infoagua.apambiente.pt/pt/cheias/cheia-detalhe/1627758668'));
            const data = await res.json();
            
            const flowMatch = data.contents.match(/(\d+[.,]?\d*)\s*m3\/s/);
            const cotaMatch = data.contents.match(/(\d+[.,]\d+)\s*m(?!\d)/);
            
            if (flowMatch && cotaMatch) {
                let q1 = parseFloat(flowMatch[1].replace(',', '.'));
                let hAtual = parseFloat(cotaMatch[1].replace(',', '.'));
                let deltaH = hAtual - 0.40; // Subida em metros em relação ao estio

                // Atualizar sempre o Painel de Sensores
                document.getElementById('valFlow1').innerText = q1.toFixed(1);
                document.getElementById('valFlow2').innerText = (q1 * 1.15).toFixed(1);
                document.getElementById('valDanger').innerText = "+" + deltaH.toFixed(2);
                document.getElementById('syncStatus').innerText = new Date().toLocaleTimeString();

                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';

                localidades.forEach(l => {
                    let subidaLocal = deltaH * l.k;
                    let capacidadeLivre = (l.z_terreno - l.z_leito);
                    let folga = capacidadeLivre - subidaLocal;
                    let alagado = folga <= 0;

                    let row = tbody.insertRow();
                    row.insertCell(0).innerHTML = `<b>${l.id}</b>`;
                    row.insertCell(1).innerText = l.z_leito.toFixed(1) + "m";
                    row.insertCell(2).innerText = l.z_terreno.toFixed(1) + "m";
                    row.insertCell(3).innerText = (folga > 0 ? folga.toFixed(2) : "0.00") + "m";
                    
                    let cStatus = row.insertCell(4);
                    cStatus.innerText = alagado ? "ALAGADO" : "NORMAL";
                    cStatus.className = alagado ? "status-alagado" : "status-seco";

                    markers[l.id].setStyle({
                        color: alagado ? '#ff3333' : '#00ff77',
                        fillOpacity: alagado ? 0.6 : 0.1
                    });
                });
            }
        } catch (e) { document.getElementById('syncStatus').innerText = "ERRO DE REDE"; }
    }

    fetchData();
    setInterval(fetchData, 30000);
</script>
</body>
</html>
