<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>ALVA MONITOR - HEATMAP & SENSORES</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Courier New', monospace; background: #050505; color: #d0d0d0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 35vh; width: 100%; filter: grayscale(1) contrast(1.2) brightness(0.9); border-bottom: 2px solid #ff3333; }
        .sar-header { background: #111; padding: 10px 20px; display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px solid #333; color: #ff3333; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .panel { flex: 0.9; padding: 15px; background: #0a0a0a; border-right: 1px solid #222; display: flex; flex-direction: column; gap: 8px; }
        .sidebar { flex: 2.1; padding: 10px; background: #050505; overflow-y: auto; }
        .data-card { background: #111; padding: 10px; border: 1px solid #333; border-left: 4px solid #ff3333; }
        .sensor-label { font-size: 0.75em; color: #888; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .value-display { font-size: 1.8em; font-weight: bold; color: #fff; }
        table { width: 100%; font-size: 10px; border-collapse: collapse; }
        th { border-bottom: 2px solid #444; padding: 8px; text-align: left; color: #ff3333; position: sticky; top: 0; background: #050505; }
        td { padding: 8px; border-bottom: 1px solid #1a1a1a; }
        .status-alagado { color: #ff3333; font-weight: bold; background: rgba(255,0,0,0.1); animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="sar-header">
    <div>MONITORIZAÇÃO TÉCNICA RIO ALVA & POIARES</div>
    <div>SINC: <b id="syncStatus">---</b></div>
</div>

<div id="map"></div>

<div class="main-container">
    <div class="panel">
        <div class="data-card">
            <span class="sensor-label">COTA ATUAL (REF. MUCELA)</span>
            <div id="valH" class="value-display">---</div><small>Metros (Altitude)</small>
        </div>
        
        <div class="data-card">
            <span class="sensor-label">CAUDAL ESTIMADO</span>
            <div id="valFlow1" class="value-display">---</div><small>m³/s</small>
        </div>

        <div style="font-size: 9px; color: #555; margin-top: 10px;">
            <b>LEGENDA:</b><br>
            Círculos <span style="color:cyan">Azuis</span>: Sensores APA<br>
            Zonas <span style="color:red">Vermelhas</span>: Risco Crítico
        </div>
    </div>

    <div class="sidebar">
        <table>
            <thead>
                <tr>
                    <th>LOCALIDADE</th>
                    <th>Z TERRENO</th>
                    <th>Z ÁGUA</th>
                    <th>FOLGA</th>
                    <th>ESTADO</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', {zoomControl: false}).setView([40.2100, -8.1500], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    // Sensores
    const sensores = [
        {id: "S1: Mucela", pos: [40.2185, -8.1182]},
        {id: "S2: São Gião", pos: [40.3340, -7.8115]}
    ];

    sensores.forEach(s => {
        L.circle(s.pos, { radius: 600, color: '#00ffff', fillOpacity: 0.5, weight: 2 }).addTo(map)
         .bindTooltip(s.id, {permanent: true, direction: 'top'});
    });

    // Localidades (Incluindo Poiares e Arrifana)
    // diff_mucela representa a diferença aproximada de altitude do leito em relação ao sensor base
    const localidades = [
        {id: "V. N. POIARES", z_terreno: 140.0, pos: [40.2109, -8.2575], diff_mucela: -15.5},
        {id: "ARRIFANA", z_terreno: 115.0, pos: [40.2015, -8.1758], diff_mucela: -8.2},
        {id: "BARRIL DO ALVA", z_terreno: 159.3, pos: [40.2225, -7.9472], diff_mucela: 33.4},
        {id: "SECARIAS", z_terreno: 45.0, pos: [40.2274, -8.0841], diff_mucela: -80.8},
        {id: "CÔJA", z_terreno: 138.0, pos: [40.2672, -7.9892], diff_mucela: 12.2},
        {id: "AVÔ", z_terreno: 220.0, pos: [40.2938, -7.9055], diff_mucela: 94.2}
    ];

    let riskMarkers = {};
    localidades.forEach(l => {
        riskMarkers[l.id] = L.circle(l.pos, { radius: 800, weight: 0, fillOpacity: 0 }).addTo(map);
    });

    async function fetchData() {
        try {
            const proxy = 'https://api.allorigins.win/get?url=';
            const res = await fetch(proxy + encodeURIComponent('https://infoagua.apambiente.pt/pt/cheias/cheia-detalhe/1627758668'));
            const data = await res.json();
            
            const flowMatch = data.contents.match(/(\d+[.,]?\d*)\s*m3\/s/);
            const cotaMatch = data.contents.match(/(\d+[.,]\d+)\s*m(?!\d)/);
            
            if (cotaMatch) {
                let hLido = parseFloat(cotaMatch[1].replace(',', '.'));
                let q1 = flowMatch ? parseFloat(flowMatch[1].replace(',', '.')) : 0;
                
                // Ajuste de referência se o sensor reportar nível relativo em vez de absoluto
                let cotaSensor = hLido < 50 ? hLido + 125.85 : hLido;

                document.getElementById('valH').innerText = cotaSensor.toFixed(2) + "m";
                document.getElementById('valFlow1').innerText = q1.toFixed(1);
                document.getElementById('syncStatus').innerText = new Date().toLocaleTimeString();

                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';

                localidades.forEach(l => {
                    let cotaAguaLocal = cotaSensor + l.diff_mucela;
                    let folga = l.z_terreno - cotaAguaLocal;
                    let alagado = folga <= 0;

                    let opacity = 0;
                    let color = '#00ff77';
                    if (folga < 1.5) { opacity = 0.3; color = '#ffcc00'; } 
                    if (folga < 0.6) { opacity = 0.5; color = '#ff6600'; } 
                    if (alagado) { opacity = 0.8; color = '#ff0000'; }

                    riskMarkers[l.id].setStyle({
                        fillColor: color,
                        fillOpacity: opacity,
                        radius: alagado ? 1500 : 900
                    });

                    let row = tbody.insertRow();
                    row.insertCell(0).innerHTML = `<b>${l.id}</b>`;
                    row.insertCell(1).innerText = l.z_terreno.toFixed(1) + "m";
                    row.insertCell(2).innerText = cotaAguaLocal.toFixed(2) + "m";
                    row.insertCell(3).innerText = (folga > 0 ? folga.toFixed(2) : "0.00") + "m";
                    
                    let cStatus = row.insertCell(4);
                    cStatus.innerText = alagado ? "ALAGADO" : (folga < 1.5 ? "ALERTA" : "NORMAL");
                    if (alagado) cStatus.className = "status-alagado";
                });
            }
        } catch (e) { 
            document.getElementById('syncStatus').innerText = "ERRO CONEXÃO"; 
        }
    }

    fetchData();
    setInterval(fetchData, 60000);
</script>
</body>
</html>
