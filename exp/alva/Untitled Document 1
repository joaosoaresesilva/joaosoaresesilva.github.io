<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>RIO ALVA - MONITOR DE COTAS REAIS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Courier New', monospace; background: #050505; color: #d0d0d0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 25vh; width: 100%; filter: grayscale(1) contrast(1.2) brightness(0.8); border-bottom: 2px solid #ff3333; }
        .sar-header { background: #111; padding: 10px 20px; display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px solid #333; color: #ff3333; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .panel { flex: 0.9; padding: 15px; background: #0a0a0a; border-right: 1px solid #222; display: flex; flex-direction: column; gap: 8px; }
        .sidebar { flex: 2.1; padding: 10px; background: #050505; overflow-y: auto; }
        .data-card { background: #111; padding: 10px; border: 1px solid #333; border-left: 4px solid #ff3333; }
        .sensor-label { font-size: 0.75em; color: #888; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .value-display { font-size: 1.8em; font-weight: bold; color: #fff; letter-spacing: -1px; }
        .legenda { font-size: 9px; color: #666; line-height: 1.2; border-top: 1px solid #222; pt: 5px; }
        table { width: 100%; font-size: 10px; border-collapse: collapse; }
        th { border-bottom: 2px solid #444; padding: 8px; text-align: left; color: #ff3333; position: sticky; top: 0; background: #050505; }
        td { padding: 8px; border-bottom: 1px solid #1a1a1a; }
        .status-alagado { color: #ff3333; font-weight: bold; background: rgba(255,0,0,0.1); animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="sar-header">
    <div>SISTEMA DE COTAS RIO ALVA (REF: NÍVEL DO MAR)</div>
    <div>SINC: <b id="syncStatus">---</b></div>
</div>

<div id="map"></div>

<div class="main-container">
    <div class="panel">
        <div class="data-card">
            <span class="sensor-label">COTA ATUAL NO SENSOR (H)</span>
            <div id="valH" class="value-display">---</div><small>Metros (Altitude)</small>
        </div>
        
        <div class="data-card">
            <span class="sensor-label">CAUDAL (MUCELA)</span>
            <div id="valFlow1" class="value-display">---</div><small>m³/s</small>
        </div>

        <div class="legenda">
            <b>LEGENDA DE SEGURANÇA:</b><br>
            • <b>Cota:</b> Altitude real em relação ao nível médio do mar.<br>
            • <b>Alerta:</b> Ocorre quando a Cota da Água ultrapassa a Cota do Terreno (Z).<br>
            • <b>Referência:</b> Estio na Mucela ~125.80m.
        </div>
    </div>

    <div class="sidebar">
        <table>
            <thead>
                <tr>
                    <th>LOCALIDADE</th>
                    <th>COTA TERRENO (Z)</th>
                    <th>COTA ÁGUA EST.</th>
                    <th>FOLGA</th>
                    <th>ESTADO</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', {zoomControl: false}).setView([40.2300, -8.0200], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    // Z_TERRENO: A altitude real onde a inundação começa
    const localidades = [
        {id: "BARRIL DO ALVA (PASTOS)", z_terreno: 159.3, pos: [40.2225, -7.9472], diff_mucela: 33.4},
        {id: "SECARIAS (PRAIA)", z_terreno: 45.0, pos: [40.2274, -8.0841], diff_mucela: -80.8},
        {id: "CÔJA (PONTE ROMANA)", z_terreno: 138.0, pos: [40.2672, -7.9892], diff_mucela: 12.2},
        {id: "AVÔ (ILHA DO PICOTO)", z_terreno: 220.0, pos: [40.2938, -7.9055], diff_mucela: 94.2}
    ];

    async function fetchData() {
        try {
            const proxy = 'https://api.allorigins.win/get?url=';
            const res = await fetch(proxy + encodeURIComponent('https://infoagua.apambiente.pt/pt/cheias/cheia-detalhe/1627758668'));
            const data = await res.json();
            
            const flowMatch = data.contents.match(/(\d+[.,]?\d*)\s*m3\/s/);
            const cotaMatch = data.contents.match(/(\d+[.,]\d+)\s*m(?!\d)/);
            
            if (cotaMatch) {
                let hLido = parseFloat(cotaMatch[1].replace(',', '.'));
                let q1 = flowMatch ? parseFloat(flowMatch[1].replace(',', '.')) : 0;

                // Se o sensor enviar valor baixo (ex: 1.5m), convertemos para a cota 126m para manter o padrão
                let cotaSensor = hLido < 50 ? hLido + 125.85 : hLido;

                document.getElementById('valH').innerText = cotaSensor.toFixed(2) + "m";
                document.getElementById('valFlow1').innerText = q1.toFixed(1);
                document.getElementById('syncStatus').innerText = new Date().toLocaleTimeString();

                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';

                localidades.forEach(l => {
                    // Estimativa da cota da água local baseada na cota da Mucela
                    let cotaAguaLocal = cotaSensor + l.diff_mucela;
                    let folga = l.z_terreno - cotaAguaLocal;
                    let alagado = folga <= 0;

                    let row = tbody.insertRow();
                    row.insertCell(0).innerHTML = `<b>${l.id}</b>`;
                    row.insertCell(1).innerText = l.z_terreno.toFixed(1) + "m";
                    row.insertCell(2).innerText = cotaAguaLocal.toFixed(2) + "m";
                    row.insertCell(3).innerText = (folga > 0 ? folga.toFixed(2) : "0.00") + "m";
                    
                    let cStatus = row.insertCell(4);
                    cStatus.innerText = alagado ? "ALAGADO" : "NORMAL";
                    cStatus.className = alagado ? "status-alagado" : "";
                });
            }
        } catch (e) { document.getElementById('syncStatus').innerText = "ERRO SENSOR"; }
    }

    fetchData();
    setInterval(fetchData, 30000);
</script>
</body>
</html>
