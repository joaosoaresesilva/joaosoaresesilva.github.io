<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>LIS MONITOR - LEIRIA</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Courier New', monospace; background: #050505; color: #d0d0d0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 35vh; width: 100%; background: #000; filter: grayscale(1) contrast(1.2) brightness(0.6); border-bottom: 2px solid #444; }
        .sar-header { background: #111; padding: 10px 20px; display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px solid #333; color: #00d2ff; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .panel { flex: 0.8; padding: 15px; display: flex; flex-direction: column; gap: 12px; border-right: 1px solid #222; background: #0a0a0a; overflow-y: auto; }
        .sidebar { flex: 2.2; padding: 10px; background: #050505; overflow-y: auto; }
        .data-card { background: #111; padding: 10px; border: 1px solid #333; border-left: 4px solid #00ffaa; }
        .value-display { font-size: 1.8em; font-weight: bold; color: #fff; letter-spacing: -1px; }
        table { width: 100%; font-size: 10px; border-collapse: collapse; }
        th { border-bottom: 2px solid #444; padding: 10px; text-align: left; color: #00ffaa; position: sticky; top: 0; background: #050505; z-index: 10; }
        td { padding: 8px; border-bottom: 1px solid #222; color: #ffffff; }
        .status-alagado { color: #ff0000 !important; font-weight: bold; } 
        .status-provavel { color: #ffa500 !important; font-weight: bold; } 
        #btnLog { color: #00ffaa; border: 1px solid #00ffaa; background: transparent; padding: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: auto;}
    </style>
</head>
<body>

<div class="sar-header">
    <div>BACIA DO LIS: <b>SISTEMA DE ALERTA LOCAL</b></div>
    <div>SINC APA (LEIRIA): <b id="syncStatus">---</b></div>
    <div>MARÉ (NAZARÉ/VIEIRA): <b id="mareStatus">---</b></div>
</div>

<div id="map"></div>

<div class="main-container">
    <div class="panel">
        <div class="data-card">
            <h3>CAUDAL LIS (Q)</h3>
            <div id="valFlow" class="value-display">---</div><small>m³/s</small>
        </div>
        <div class="data-card">
            <h3>NÍVEL EM LEIRIA (hA)</h3>
            <div id="valCota" class="value-display">---</div><small>m (Estação APA)</small>
        </div>
        <button id="btnLog">EXPORTAR DATASET LIS (.TXT)</button>
    </div>

    <div class="sidebar">
        <table id="mainTable">
            <thead>
                <tr><th>PONTO CRÍTICO</th><th>COTA TERRENO</th><th>NÍVEL ESTIMADO</th><th>ESTADO</th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', {zoomControl: false}).setView([39.7435, -8.8070], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    const localidades = [
        {id: "PONTE DOS CANIÇOS", pos: [39.7540, -8.8210], cota: 22.5, reg: "A", hist: true, dist: 0.1},
        {id: "JARDIM LUÍS DE CAMÕES", pos: [39.7435, -8.8070], cota: 24.2, reg: "A", hist: true, dist: 0.5},
        {id: "ESTÁDIO MUNICIPAL", pos: [39.7480, -8.8120], cota: 23.5, reg: "A", hist: true, dist: 0.8},
        {id: "MONTE REAL (CAMPOS)", pos: [39.8333, -8.8667], cota: 10.0, reg: "B", hist: true, dist: 12.0},
        {id: "VIEIRA DE LEIRIA", pos: [39.8720, -8.9250], cota: 4.5, reg: "B", hist: false, dist: 20.0}
    ];

    let apaQ = 0, apaH = 0, hMareReal = 0.5;
    let markers = {};

    localidades.forEach(l => {
        markers[l.id] = L.circle(l.pos, {radius: 150, weight: 1, fillOpacity: 0.3, color: '#00ffaa'}).addTo(map);
    });

    async function syncData() {
        try {
            // Estação de exemplo: Ponte das Mestres ou Leiria
            const resAPA = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://snirh.apambiente.pt/snirh/_dadosbasicos/dados_estacao_tempo.php?idestacao=1627743505'));
            const dataAPA = await resAPA.json();
            const flowM = dataAPA.contents.match(/(\d+[.,]?\d*)\s*m3\/s/);
            const cotaM = dataAPA.contents.match(/(\d+[.,]\d+)\s*m(?!\d|\/|3)/);
            if (flowM) apaQ = parseFloat(flowM[1].replace(',', '.'));
            if (cotaM) apaH = parseFloat(cotaM[1].replace(',', '.'));
            
            document.getElementById('syncStatus').innerText = "SINC: OK";
        } catch (e) { document.getElementById('syncStatus').innerText = "ERRO SINC"; }
    }

    function update() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        document.getElementById('valFlow').innerText = apaQ.toFixed(1);
        document.getElementById('valCota').innerText = apaH.toFixed(2);

        localidades.forEach(l => {
            let hFinal;
            if (l.reg === "A") {
                hFinal = apaH + (apaQ / 1200); 
            } else {
                let pesoMare = Math.max(0, 1 - (l.dist / 22));
                hFinal = (apaH * 0.4) + (apaQ / 800) + (hMareReal * pesoMare);
            }

            let diff = hFinal - l.cota;
            let statusText = diff >= 0 ? "TRANSBORDO" : (diff >= -0.30 ? "ALERTA" : "NORMAL");
            let statusClass = diff >= 0 ? "status-alagado" : (diff >= -0.30 ? "status-provavel" : "");

            let row = tbody.insertRow();
            row.insertCell(0).innerText = l.id;
            row.insertCell(1).innerText = l.cota.toFixed(1) + "m";
            row.insertCell(2).innerText = hFinal.toFixed(2) + "m";
            let cellStatus = row.insertCell(3);
            cellStatus.innerText = statusText;
            cellStatus.className = statusClass;

            let markerColor = diff >= 0 ? "#ff0000" : (diff >= -0.30 ? "#ffa500" : "#00ffaa");
            markers[l.id].setStyle({color: markerColor, fillColor: markerColor});
        });
    }

    syncData();
    setInterval(syncData, 60000);
    setInterval(update, 2000);
</script>
</body>
</html>
