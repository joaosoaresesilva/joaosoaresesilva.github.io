<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Simulador Hidr치ulico: Coimbra - Alfarelos - Montemor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #121212; color: white; }
        #map { height: 70vh; width: 100%; }
        .panel { padding: 15px; background: #1e1e1e; border-top: 4px solid #00d2ff; }
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .slider-box { background: #2d2d2d; padding: 12px; border-radius: 8px; border: 1px solid #444; }
        .stats-val { font-size: 1.4em; color: #00d2ff; font-weight: bold; }
        input[type=range] { width: 100%; accent-color: #00d2ff; }
        button { padding: 10px; font-weight: bold; cursor: pointer; border-radius: 4px; border: none; width: 100%; transition: 0.3s; }
        #btnStart { background: #00b894; color: white; }
        #btnReset { background: #d63031; color: white; margin-top: 5px; }
        #msg { text-align: center; margin-top: 10px; font-weight: bold; color: #fab1a0; font-size: 0.9em; }
        .label-style { background: rgba(0,0,0,0.85); border: 1px solid #00d2ff; color: white; font-size: 10px; padding: 3px; border-radius: 3px; white-space: nowrap; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
    <div class="controls-grid">
        <div class="slider-box">
            <label>Caudal (m췁/s): <b id="lblFlow">1200</b></label>
            <input type="range" id="inpFlow" min="500" max="15000" step="100" value="1200">
        </div>
        <div class="slider-box">
            <label>Estado do A칞ude/Diques:</label>
            <select id="selDam" style="width:100%; margin-top:10px; padding:5px; background: #333; color: white; border: 1px solid #555;">
                <option value="1">Operacional (Drenagem Ativa)</option>
                <option value="0.5">Sobrecarga (Diques no Limite)</option>
                <option value="0">Falha (Galgamento Generalizado)</option>
            </select>
        </div>
        <div class="slider-box">
            <button id="btnStart">INICIAR SIMULA칂츾O</button>
            <button id="btnReset">REINICIAR</button>
        </div>
        <div class="stats-box" style="text-align:center">
            <span>N칤vel M칠dio (Rio)</span><br><span id="valLevel" class="stats-val">15.00m</span>
        </div>
    </div>
    <div id="msg">Monitoriza칞칚o de cotas m칤nimas ativa.</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Vista ampla abrangendo Coimbra, Alfarelos e Montemor
    var map = L.map('map').setView([40.1750, -8.5500], 12);
    
    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data: OpenStreetMap, SRTM | Style: OpenTopoMap'
    }).addTo(map);

    // Zonas cr칤ticas de cota m칤nima (pontos onde a 치gua entra primeiro)
    var zonas = [
        // COIMBRA (Montante do A칞ude)
        { nome: "CBR: Sta Clara-a-Velha (15.1m)", centro: [40.2018, -8.4338], threshold: 15.1, max: 400, jusante: false },
        { nome: "CBR: Baixa/Esta칞칚o Nova (15.7m)", centro: [40.2095, -8.4315], threshold: 15.7, max: 500, jusante: false },
        
        // JUSANTE IMEDIATA (Protegida pelo A칞ude)
        { nome: "Jusante: Choupal (14.2m)", centro: [40.2185, -8.4480], threshold: 14.2, max: 1200, jusante: true },
        
        // ZONAS INTERM칄DIAS (Baixo Mondego)
        { nome: "Taveiro: Campos Baixos (12.5m)", centro: [40.1850, -8.5000], threshold: 12.5, max: 2000, jusante: true },
        { nome: "Arzila: Leito de Cheia (10.2m)", centro: [40.1650, -8.5500], threshold: 10.2, max: 1500, jusante: true },
        
        // ALFARELOS E MONTEMOR (Cotas cr칤ticas de jusante)
        { nome: "Alfarelos: N칩 Ferrovi치rio (8.2m)", centro: [40.1555, -8.6145], threshold: 8.2, max: 1300, jusante: true },
        { nome: "Formoselha: V치rzea (7.8m)", centro: [40.1685, -8.5980], threshold: 7.8, max: 1600, jusante: true },
        { nome: "Montemor: Campos do Bol칚o (6.5m)", centro: [40.1710, -8.6750], threshold: 6.5, max: 2500, jusante: true },
        { nome: "Montemor: Baixa da Vila (7.8m)", centro: [40.1745, -8.6830], threshold: 7.8, max: 500, jusante: true }
    ];

    zonas.forEach(function(z) {
        z.shape = L.circle(z.centro, {
            color: z.jusante ? '#1dd1a1' : '#0984e3', weight: 2, fillColor: "#74b9ff", fillOpacity: 0, radius: 0
        }).addTo(map);
        
        L.marker(z.centro, {opacity: 0}).addTo(map)
         .bindTooltip(z.nome, {permanent: true, direction: 'top', className: 'label-style'});
    });

    var nivelBase = 15.0;
    var timer = null;

    function atualizarMapa() {
        var statusDam = parseFloat(document.getElementById('selDam').value);
        var caudal = parseInt(document.getElementById('inpFlow').value);
        var afetados = [];

        zonas.forEach(function(z) {
            let nLocal = nivelBase;
            
            // L칩gica para Alfarelos e Montemor (Cotas muito baixas mas protegidas por diques)
            if (z.jusante) {
                // Se o a칞ude/diques funcionam, reduzimos a press칚o do n칤vel base
                // mas aumentamos a sensibilidade ao caudal bruto
                let protecaoEfetiva = 3.0 * statusDam; 
                nLocal = (nivelBase * (z.threshold / 15.0)) - protecaoEfetiva + (caudal / 4000);
            }

            if (nLocal > z.threshold) {
                var d = nLocal - z.threshold;
                z.shape.setRadius(Math.min(d * 600, z.max));
                z.shape.setStyle({ fillOpacity: Math.min(d * 0.4, 0.75), color: '#d63031' });
                afetados.push(z.nome.split(": ")[1].split(" (")[0]);
            } else {
                z.shape.setRadius(0);
                z.shape.setStyle({ color: z.jusante ? '#1dd1a1' : '#0984e3' });
            }
        });

        document.getElementById('msg').innerHTML = afetados.length > 0 ? 
            "游뚿 ALERTA DE ALAGAMENTO: " + afetados.join(" | ") : 
            "Cotas de seguran칞a respeitadas. Escoamento normal.";
    }

    document.getElementById('btnStart').onclick = function() {
        if (timer) {
            clearInterval(timer); timer = null;
            this.innerText = "RETOMAR SIMULA칂츾O";
        } else {
            this.innerText = "PAUSAR";
            timer = setInterval(function() {
                let caudal = parseInt(document.getElementById('inpFlow').value);
                // O n칤vel sobe se o caudal exceder a capacidade nominal do Mondego (~1400m3/s)
                nivelBase += (caudal - 1400) / 18000;
                document.getElementById('valLevel').innerText = Math.max(10, nivelBase).toFixed(2) + "m";
                atualizarMapa();
            }, 800);
        }
    };

    document.getElementById('inpFlow').oninput = function() { document.getElementById('lblFlow').innerText = this.value; };
    document.getElementById('btnReset').onclick = () => location.reload();
</script>
</body>
</html>
