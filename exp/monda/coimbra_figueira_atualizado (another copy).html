<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>GESTÃO ADAPTATIVA (MONDEGO)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Courier New', monospace; background: #050505; color: #d0d0d0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 35vh; width: 100%; background: #000; filter: grayscale(1) contrast(1.2) brightness(0.8); border-bottom: 2px solid #333; }
        .sar-header { background: rgba(0,0,0,0.9); padding: 5px 20px; display: flex; justify-content: space-between; font-size: 12px; border-bottom: 1px solid #444; color: #aaa; }
        .sar-header b { color: #00d2ff; }
        #timeDisplay { position: absolute; top: 50px; right: 20px; z-index: 1000; background: rgba(10, 10, 10, 0.9); padding: 10px; border: 1px solid #f1c40f; color: #f1c40f; text-align: right; }
        #simClock { font-size: 1.6em; font-weight: bold; display: block; }
        .main-container { display: flex; flex: 1; overflow: hidden; background: #0a0a0a; }
        .panel { flex: 1.6; padding: 15px; display: flex; flex-direction: column; gap: 8px; border-right: 1px solid #222; }
        .sidebar { flex: 1.4; padding: 15px; background: #050505; overflow-y: auto; }
        .slider-box { background: #111; padding: 8px; border: 1px solid #333; font-size: 0.8em; }
        .slider-box b { color: #f1c40f; }
        input[type=range] { width: 100%; accent-color: #f1c40f; }
        .automation-hub { background: #001a1a; border: 1px solid #00d2ff; padding: 12px; border-radius: 4px; }
        .hub-title { font-size: 10px; color: #ffffff; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px solid #004d4d; padding-bottom: 4px; }
        .mode-option { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 11px; padding: 6px; border-radius: 3px; transition: 0.3s; color: #ffffff; }
        .status-msg { font-size: 10px; color: #ffffff; margin-top: 5px; font-style: italic; opacity: 0.8; }
        .graph-container { background: #000; border: 1px solid #333; height: 100px; position: relative; display: flex; flex-direction: column; }
        .graph-area { flex: 1; position: relative; overflow: hidden; }
        .bar-c { position: absolute; bottom: 0; width: 2px; background: #f1c40f; }
        .bar-b { position: absolute; bottom: 0; width: 2px; background: #00ffff; }
        table { width: 100%; font-size: 11px; border-collapse: collapse; }
        th { border-bottom: 2px solid #444; padding: 8px; text-align: left; color: #00d2ff; }
        td { padding: 8px; border-bottom: 1px solid #222; }
        .at-risk { background: rgba(241, 196, 15, 0.1); color: #f1c40f; }
        .severe-risk { background: rgba(231, 76, 60, 0.15); color: #e74c3c; font-weight: bold; }
        .backwater-risk { background: rgba(0, 255, 255, 0.1); color: #00ffff; }
    </style>
</head>
<body>
<div class="sar-header">
    <div>SINC APA: <b id="lastSync">A CONECTAR...</b></div>
    <div>ALGORITMO: <b>GESTÃO DE DEGRAU DINÂMICO</b></div>
    <div>FONTE: <b>COIMBRA (AÇUDE)</b></div>
</div>
<div id="timeDisplay">
    <span id="simClock">--:--:--</span>
    <small id="elapsed">T+ 0 MIN</small>
</div>
<div id="map"></div>
<div class="main-container">
    <div class="panel">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <div class="slider-box">COTA MONTANTE (A): <b id="txtInitC">--</b>m<input type="range" id="inpInitC" min="10.0" max="23.5" step="0.01" value="15.42"></div>
            <div class="slider-box">CAUDAL (Q): <b id="txtFlow">--</b><input type="range" id="inpFlow" min="100" max="12000" step="1" value="2100"></div>
            <div class="slider-box">ABERTURA: <b id="txtGates">90</b>%<input type="range" id="inpGates" min="0" max="100" value="90"></div>
        </div>
        <div class="graph-container">
            <div class="graph-area" id="graphArea"></div>
        </div>
        <div class="automation-hub">
            <div class="hub-title">Controlo de Jusante (Zona B)</div>
            <label class="mode-option"><input type="radio" name="iaMode" value="manual" checked> <span>MODO MANUAL</span></label>
            <label class="mode-option"><input type="radio" name="iaMode" value="baixa"> <span>PRIORIDADE COIMBRA (A)</span></label>
            <label class="mode-option"><input type="radio" name="iaMode" value="total"> <span>EQUILÍBRIO DE DEGRAU (A/B)</span></label>
        </div>
        <button id="btnRun" style="background: transparent; color: #2ecc71; border-color: #2ecc71; padding: 12px; font-weight: bold; cursor: pointer;">INICIAR MONITORIZAÇÃO</button>
    </div>
    <div class="sidebar">
        <table id="mainTable">
            <thead><tr><th>LOCAL</th><th>REF</th><th>NÍVEL</th><th>ESTADO</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([40.1850, -8.6000], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);


    const sensores = [
    // --- ZONA URBANA COIMBRA (Região A) ---
    {id: "PTE STA CLARA", pos: [40.2085, -8.4285], cota: 23.0, reg: "A"},
    {id: "BAIXA (P. COMÉRCIO)", pos: [40.2092, -8.4298], cota: 21.0, reg: "A"},
    {id: "ESTADIO UNIV.", pos: [40.2045, -8.4345], cota: 20.8, reg: "A"},
    {id: "PORTELA", pos: [40.1945, -8.4055], cota: 20.2, reg: "A"},
    {id: "R. FERREIRA BORGES", pos: [40.20918, -8.42912], cota: 20.1, reg: "A"},
    {id: "R. ADELINO VEIGA", pos: [40.209079, -8.43199], cota: 20.0, reg: "A"},
    {id: "ETA DA BOAVISTA", pos: [40.1947, -8.4190], cota: 22.0, reg: "A"},
    {id: "PARQUE VERDE", pos: [40.2035, -8.4275], cota: 20.0, reg: "A"},
    {id: "MOSTEIRO STA CLARA-VELHA", pos: [40.2018, -8.4340], cota: 18.2, reg: "A"},
    {id: "MOSTEIRO STA CRUZ", pos: [40.2108, -8.4285], cota: 19.0, reg: "A"},
    {id: "R. DO GORGULHÃO", pos: [40.216701, -8.456282], cota: 19.0, reg: "A"},
    {id: "DOCAS DO MONDEGO", pos: [40.2078, -8.4312], cota: 18.6, reg: "A"},
    {id: "PARQUE DA CANÇÃO (MARGEM)", pos: [40.2040, -8.4309], cota: 18.2, reg: "A"},
    {id: "PARQUE DA CANÇÃO", pos: [40.2040, -8.4309], cota: 19.0, reg: "A"},
    {id: "AV. eMÍDIO NAVARRO (PORTAGEM)", pos: [40.2073, -8.4308], cota: 20.1, reg: "A"},
    {id: "PAVILHÃO CENTRO DE PORTUGAL", pos: [40.1989, -8.4332], cota: 18.5, reg: "A"},
    {id: "BAIXA (RIO / MARGEM)", pos: [40.2091, -8.4320], cota: 19.5, reg: "A"},
    {id: "PARQUE DR. MANUEL BRAGA", pos: [40.2055, -8.4290], cota: 20.1, reg: "A"},
    {id: "AAC - DESPORTOS NÁUTICOS", pos: [40.2000, -8.4287], cota: 18.3, reg: "A"},
    {id: "ESTAÇÃO COIMBRA-A", pos: [40.2111, -8.4337], cota: 20.2, reg: "A"},
    {id: "BAIXA (RUA DA SOFIA)", pos: [40.2115, -8.4312], cota: 21.0, reg: "A"},

    // --- BAIXO MONDEGO (Região B) ---
    {id: "CHOUPAL (ENTRADA)", pos: [40.2220, -8.4480], cota: 13.5, reg: "B"},
    {id: "TAVEIRO (COMERCIAL)", pos: [40.1910, -8.5060], cota: 14.2, reg: "B"},
    {id: "AMEAL (RESIDENCIAL)", pos: [40.1750, -8.5350], cota: 13.8, reg: "B"},
    {id: "CAMPOS DO BOLÃO", pos: [40.2150, -8.4650], cota: 13.0, reg: "B"},
    {id: "PAUL DE ARZILA (RESERVA)", pos: [40.1650, -8.5520], cota: 11.8, reg: "B"},
    {id: "PEREIRA DO CAMPO", pos: [40.1580, -8.5850], cota: 11.5, reg: "B"},
    {id: "FORMOSELHA", pos: [40.1550, -8.6250], cota: 10.8, reg: "B"},
    {id: "MONTEMOR (BASE CASTELO)", pos: [40.1745, -8.6820], cota: 8.5, reg: "B"},
    {id: "EREIRA (VILA)", pos: [40.1420, -8.6950], cota: 9.2, reg: "B"},
    {id: "FIGUEIRA (SALINAS)", pos: [40.1450, -8.8250], cota: 2.5, reg: "B"},
    {id: "VILA NOVA DE ANÇOS (CENTRO)", pos: [40.1105, -8.6415], cota: 18.5, reg: "B"},
    {id: "LINHA DO NORTE (ALFARELOS)", pos: [40.1185, -8.6380], cota: 10.8, reg: "B"}
];

    let visualMarkers = {};
    let hC = 15.42, hB = 10.55, tempo = 0, rodando = false;
    let simTime = new Date();

    sensores.forEach(s => {
        L.circleMarker(s.pos, { radius: 3, color: '#00d2ff', weight: 1, fillOpacity: 0.8 }).addTo(map);
        visualMarkers[s.id] = { circle: L.circle(s.pos, { radius: 0, weight: 1, opacity: 0.6, fillOpacity: 0.2 }).addTo(map) };
    });

    function updateUI() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        sensores.forEach(s => {
            let nivel = (s.reg === "A") ? hC : hB;
            let diff = nivel - s.cota;
            let visual = visualMarkers[s.id];
            let row = tbody.insertRow();
            
            if (diff > 0) {
                visual.circle.setRadius(20 + diff * 600);
                let cor = (diff > 0.8) ? '#e74c3c' : (s.reg === "B" ? '#00ffff' : '#f1c40f');
                visual.circle.setStyle({ color: cor, fillColor: cor, fillOpacity: 0.3 });
                row.className = (diff > 0.8) ? 'severe-risk' : (s.reg === "B" ? 'backwater-risk' : 'at-risk');
                row.insertCell(0).innerText = s.id; row.insertCell(1).innerText = s.cota + "m";
                row.insertCell(2).innerText = nivel.toFixed(2) + "m"; row.insertCell(3).innerText = "CHEIA";
            } else {
                visual.circle.setRadius(0);
                row.insertCell(0).innerText = s.id; row.insertCell(1).innerText = s.cota + "m";
                row.insertCell(2).innerText = nivel.toFixed(2) + "m"; row.insertCell(3).innerText = "OK";
            }
        });
        document.getElementById('simClock').innerText = simTime.toLocaleTimeString('pt-PT');
        document.getElementById('elapsed').innerText = `T+ ${tempo} MIN`;
    }

    function simular() {
        let flow = parseInt(document.getElementById('inpFlow').value);
        let gates = parseInt(document.getElementById('inpGates').value) / 100;
        
        // CÁLCULO DO DEGRAU (Correção Jusante Zona B)
        // A jusante, a cota é a de montante menos a perda no açude.
        // Se as comportas fecham (abertura 0), o degrau é máximo (~5m).
        // Se abrem totalmente, o degrau reduz devido ao caudal.
        let degrauBase = 5.2; 
        let efeitoCaudal = (flow / 4000); 
        let degrauReal = degrauBase * (1 - (gates * 0.7)) + efeitoCaudal;
        
        // Atualização das cotas
        let alvoHC = 14.0 + (flow / 2500) + ((1 - gates) * 5.0);
        hC += (alvoHC - hC) * 0.1;
        
        // A cota B (jusante) é hC menos o degrau
        let alvoHB = hC - degrauReal;
        hB += (alvoHB - hB) * 0.1;

        simTime.setMinutes(simTime.getMinutes() + 1);
        tempo++;
        updateUI();
        desenharGrafico();
    }

    function desenharGrafico() {
        const area = document.getElementById('graphArea');
        const x = (tempo * 2) % area.offsetWidth;
        if (x < 2) area.innerHTML = '';
        const bc = document.createElement('div'); bc.className = 'bar-c'; 
        bc.style.left = x + 'px'; bc.style.height = Math.max(0, (hC - 5) * 6) + 'px';
        area.appendChild(bc);
        const bb = document.createElement('div'); bb.className = 'bar-b'; 
        bb.style.left = x + 'px'; bb.style.height = Math.max(0, (hB - 5) * 6) + 'px';
        area.appendChild(bb);
    }

    document.getElementById('btnRun').onclick = function() { rodando = !rodando; this.innerText = rodando ? "PARAR" : "INICIAR"; };
    setInterval(() => { if(rodando) simular(); }, 1000);
    updateUI();
</script>
</body>
</html>
