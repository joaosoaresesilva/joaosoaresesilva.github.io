<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Simulador: Integridade de Diques Mondego</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #121212; color: white; }
        #map { height: 60vh; width: 100%; }
        .panel { padding: 15px; background: #1e1e1e; border-top: 4px solid #00d2ff; }
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .slider-box { background: #2d2d2d; padding: 10px; border-radius: 8px; border: 1px solid #444; text-align: center; }
        .stats-val { font-size: 1.3em; color: #00d2ff; font-weight: bold; display: block; }
        .danger { color: #ff7675 !important; }
        input[type=range] { width: 100%; accent-color: #00d2ff; }
        #integrity-bar { width: 100%; height: 10px; background: #444; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        #integrity-fill { width: 100%; height: 100%; background: #00b894; transition: 0.3s; }
        #msg { text-align: center; margin-top: 10px; font-weight: bold; color: #feca57; font-size: 0.85em; min-height: 3em; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
    <div class="controls-grid">
        <div class="slider-box">
            <label>Caudal: <b id="lblFlow">1500</b> mÂ³/s</label>
            <input type="range" id="inpFlow" min="500" max="4000" step="50" value="1500">
        </div>
        <div class="slider-box">
            <span>Integridade dos Diques</span>
            <div id="integrity-bar"><div id="integrity-fill"></div></div>
            <span id="valIntegrity" class="stats-val">100%</span>
        </div>
        <div class="slider-box">
            <span>NÃ­vel em Coimbra</span>
            <span id="valLevel" class="stats-val">19.00m</span>
        </div>
        <div class="slider-box">
            <button id="btnStart" style="padding:10px; background:#00d2ff; font-weight:bold; width:100%; cursor:pointer;">INICIAR</button>
            <button onclick="location.reload()" style="margin-top:5px; width:100%; cursor:pointer;">RESET</button>
        </div>
    </div>
    <div id="msg">Diques estÃ¡veis. Terras baixas protegidas.</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([40.1750, -8.5500], 11);
    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png').addTo(map);

    var zonas = [
        { nome: "Baixa de Coimbra", centro: [40.2095, -8.4315], threshold: 20.0, max: 700, jusante: false },
        { nome: "Alfarelos", centro: [40.1555, -8.6145], threshold: 21.0, max: 1500, jusante: true },
        { nome: "Ereira", centro: [40.1605, -8.7050], threshold: 21.5, max: 1800, jusante: true }
    ];

    zonas.forEach(z => {
        z.shape = L.circle(z.centro, { color: '#0984e3', weight: 2, fillOpacity: 0, radius: 0 }).addTo(map);
    });

    var integrity = 100;
    var tempoHoras = 0;
    var timer = null;

    function atualizarSimulacao() {
        var caudal = parseInt(document.getElementById('inpFlow').value);
        var nivelCBR = 19.0 + (caudal - 1500) * (1.0 / 200.0);
        
        // LÃ³gica de Desgaste do Dique
        if (caudal > 1700) {
            let desgaste = (caudal - 1700) / 500; // Desgaste por hora
            integrity -= desgaste;
        } else if (caudal < 1200 && integrity < 100) {
            integrity += 0.1; // Pequena "recuperaÃ§Ã£o" se o caudal baixar
        }
        
        integrity = Math.max(0, Math.min(100, integrity));

        // Atualizar UI
        document.getElementById('valLevel').innerText = nivelCBR.toFixed(2) + "m";
        document.getElementById('valIntegrity').innerText = Math.floor(integrity) + "%";
        document.getElementById('integrity-fill').style.width = integrity + "%";
        if (integrity < 30) document.getElementById('integrity-fill').style.background = "#d63031";

        zonas.forEach(z => {
            let alagado = false;
            if (!z.jusante && nivelCBR > z.threshold) alagado = true;
            if (z.jusante && integrity < 5) alagado = true; // Rotura total

            if (alagado) {
                z.shape.setRadius(z.max);
                z.shape.setStyle({ fillOpacity: 0.6, color: '#d63031' });
            } else {
                z.shape.setRadius(0);
            }
        });

        let msg = integrity < 5 ? "ðŸš¨ ROTURA DOS DIQUES! InundaÃ§Ã£o catastrÃ³fica a jusante." : 
                  (caudal > 2400 ? "âš ï¸ PRESSÃƒO CRÃTICA: Diques em risco de colapso!" : "âœ… Diques a suportar a descarga.");
        document.getElementById('msg').innerHTML = msg;
    }

    document.getElementById('btnStart').onclick = function() {
        if (timer) { clearInterval(timer); timer = null; }
        else {
            timer = setInterval(() => {
                tempoHoras++;
                atualizarSimulacao();
            }, 600);
        }
    };

    document.getElementById('inpFlow').oninput = function() { 
        document.getElementById('lblFlow').innerText = this.value; 
        atualizarSimulacao();
    };
</script>
</body>
</html>
