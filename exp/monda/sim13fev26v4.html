<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA DE GEST√ÉO ADAPTATIVA - MONDEGO</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Courier New', monospace; background: #050505; color: #d0d0d0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 35vh; width: 100%; background: #000; filter: grayscale(1) contrast(1.2) brightness(0.8); border-bottom: 2px solid #333; }
        
        .sar-header { background: rgba(0,0,0,0.9); padding: 5px 20px; display: flex; justify-content: space-between; font-size: 12px; border-bottom: 1px solid #444; color: #aaa; }
        .sar-header b { color: #00d2ff; }
        
        #timeDisplay { position: absolute; top: 50px; right: 20px; z-index: 1000; background: rgba(10, 10, 10, 0.9); padding: 10px; border: 1px solid #f1c40f; color: #f1c40f; text-align: right; }
        #simClock { font-size: 1.6em; font-weight: bold; display: block; }

        .main-container { display: flex; flex: 1; overflow: hidden; background: #0a0a0a; }
        .panel { flex: 1.6; padding: 15px; display: flex; flex-direction: column; gap: 8px; border-right: 1px solid #222; }
        .sidebar { flex: 1.4; padding: 15px; background: #050505; overflow-y: auto; display: flex; flex-direction: column; }

        .slider-box { background: #111; padding: 8px; border: 1px solid #333; font-size: 0.8em; }
        .slider-box b { color: #f1c40f; }
        input[type=range] { width: 100%; accent-color: #f1c40f; }

        .automation-hub { background: #001a1a; border: 1px solid #00d2ff; padding: 12px; border-radius: 4px; }
        .hub-title { font-size: 10px; color: #ffffff; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px solid #004d4d; padding-bottom: 4px; }
        .mode-option { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 11px; color: #ffffff; }

        .graph-container { background: #000; border: 1px solid #333; height: 80px; position: relative; margin: 5px 0; }
        .bar-c { position: absolute; bottom: 0; width: 2px; background: #f1c40f; }
        .bar-b { position: absolute; bottom: 0; width: 2px; background: #00ffff; }

        table { width: 100%; font-size: 10px; border-collapse: collapse; }
        th { border-bottom: 2px solid #444; padding: 5px; text-align: left; color: #00d2ff; }
        td { padding: 5px; border-bottom: 1px solid #222; }

        /* Estilos Log e Emerg√™ncia */
        .log-container { flex-grow: 1; margin-top: 10px; border: 1px solid #444; background: #000; height: 120px; overflow-y: auto; font-size: 10px; padding: 5px; }
        .log-entry { margin-bottom: 4px; border-left: 2px solid #333; padding-left: 5px; }
        .log-time { color: #f1c40f; margin-right: 5px; }
        .log-msg-warn { color: #00ffff; }
        .log-msg-crit { color: #e74c3c; font-weight: bold; }

        #emergencyOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(139, 0, 0, 0.9); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; }
        .emergency-box { border: 5px solid white; padding: 40px; background: #000; }
        .blink-red { animation: blinker 0.5s linear infinite; color: #ff0000; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        .severe-risk { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
        .at-risk { color: #f1c40f; }
    </style>
</head>
<body>

<div id="emergencyOverlay">
    <div class="emergency-box">
        <h1 class="blink-red">‚ö†Ô∏è TRANSBORDO CR√çTICO ‚ö†Ô∏è</h1>
        <p style="font-size: 1.5em;">COTA EM COIMBRA EXCEDEU OS 21.00m</p>
        <p id="emergencyStats"></p>
        <button onclick="resetEmergency()" style="background: white; color: black; padding: 15px 30px; border: none; font-weight: bold; cursor: pointer;">REINICIAR SISTEMA</button>
    </div>
</div>

<div class="sar-header">
    <div>SINC APA: <b id="lastSync">A CONECTAR...</b></div>
    <div>ALGORITMO: <b>GEST√ÉO ADAPTATIVA + REFLUXO</b></div>
    <div>STATUS: <b id="aiStatus" style="color:#2ecc71">NORMAL</b></div>
</div>

<div id="timeDisplay">
    <span id="simClock">--:--:--</span>
    <small id="elapsed">T+ 0 MIN</small>
</div>

<div id="map"></div>

<div class="main-container">
    <div class="panel">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <div class="slider-box">COTA APA (COIMBRA): <b id="txtInitC">--</b>m<input type="range" id="inpInitC" min="10.0" max="23.5" step="0.01" value="15.42"></div>
            <div class="slider-box">CAUDAL AGUIEIRA (m¬≥/s): <b id="txtFlow">--</b><input type="range" id="inpFlow" min="100" max="6000" step="1" value="800"></div>
            <div class="slider-box">A√áUDE (ABERTURA): <b id="txtGates">90</b>%<input type="range" id="inpGates" min="0" max="100" value="90"></div>
        </div>

        <div class="graph-container" id="graphArea"></div>

        <div class="automation-hub">
            <div class="hub-title">Centro de Automa√ß√£o</div>
            <label class="mode-option"><input type="radio" name="iaMode" value="manual" checked> MODO MANUAL</label>
            <label class="mode-option"><input type="radio" name="iaMode" value="baixa"> PILOTO: PRIORIDADE BAIXA COIMBRA</label>
            <label class="mode-option"><input type="radio" name="iaMode" value="total"> PILOTO: EQUIL√çBRIO DE BACIA (ANTI-REFLUXO)</label>
            <div id="aiMsg" style="font-size: 10px; color: #00d2ff; margin-top: 5px;">Aguardando ativa√ß√£o...</div>
        </div>
        
        <button id="btnRun" style="background: transparent; color: #2ecc71; border: 2px solid #2ecc71; padding: 12px; font-weight: bold; cursor: pointer; font-family: inherit;">INICIAR MONITORIZA√á√ÉO</button>
    </div>

    <div class="sidebar">
        <table id="mainTable">
            <thead><tr><th>LOCAL</th><th>COTA</th><th>N√çVEL</th><th>ESTADO</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="log-container" id="decisionLog">
            <div style="color: #666; text-align: center; margin-top: 50px;">LOG DE DECIS√ïES VAZIO</div>
        </div>
        <button id="btnExport" style="margin-top: 5px; background: #222; color: #00d2ff; border: 1px solid #444; padding: 5px; font-size: 9px; cursor: pointer;">üíæ EXPORTAR LOG (.TXT)</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([40.2050, -8.4300], 12); 
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    const sensores = [
        {id: "PARQUE DR. MANUEL BRAGA", pos: [40.2055, -8.4290], cota: 20.1, reg: "A"},
        {id: "BAIXA (RIO / MARGEM)", pos: [40.2091, -8.4320], cota: 19.5, reg: "A"},
        {id: "MOSTEIRO STA CLARA-VELHA", pos: [40.2018, -8.4340], cota: 18.2, reg: "A"},
        {id: "ADUANEIRA (BACIA SUL)", pos: [40.1939, -8.5388], cota: 13.2, reg: "B"},
        {id: "MONTEMOR (BASE CASTELO)", pos: [40.1745, -8.6820], cota: 8.5, reg: "B"},
        {id: "CHOUPAL (ENTRADA)", pos: [40.2220, -8.4480], cota: 13.5, reg: "B"}
    ];

    let visualMarkers = {}, logData = [], lastLogEvent = "";
    let hC = 15.42, hB = 10.55, tempo = 0, rodando = false;
    let simTime = new Date();
    let bufferQ = new Array(40).fill(800); // Buffer de 40 min de delay

    sensores.forEach(s => {
        L.circleMarker(s.pos, { radius: 3, color: '#00d2ff', fillOpacity: 1 }).addTo(map);
        visualMarkers[s.id] = L.circle(s.pos, { radius: 0, color: '#f1c40f', weight: 1, fillOpacity: 0.2 }).addTo(map);
    });

    async function fetchDadosAPA() {
        try {
            const url = 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://infoagua.apambiente.pt/pt/cheias/cheia-detalhe/1627743374');
            const res = await fetch(url);
            const data = await res.json();
            const html = data.contents;
            const matchCota = html.match(/(\d+[.,]\d+)\s*m(?!\d|\/|3)/);
            if (matchCota) {
                hC = parseFloat(matchCota[1].replace(',', '.'));
                document.getElementById('inpInitC').value = hC;
                document.getElementById('txtInitC').innerText = hC.toFixed(2);
            }
            document.getElementById('lastSync').innerText = new Date().toLocaleTimeString();
        } catch (e) { console.log("Sincroniza√ß√£o falhou."); }
    }

    function addLog(msg, type) {
        if (lastLogEvent === msg) return;
        lastLogEvent = msg;
        const logBox = document.getElementById('decisionLog');
        if (logBox.innerHTML.includes("VAZIO")) logBox.innerHTML = "";
        
        const timestamp = simTime.toLocaleTimeString('pt-PT', {hour:'2-digit', minute:'2-digit'});
        logData.push({hora: timestamp, msg: msg, cC: hC.toFixed(2), cB: hB.toFixed(2)});
        
        const div = document.createElement('div');
        div.className = 'log-entry';
        let color = type === 'refluxo' ? 'log-msg-warn' : (type === 'crit' ? 'log-msg-crit' : '');
        div.innerHTML = `<span class="log-time">[${timestamp}]</span><span class="${color}">${msg}</span>`;
        logBox.prepend(div);
    }

    function updateUI() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        sensores.forEach(s => {
            let nivel = (s.reg === "A") ? hC : hB;
            let diff = nivel - s.cota;
            let row = tbody.insertRow();
            if (diff > 0) {
                row.className = diff > 0.8 ? 'severe-risk' : 'at-risk';
                visualMarkers[s.id].setRadius(20 + diff * 500);
            } else { visualMarkers[s.id].setRadius(0); }
            row.insertCell(0).innerText = s.id;
            row.insertCell(1).innerText = s.cota + "m";
            row.insertCell(2).innerText = nivel.toFixed(2) + "m";
            row.insertCell(3).innerText = diff > 0 ? "CHEIA" : "OK";
        });
        document.getElementById('simClock').innerText = simTime.toLocaleTimeString('pt-PT');
        document.getElementById('elapsed').innerText = `T+ ${tempo} MIN`;
    }

    function simular() {
        if (!rodando) return;
        if (hC > 21.0) { rodando = false; triggerEmergency(); return; }

        let qIn = parseInt(document.getElementById('inpFlow').value);
        bufferQ.push(qIn);
        let qChegada = bufferQ.shift();

        let gates = document.getElementById('inpGates');
        let mode = document.querySelector('input[name="iaMode"]:checked').value;

        if (mode === "total") {
            if (hC > 19.8 && hB < 12.0) {
                gates.value = Math.min(100, parseInt(gates.value) + 2);
                addLog("A√ß√£o: Abertura para al√≠vio de Coimbra.", "default");
            } else if (hB >= 12.0 && hC > 19.8) {
                gates.value = Math.max(0, parseInt(gates.value) - 1);
                addLog("VETO: Travamento por risco de refluxo em Montemor.", "refluxo");
            }
        } else if (mode === "baixa" && hC > 19.5) {
            gates.value = Math.min(100, parseInt(gates.value) + 2);
        }

        let abertura = parseInt(gates.value) / 100;
        document.getElementById('txtGates').innerText = gates.value;

        // Hidr√°ulica Adaptativa
        let alvoHC = 14.0 + (qChegada / 2200) + ((1 - abertura) * 7.5);
        hC += (alvoHC - hC) * 0.15;
        let alvoHB = 7.0 + (qChegada / 3500) + (abertura * 8.5);
        hB += (alvoHB - hB) * 0.1;

        simTime.setMinutes(simTime.getMinutes() + 1);
        tempo++;
        updateUI();
        desenharGrafico();
    }

    function desenharGrafico() {
        const area = document.getElementById('graphArea');
        const x = (tempo * 2) % area.offsetWidth;
        if (x < 2) area.innerHTML = '';
        const bc = document.createElement('div'); bc.className = 'bar-c'; 
        bc.style.left = x + 'px'; bc.style.height = (hC - 10) * 5 + 'px';
        area.appendChild(bc);
    }

    function triggerEmergency() {
        document.getElementById('emergencyOverlay').style.display = 'flex';
        document.getElementById('emergencyStats').innerText = `Cota: ${hC.toFixed(2)}m | Caudal: ${document.getElementById('inpFlow').value}m3/s`;
        addLog("COLAPSO DO SISTEMA: TRANSBORDO!", "crit");
    }

    function resetEmergency() {
        document.getElementById('emergencyOverlay').style.display = 'none';
        hC = 15.42; tempo = 0; rodando = false;
        document.getElementById('btnRun').innerText = "INICIAR MONITORIZA√á√ÉO";
        updateUI();
    }

    document.getElementById('btnRun').onclick = function() {
        rodando = !rodando;
        this.innerText = rodando ? "PARAR MONITORIZA√á√ÉO" : "INICIAR MONITORIZA√á√ÉO";
        this.style.borderColor = rodando ? "#e74c3c" : "#2ecc71";
    };

    document.getElementById('btnExport').onclick = function() {
        let txt = "RELAT√ìRIO DE CRISE MONDEGO\n\n";
        logData.forEach(l => txt += `[${l.hora}] ${l.msg} (C:${l.cC}m B:${l.cB}m)\n`);
        const blob = new Blob([txt], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "log_mondego.txt";
        a.click();
    };

    fetchDadosAPA();
    setInterval(simular, 1000);
</script>
</body>
</html>
