<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Simulador Cr√≠tico - Mondego Coimbra</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #121212; color: white; }
        #map { height: 60vh; width: 100%; }
        .panel { padding: 15px; background: #1e1e1e; border-top: 3px solid #333; }
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .slider-box { background: #2b2b2b; padding: 10px; border-radius: 8px; border: 1px solid #444; }
        .stats-display { text-align: center; font-size: 1.2em; }
        .critical-alert { color: #ff4757; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; }
        #btnStart { background: #009432; color: white; }
        #btnReset { background: #EA2027; color: white; }
        input[type=range] { width: 100%; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
    <div class="controls-grid">
        <div class="slider-box">
            <label>Caudal da Barragem: <b id="lblFlow">500</b> m¬≥/s</label>
            <input type="range" id="inpFlow" min="500" max="4000" step="100" value="500">
        </div>

        <div class="slider-box">
            <label>N√≠vel Inicial: <b id="lblStartLevel">15.0</b> m</label>
            <input type="range" id="inpStartLevel" min="14.0" max="21.0" step="0.1" value="15.0">
        </div>

        <div class="stats-display slider-box">
            <span>Tempo: <b id="valTime">0h</b></span><br>
            <span>N√≠vel: <b id="valLevel" style="color:#3498db">15.00m</b></span>
        </div>

        <div class="slider-box">
            <button id="btnStart">INICIAR SIMULA√á√ÉO</button>
            <button id="btnReset">REINICIAR</button>
        </div>
    </div>
    <div id="msg" style="text-align:center; margin-top:10px; font-size: 1.1em;">Monitoriza√ß√£o em curso...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([40.2150, -8.4450], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/hot/{z}/{x}/{y}.png').addTo(map);

    // Defini√ß√£o de Pontos Cr√≠ticos incluindo a Esta√ß√£o de √Ågua
    var zonas = [
        { nome: "Esta√ß√£o de Capta√ß√£o (ETA)", centro: [40.2220, -8.4490], cor: "#00d2d3", threshold: 17.5, max: 400, critico: true },
        { nome: "Parque Verde", centro: [40.2045, -8.4275], cor: "#54a0ff", threshold: 16.2, max: 450, critico: false },
        { nome: "Santa Clara", centro: [40.2035, -8.4320], cor: "#f39c12", threshold: 16.8, max: 550, critico: false },
        { nome: "Baixa de Coimbra", centro: [40.2110, -8.4310], cor: "#ee5253", threshold: 18.5, max: 600, critico: false },
        { nome: "Baixo Mondego", centro: [40.2200, -8.4750], cor: "#10ac84", threshold: 17.2, max: 2000, critico: false }
    ];

    zonas.forEach(z => {
        z.shape = L.circle(z.centro, { color: 'none', fillColor: z.cor, fillOpacity: 0, radius: 0 }).addTo(map);
        // Adicionar um marcador permanente para a Esta√ß√£o de √Ågua
        if(z.critico) {
            L.marker(z.centro).addTo(map).bindPopup("<b>" + z.nome + "</b><br>Ponto Cr√≠tico de Infraestrutura");
        }
    });

    var nivel = 15.0, tempo = 0, timer = null;

    const inpFlow = document.getElementById('inpFlow');
    const inpStartLevel = document.getElementById('inpStartLevel');
    const msgDiv = document.getElementById('msg');

    inpStartLevel.oninput = function() {
        if(!timer) {
            nivel = parseFloat(this.value);
            document.getElementById('lblStartLevel').innerText = nivel.toFixed(1);
            atualizarVisual();
        }
    };

    inpFlow.oninput = () => document.getElementById('lblFlow').innerText = inpFlow.value;

    function atualizarVisual() {
        document.getElementById('valLevel').innerText = nivel.toFixed(2) + "m";
        document.getElementById('valTime').innerText = tempo + "h";
        
        let alertas = [];
        let infraestuturaComprometida = false;

        zonas.forEach(z => {
            if (nivel > z.threshold) {
                let d = nivel - z.threshold;
                z.shape.setRadius(Math.min(d * 250, z.max));
                z.shape.setStyle({ fillOpacity: Math.min(d * 0.3, 0.7) });
                alertas.push(z.nome);
                if(z.critico) infraestuturaComprometida = true;
            } else {
                z.shape.setRadius(0);
            }
        });

        if (infraestuturaComprometida) {
            msgDiv.innerHTML = "<span class='critical-alert'>üö® EMERG√äNCIA: Esta√ß√£o de √Ågua em perigo! Risco de corte de abastecimento!</span>";
        } else if (alertas.length > 0) {
            msgDiv.innerHTML = "‚ö†Ô∏è √Åreas afetadas: " + alertas.join(", ");
            msgDiv.style.color = "#f1c40f";
        } else {
            msgDiv.innerText = "N√≠vel do rio sob controlo.";
            msgDiv.style.color = "#2ecc71";
        }
    }

    document.getElementById('btnStart').onclick = function() {
        if (timer) {
            clearInterval(timer); timer = null;
            this.innerText = "RESUMIR";
        } else {
            this.innerText = "PAUSAR";
            inpStartLevel.disabled = true;
            timer = setInterval(() => {
                tempo++;
                nivel += (parseInt(inpFlow.value) - 1100) / 5000;
                if (nivel < 14) nivel = 14;
                atualizarVisual();
            }, 800);
        }
    };

    document.getElementById('btnReset').onclick = () => location.reload();
    atualizarVisual();
</script>
</body>
</html>
