<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Gest√£o de Cheias - Baixo Mondego</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: #0f172a; color: #f8fafc; }
        #map { height: 55vh; width: 100%; border-bottom: 3px solid #1e293b; }
        .dashboard { padding: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; background: #1e293b; }
        .card { background: #334155; padding: 15px; border-radius: 10px; border: 1px solid #475569; position: relative; }
        .label { font-size: 0.8em; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        .value { font-size: 1.6em; font-weight: bold; color: #38bdf8; display: block; margin-top: 5px; }
        .integrity-bar { width: 100%; height: 8px; background: #0f172a; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        #integrity-fill { width: 100%; height: 100%; background: #22c55e; transition: 0.4s; }
        .btn-group { grid-column: span 4; display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        #btnStart { background: #38bdf8; color: #0f172a; }
        #btnReset { background: #ef4444; color: white; }
        .setup-msg { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(15, 23, 42, 0.9); padding: 10px 20px; border-radius: 20px; border: 1px solid #38bdf8; pointer-events: none; }
    </style>
</head>
<body>

<div id="setupMsg" class="setup-msg">üìç Clica no mapa para adicionar pontos (ETA, Parque, etc.) antes de iniciar.</div>
<div id="map"></div>

<div class="dashboard">
    <div class="card">
        <span class="label">Caudal do Rio (m¬≥/s)</span>
        <input type="range" id="inpFlow" min="500" max="5000" step="100" value="1500" style="width:100%">
        <span id="valFlow" class="value">1500</span>
    </div>

    <div class="card">
        <span class="label">Tempo e N√≠vel (CBR)</span>
        <span id="valTime" class="value">00d 00h</span>
        <span id="valLevel" class="value" style="font-size: 1.1em; color: #fbbf24;">19.00m</span>
    </div>

    <div class="card">
        <span class="label">Integridade dos Diques</span>
        <span id="valIntegrity" class="value">100%</span>
        <div class="integrity-bar"><div id="integrity-fill"></div></div>
    </div>

    <div class="card">
        <span class="label">Caudal no Canal Principal</span>
        <span id="valChannelFlow" class="value">1500 m¬≥/s</span>
        <small id="flowWarning" style="color:#94a3b8">Capacidade nominal: 2200m¬≥/s</small>
    </div>

    <div class="btn-group">
        <button id="btnStart">INICIAR SIMULA√á√ÉO</button>
        <button id="btnReset" onclick="location.reload()">RESET / CONFIGURAR NOVO</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([40.1850, -8.5500], 11);
    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png').addTo(map);

    var monitorPoints = [];
    var isRunning = false;
    var timer = null;
    var integrity = 100;
    var totalHours = 0;

    // Adi√ß√£o de pontos por clique
    map.on('click', function(e) {
        if (isRunning) return;
        let nome = prompt("Nome do Ponto Cr√≠tico (ex: ETA Boavista, Parque Verde):", "Novo Ponto");
        if (nome) {
            let cota = parseFloat(prompt("Cota de Inunda√ß√£o (m) [Sugerido: 19-21]:", "20.0"));
            let p = {
                latlng: e.latlng,
                nome: nome,
                threshold: cota,
                circle: L.circle(e.latlng, { color: '#38bdf8', weight: 2, fillOpacity: 0, radius: 0 }).addTo(map)
            };
            L.marker(e.latlng, {opacity: 0.8}).addTo(map).bindTooltip(nome + " (" + cota + "m)", {permanent: true});
            monitorPoints.push(p);
        }
    });

    function updatePhysics() {
        let caudalRio = parseInt(document.getElementById('inpFlow').value);
        let capCanal = 2200; // Limite de projeto antes do transbordo/press√£o extrema
        
        // 1. N√≠vel em Coimbra (Baseado no texto do Professor: 1700m3s = 20m)
        let nivelCBR = 19.0 + (caudalRio - 1500) * (1.0 / 200.0);
        
        // 2. Caudal que o canal consegue "segurar" vs o que pressiona os diques
        let stress = Math.max(0, caudalRio - capCanal);
        if (caudalRio > 1700) {
            integrity -= (caudalRio - 1700) / 600; // Desgaste temporal
        }
        integrity = Math.max(0, integrity);

        // 3. Atualizar UI
        document.getElementById('valFlow').innerText = caudalRio;
        document.getElementById('valLevel').innerText = nivelCBR.toFixed(2) + "m a.n.m.";
        document.getElementById('valIntegrity').innerText = Math.floor(integrity) + "%";
        document.getElementById('integrity-fill').style.width = integrity + "%";
        document.getElementById('valTime').innerText = Math.floor(totalHours/24) + "d " + (totalHours%24) + "h";
        document.getElementById('valChannelFlow').innerText = Math.min(caudalRio, capCanal) + " m¬≥/s";

        // Cor da integridade
        let color = integrity > 50 ? "#22c55e" : (integrity > 20 ? "#fbbf24" : "#ef4444");
        document.getElementById('integrity-fill').style.background = color;

        // 4. L√≥gica de Inunda√ß√£o nos Pontos
        monitorPoints.forEach(p => {
            let distToCBR = map.distance(p.latlng, [40.2095, -8.4315]); // Dist√¢ncia a Coimbra
            let alagado = false;

            // Se for perto de Coimbra (Baixa/Parque), alaga por n√≠vel direto
            if (distToCBR < 3000) {
                if (nivelCBR > p.threshold) alagado = true;
            } 
            // Se for jusante, alaga se os diques falharem (integridade < 10%)
            else {
                if (integrity < 10) alagado = true;
            }

            if (alagado) {
                let r = (nivelCBR - p.threshold + 2) * 350;
                p.circle.setRadius(r);
                p.circle.setStyle({ fillOpacity: 0.5, color: '#ef4444', fillColor: '#f87171' });
            } else {
                p.circle.setRadius(0);
            }
        });

        totalHours++;
    }

    document.getElementById('btnStart').onclick = function() {
        if (!isRunning) {
            if (monitorPoints.length === 0) { alert("Adiciona pelo menos um ponto no mapa primeiro!"); return; }
            isRunning = true;
            this.innerText = "PAUSAR";
            this.style.background = "#fbbf24";
            document.getElementById('setupMsg').style.display = 'none';
            timer = setInterval(updatePhysics, 800);
        } else {
            isRunning = false;
            this.innerText = "RESUMIR";
            this.style.background = "#38bdf8";
            clearInterval(timer);
        }
    };

    document.getElementById('inpFlow').oninput = function() {
        document.getElementById('valFlow').innerText = this.value;
        if (!isRunning) updatePhysics(); // Permite ver preview do n√≠vel
    };
</script>
</body>
</html>
