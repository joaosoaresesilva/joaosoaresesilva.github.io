<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA MONDEGO - SAR DYNAMIC MONITOR</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Courier New', monospace; background: #050505; color: #d0d0d0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 45vh; width: 100%; background: #000; filter: grayscale(1) contrast(1.1) brightness(0.7); border-bottom: 2px solid #333; }
        .sar-header { background: rgba(0,0,0,0.9); padding: 8px 20px; display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px solid #444; color: #888; letter-spacing: 1px; }
        .sar-header b { color: #00d2ff; }
        #timeDisplay { position: absolute; top: 60px; right: 20px; z-index: 1000; background: rgba(10, 10, 10, 0.85); padding: 10px; border-left: 3px solid #f1c40f; color: #f1c40f; }
        #simClock { font-size: 1.4em; font-weight: bold; display: block; }
        .main-container { display: flex; flex: 1; overflow: hidden; background: #0a0a0a; }
        .panel { flex: 1.5; padding: 15px; display: flex; flex-direction: column; gap: 10px; border-right: 1px solid #222; }
        .sidebar { flex: 1.5; padding: 15px; background: #050505; overflow-y: auto; }
        .slider-box { background: #111; padding: 8px; border: 1px solid #222; font-size: 0.75em; }
        .slider-box b { color: #f1c40f; }
        input[type=range] { width: 100%; accent-color: #f1c40f; margin-top: 5px; }
        select { background: #000; color: #00d2ff; border: 1px solid #333; padding: 8px; width: 100%; font-family: inherit; font-size: 11px; }
        button { padding: 12px; border: 1px solid #444; font-weight: bold; cursor: pointer; font-family: inherit; transition: 0.3s; width: 100%; margin-top: 5px; }
        #btnRun { background: transparent; color: #2ecc71; border-color: #2ecc71; }
        #btnRun.active { background: #e74c3c; color: white; border-color: #e74c3c; }
        .graph-container { background: #000; border: 1px solid #222; margin-top: 5px; position: relative; flex-grow: 1; display: flex; flex-direction: column; height: 100px; }
        .graph-area { height: 80px; position: relative; overflow: hidden; width: 100%; }
        .bar-c { position: absolute; bottom: 0; width: 2px; background: #f1c40f; opacity: 0.7; }
        .bar-b { position: absolute; bottom: 0; width: 2px; background: #00d2ff; opacity: 0.7; }
        table { width: 100%; font-size: 10px; border-collapse: collapse; }
        th { border-bottom: 2px solid #333; padding: 6px; text-align: left; color: #00d2ff; text-transform: uppercase; }
        td { padding: 6px; border-bottom: 1px solid #1a1a1a; }
        .at-risk { color: #f1c40f; font-weight: bold; }
        .at-severe { color: #ff4d4d; font-weight: bold; background: rgba(255, 77, 77, 0.1); }
        .sensor-tag { font-size: 9px; font-weight: bold; color: #f1c40f; text-shadow: 1px 1px #000; }
    </style>
</head>
<body>

<div class="sar-header">
    <div>RADAR: <b>SENTINEL-1 MODIFIED</b></div>
    <div>SISTEMA: <b>BACIA DO MONDEGO v3.0</b></div>
    <div>VARREDURA: <b>DINÂMICA 25cm</b></div>
</div>

<div id="timeDisplay">
    <span id="simClock">--:--:--</span>
    <small id="elapsed">T+ 0 MIN</small>
</div>

<div id="map"></div>

<div class="main-container">
    <div class="panel">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <div class="slider-box">
                <label>COTA COIMBRA: <b id="txtInitC">15.42</b>m</label>
                <input type="range" id="inpInitC" min="12.0" max="19.0" step="0.01" value="15.42">
            </div>
            <div class="slider-box">
                <label>CAUDAL: <b id="txtFlow">2100</b> m³/s</label>
                <input type="range" id="inpFlow" min="500" max="10000" step="100" value="2100">
            </div>
        </div>
        
        <select id="selHist">
            <option value="default">-- SELECIONAR EVENTO HISTÓRICO --</option>
            <option value="h2019">TEMPESTADE ELSA (2019)</option>
            <option value="h2001">GRANDE CHEIA (2001)</option>
            <option value="h1948">HISTÓRICO (1948)</option>
        </select>
        
        <button id="btnRun">INICIAR MONITORIZAÇÃO SAR</button>

        <div class="graph-container">
            <div class="graph-area" id="graphArea"></div>
        </div>
    </div>

    <div class="sidebar">
        <table>
            <thead><tr><th>LOCAL</th><th>COTA CRIT.</th><th>NÍVEL</th><th>ESTADO</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([40.1900, -8.5000], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const sensores = [
        {id: "MOSTEIRO STA CLARA", pos: [40.2018, -8.4340], cota: 13.5, reg: "C"},
        {id: "ETA BOAVISTA", pos: [40.1895, -8.4190], cota: 15.1, reg: "C"}, 
        {id: "BAIXA (P. COMÉRCIO)", pos: [40.2092, -8.4298], cota: 14.2, reg: "C"},
        {id: "PORTELA", pos: [40.1945, -8.4055], cota: 20.2, reg: "C"},
        {id: "CAMPOS DO BOLÃO", pos: [40.2150, -8.4650], cota: 13.0, reg: "B"},
        {id: "ESTADIO UNIV.", pos: [40.2045, -8.4345], cota: 14.5, reg: "C"},
        {id: "PARQUE VERDE", pos: [40.2035, -8.4275], cota: 14.8, reg: "C"},
        {id: "PTE STA CLARA", pos: [40.2085, -8.4285], cota: 15.8, reg: "C"},
        {id: "CHOUPAL", pos: [40.2220, -8.4480], cota: 14.8, reg: "C"},
        {id: "TAVEIRO", pos: [40.1910, -8.5060], cota: 14.0, reg: "C"},
        {id: "AMEAL", pos: [40.1750, -8.5350], cota: 13.2, reg: "B"},
        {id: "ARZILA", pos: [40.1650, -8.5550], cota: 12.5, reg: "B"},
        {id: "PEREIRA", pos: [40.1585, -8.5910], cota: 11.0, reg: "B"},
        {id: "MONTEMOR (VILA)", pos: [40.1745, -8.6815], cota: 10.2, reg: "B"},
        {id: "EREIRA", pos: [40.1420, -8.6950], cota: 9.8, reg: "B"}
    ];

    let visualMarkers = {};
    let hC = 15.42, hB = 10.55, tempo = 0, rodando = false;
    let simTime = new Date();

    sensores.forEach(s => {
        L.circleMarker(s.pos, { radius: 1.5, color: '#00d2ff', opacity: 0.5 }).addTo(map);
        
        // Círculo com contorno LEVE (weight: 1.2)
        const circle = L.circle(s.pos, { 
            radius: 0, 
            color: '#888888', 
            weight: 1.2, 
            opacity: 0.6, 
            fillOpacity: 0.2 
        }).addTo(map);

        const label = L.marker(s.pos, { 
            icon: L.divIcon({ className: 'sensor-tag', html: `<span id="tag-${s.id.replace(/\s+/g, '')}" style="display:none">⚠ CRÍTICO</span>`, iconAnchor: [-10, 10] }) 
        }).addTo(map);
        visualMarkers[s.id] = { circle, label };
    });

    function updateUI() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        sensores.forEach(s => {
            let nivel = (s.reg === "C") ? hC : hB;
            let diff = nivel - s.cota;
            let visual = visualMarkers[s.id];
            let tagSpan = document.getElementById(`tag-${s.id.replace(/\s+/g, '')}`);
            let row = tbody.insertRow();
            
            if (diff > 0) {
                // REGRA DINÂMICA DE CORES
                let color = (diff > 1.0) ? '#ff4d4d' : '#f1c40f'; // Vermelho se > 1m, Amarelo se < 1m
                visual.circle.setStyle({ fillColor: color, color: '#888888' });
                visual.circle.setRadius(20 + diff * 550);
                
                row.className = (diff > 1.0) ? 'at-severe' : 'at-risk';
                if(tagSpan) {
                    tagSpan.style.display = 'block';
                    tagSpan.style.color = color;
                }
                
                row.insertCell(0).innerText = s.id;
                row.insertCell(1).innerText = s.cota + "m";
                row.insertCell(2).innerText = nivel.toFixed(2) + "m";
                row.insertCell(3).innerText = (diff > 1.0) ? "SEVERO" : "ALERTA";
            } else {
                visual.circle.setRadius(0);
                if(tagSpan) tagSpan.style.display = 'none';
                row.insertCell(0).innerText = s.id;
                row.insertCell(1).innerText = s.cota + "m";
                row.insertCell(2).innerText = nivel.toFixed(2) + "m";
                row.insertCell(3).innerText = "NOMINAL";
            }
        });
        document.getElementById('simClock').innerText = simTime.toLocaleTimeString('pt-PT');
        document.getElementById('elapsed').innerText = `T+ ${tempo} MIN`;
    }

    function simular() {
        const flow = parseInt(document.getElementById('inpFlow').value);
        hC += ( (14.5 + (flow / 1800)) - hC ) * 0.05;
        hB += ( (9.0 + (flow / 1300)) - hB ) * 0.02;
        simTime.setMinutes(simTime.getMinutes() + 1);
        tempo++;
        updateUI();
        desenharGrafico();
    }

    function desenharGrafico() {
        const graphArea = document.getElementById('graphArea');
        const x = (tempo * 2) % graphArea.offsetWidth;
        if (x < 2) graphArea.innerHTML = '';
        const bc = document.createElement('div'); bc.className = 'bar-c'; bc.style.left = x + 'px'; bc.style.height = (hC - 12) * 10 + 'px';
        graphArea.appendChild(bc);
    }

    document.getElementById('btnRun').onclick = function() {
        rodando = !rodando;
        this.innerText = rodando ? "INTERROMPER RADAR" : "INICIAR MONITORIZAÇÃO SAR";
        this.className = rodando ? "active" : "";
    };

    document.getElementById('inpInitC').oninput = function() { hC = parseFloat(this.value); document.getElementById('txtInitC').innerText = hC.toFixed(2); updateUI(); };
    document.getElementById('inpFlow').oninput = function() { document.getElementById('txtFlow').innerText = this.value; };

    setInterval(() => { if(rodando) simular(); }, 1000);
    updateUI();
</script>
</body>
</html>
