<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>MONDEGO MONITOR - DATASET INTEGRADO</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Courier New', monospace; background: #050505; color: #d0d0d0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 35vh; width: 100%; background: #000; filter: grayscale(1) contrast(1.2) brightness(0.6); border-bottom: 2px solid #444; }
        .sar-header { background: #111; padding: 10px 20px; display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px solid #333; color: #00d2ff; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .panel { flex: 0.8; padding: 15px; display: flex; flex-direction: column; gap: 8px; border-right: 1px solid #222; background: #0a0a0a; overflow-y: auto; }
        .sidebar { flex: 2.2; padding: 10px; background: #050505; overflow-y: auto; }
        .data-card { background: #111; padding: 8px; border: 1px solid #333; border-left: 4px solid #00d2ff; }
        .value-display { font-size: 1.5em; font-weight: bold; color: #fff; letter-spacing: -0.5px; }
        .balance-indicator { font-size: 0.85em; font-weight: bold; margin-top: 2px; }
        table { width: 100%; font-size: 10px; border-collapse: collapse; }
        th { border-bottom: 2px solid #444; padding: 10px; text-align: left; color: #00d2ff; position: sticky; top: 0; background: #050505; z-index: 10; }
        td { padding: 8px; border-bottom: 1px solid #222; color: #ffffff; }
        .status-alagado { color: #ff0000 !important; font-weight: bold; } 
        .status-provavel { color: #ffa500 !important; font-weight: bold; } 
        .historic-tag { color: #f1c40f; font-size: 9px; border: 1px solid #f1c40f; padding: 1px 3px; border-radius: 2px; margin-right: 5px; }
        #btnLog { color: #00d2ff; border: 1px solid #00d2ff; background: transparent; padding: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: auto; transition: 0.3s;}
        #btnLog:hover { background: #00d2ff; color: #000; }
    </style>
</head>
<body>

<div class="sar-header">
    <div>FONTE: <b>APA (SISTEMA DE CHEIAS) + TABUADEMARES</b></div>
    <div>SINC STATUS: <b id="syncStatus">---</b></div>
    <div>MARÉ FIGUEIRA (TERRA): <b id="mareStatus">---</b></div>
</div>

<div id="map"></div>

<div class="main-container">
    <div class="panel">
        <div class="data-card" style="border-left-color: #9b59b6;">
            <h3>VOLUME ARMAZENADO</h3>
            <div id="valVol" class="value-display">---</div><small>hm³</small>
        </div>

        <div class="data-card">
            <h3>COTA APA (hA)</h3>
            <div id="valCota" class="value-display">---</div><small>m (Nível no Açude)</small>
        </div>

        <div class="data-card" style="border-left-color: #f1c40f;">
            <h3>CAUDAL AFLUENTE (Qin)</h3>
            <div id="valFlowIn" class="value-display">---</div><small>m³/s (Chegada)</small>
        </div>

        <div class="data-card" id="cardFlow">
            <h3>CAUDAL EFLUENTE (Qout)</h3>
            <div id="valFlow" class="value-display">---</div><small>m³/s (Saída)</small>
        </div>

        <div class="data-card" id="cardBalance">
            <h3>BALANÇO HÍDRICO</h3>
            <div id="valBalance" class="value-display" style="font-size: 1.3em;">---</div>
            <div id="balanceDesc" class="balance-indicator">Sincronizando...</div>
        </div>

        <div class="data-card">
            <h3>MARÉ (COTA TERRA)</h3>
            <div id="valMare" class="value-display" style="color: #00d2ff;">---</div><small>m (Figueira)</small>
        </div>

        <button id="btnLog">GERAR DATASET PARA R (.TXT)</button>
    </div>

    <div class="sidebar">
        <table id="mainTable">
            <thead>
                <tr><th>LOCALIDADE / PONTO</th><th>SOLO (Z)</th><th>NÍVEL (h)</th><th>ESTADO</th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', {zoomControl: false}).setView([40.1800, -8.5500], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    const localidades = [
        {id: "ETA DA BOAVISTA", pos: [40.1947, -8.4190], cota: 22.0, reg: "A", hist: false, dist: 0.1},
        {id: "MOSTEIRO STA CLARA-VELHA", pos: [40.2018, -8.4340], cota: 18.0, reg: "A", hist: true, dist: 0.1},
        {id: "PARQUE DA CANÇÃO (MARGEM)", pos: [40.2032, -8.4315], cota: 18.2, reg: "A", hist: true, dist: 0.2},
        {id: "PARQUE DA CANÇÃO", pos: [40.2040, -8.4309], cota: 19.0, reg: "A", hist: true, dist: 0.2},
        {id: "AAC - DESPORTOS NÁUTICOS", pos: [40.2000, -8.4287], cota: 18.3, reg: "A", hist: true, dist: 0.3},
        {id: "URSINHO (PARQUE VERDE)", pos: [40.2015, -8.4282], cota: 18.5, reg: "A", hist: true, dist: 0.4},
        {id: "RUA DA FEITORIA (STA CLARA)", pos: [40.2010, -8.4365], cota: 18.5, reg: "A", hist: true, dist: 0.3},
        {id: "BAIXA DE COIMBRA (RIO)", pos: [40.2091, -8.4320], cota: 19.5, reg: "A", hist: true, dist: 0.1},
        {id: "BOTA ABAIXO", pos: [40.2110, -8.4345], cota: 19.8, reg: "A", hist: true, dist: 0.7},
        {id: "ROTUNDA DO ALMEQUE", pos: [40.2135, -8.4485], cota: 19.2, reg: "B", hist: false, dist: 1.0},
        {id: "COLÉGIO BISSAYA BARRETO", pos: [40.2205, -8.4610], cota: 18.5, reg: "B", hist: false, dist: 1.4},
        {id: "CENTRO HÍPICO", pos: [40.2225, -8.4650], cota: 17.8, reg: "B", hist: true, dist: 1.5},
        {id: "TAVEIRO (CENTRO)", pos: [40.1880, -8.5080], cota: 14.2, reg: "B", hist: false, dist: 8.5},
        {id: "PEREIRA (ESTAÇÃO)", pos: [40.1585, -8.5820], cota: 11.8, reg: "B", hist: false, dist: 18.5},
        {id: "EREIRA", pos: [40.1420, -8.6950], cota: 9.8, reg: "B", hist: false, dist: 29.0},
        {id: "FIGUEIRA (SALINAS)", pos: [40.1450, -8.8250], cota: 4.5, reg: "B", hist: false, dist: 41.0}
    ];

    let apaVol = 0, apaH = 0, apaQin = 0, apaQout = 0, hMareReal = 0;
    let logData = "TIMESTAMP,LOCAL,VOL,H_APA,Q_IN,Q_OUT,H_CALC,H_MARE,STATUS\n";
    let markers = {};

    localidades.forEach(l => {
        markers[l.id] = L.circle(l.pos, {radius: 250, weight: 1, fillOpacity: 0.2, color: '#ffffff'}).addTo(map);
    });

    async function syncData() {
        try {
            const resAPA = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://infoagua.apambiente.pt/pt/cheias/cheia-detalhe/1627743374'));
            const dataAPA = await resAPA.json();
            const html = dataAPA.contents;

            // Parsing seguindo a ordem da página: Volume, Cota, Qin, Qout
            const mVol = html.match(/Volume armazenado.*?([\d,.]+)\s*hm3/i);
            const mCota = html.match(/Cota.*?([\d,.]+)\s*m/i);
            const mQin = html.match(/Caudal Afluente.*?([\d,.]+)\s*m3\/s/i);
            const mQout = html.match(/Caudal Efluente.*?([\d,.]+)\s*m3\/s/i);

            if (mVol) apaVol = parseFloat(mVol[1].replace(',', '.'));
            if (mCota) apaH = parseFloat(mCota[1].replace(',', '.'));
            if (mQin) apaQin = parseFloat(mQin[1].replace(',', '.'));
            if (mQout) apaQout = parseFloat(mQout[1].replace(',', '.'));

            const resMare = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://tabuademares.com/pt/coimbra/figueira-da-foz'));
            const dataMare = await resMare.json();
            const mareM = dataMare.contents.match(/class="estado_actual_valor">([\d,.]+) m/) || dataMare.contents.match(/([\d,.]+) m<\/span>/);
            
            if (mareM) {
                hMareReal = parseFloat(mareM[1].replace(',', '.')) - 2.00; 
                document.getElementById('mareStatus').innerText = hMareReal.toFixed(2) + "m";
            }
            document.getElementById('syncStatus').innerText = "SINC: " + new Date().toLocaleTimeString();
        } catch (e) { document.getElementById('syncStatus').innerText = "ERRO NA LIGAÇÃO"; }
    }

    function update() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        // Atualização dos cards com precisão de 2 casas decimais
        document.getElementById('valVol').innerText = apaVol.toFixed(2);
        document.getElementById('valCota').innerText = apaH.toFixed(2);
        document.getElementById('valFlowIn').innerText = apaQin.toFixed(2);
        document.getElementById('valFlow').innerText = apaQout.toFixed(2);
        document.getElementById('valMare').innerText = hMareReal.toFixed(2);
        
        const diffQ = apaQin - apaQout;
        const balVal = document.getElementById('valBalance');
        const balDesc = document.getElementById('balanceDesc');
        const balCard = document.getElementById('cardBalance');

        if (diffQ > 0.1) {
            balVal.innerText = "+" + diffQ.toFixed(2) + " m³/s";
            balVal.style.color = "#00ff00";
            balDesc.innerText = "RETENÇÃO (Acúmulo)";
            balCard.style.borderLeftColor = "#00ff00";
        } else if (diffQ < -0.1) {
            balVal.innerText = diffQ.toFixed(2) + " m³/s";
            balVal.style.color = "#ff4444";
            balDesc.innerText = "DESCARGA (Esvaziamento)";
            balCard.style.borderLeftColor = "#ff4444";
        } else {
            balVal.innerText = "0.00 m³/s";
            balVal.style.color = "#fff";
            balDesc.innerText = "EQUILÍBRIO";
            balCard.style.borderLeftColor = "#444";
        }

        let saltoBase = 4.2;
        let diferencialReal = Math.max(0.4, saltoBase - (apaQout / 600)); 
        let hJusanteBase = (apaH - diferencialReal) + (hMareReal * 0.15);

        localidades.forEach(l => {
            let hFinal = (l.reg === "A") ? 
                apaH + (apaQout / 8000) : 
                hJusanteBase - (l.dist * 0.05) + (apaQout / 2800) + (hMareReal * 0.6 * Math.max(0, 1 - (l.dist / 45)));

            let diff = hFinal - l.cota;
            let statusText = diff >= 0 ? "CHEIA" : (diff >= -0.40 ? "ALERTA" : "SECO");
            let row = tbody.insertRow();
            row.insertCell(0).innerHTML = (l.hist ? '<span class="historic-tag">H</span>' : '') + l.id;
            row.insertCell(1).innerText = l.cota.toFixed(2) + "m";
            row.insertCell(2).innerText = hFinal.toFixed(2) + "m";
            let cellStatus = row.insertCell(3);
            cellStatus.innerText = (diff >= 0 ? "⚠️ " : "") + statusText;
            cellStatus.className = diff >= 0 ? "status-alagado" : (diff >= -0.40 ? "status-provavel" : "");

            let markerColor = diff >= 0 ? "#ff0000" : (diff >= -0.40 ? "#ffa500" : "#ffffff");
            markers[l.id].setRadius(200 + (Math.max(0, diff + 0.5) * 600));
            markers[l.id].setStyle({color: markerColor, fillColor: markerColor});
            
            logData += `${new Date().toISOString()},"${l.id}",${apaVol.toFixed(2)},${apaH.toFixed(2)},${apaQin.toFixed(2)},${apaQout.toFixed(2)},${hFinal.toFixed(2)},${hMareReal.toFixed(2)},${statusText}\n`;
        });
    }

    document.getElementById('btnLog').onclick = () => {
        const blob = new Blob([logData], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `DATASET_MONDEGO_PRECISAO_${new Date().getTime()}.txt`;
        a.click();
    };

    syncData();
    setInterval(syncData, 120000); 
    setInterval(update, 1000);
</script>
</body>
</html>
