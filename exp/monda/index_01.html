<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Simulador Cr칤tico Mondego - Coimbra</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #121212; color: white; overflow: hidden; }
        #map { height: 65vh; width: 100%; background: #222; }
        .panel { height: 35vh; padding: 15px; background: #1e1e1e; box-sizing: border-box; }
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .slider-box { background: #2b2b2b; padding: 10px; border-radius: 8px; border: 1px solid #444; }
        .stats-display { text-align: center; font-size: 1.1em; border: 2px solid #3498db; }
        .critical-alert { color: #ff4757; font-weight: bold; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        #btnStart { background: #27ae60; color: white; }
        #btnStart:hover { background: #2ecc71; }
        #btnReset { background: #c0392b; color: white; }
        input[type=range] { width: 100%; cursor: pointer; }
        #msg { text-align: center; margin-top: 10px; font-weight: bold; min-height: 1.2em; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
    <div class="controls-grid">
        <div class="slider-box">
            <label>Caudal (Aguieira): <b id="lblFlow">500</b> m췁/s</label>
            <input type="range" id="inpFlow" min="500" max="4000" step="100" value="500">
        </div>

        <div class="slider-box">
            <label>N칤vel Inicial: <b id="lblStartLevel">15.0</b> m</label>
            <input type="range" id="inpStartLevel" min="14.0" max="21.0" step="0.1" value="15.0">
        </div>

        <div class="stats-display slider-box">
            <span>Tempo: <b id="valTime">0h</b></span><br>
            <span>N칤vel: <b id="valLevel" style="color:#3498db">15.00m</b></span>
        </div>

        <div class="slider-box">
            <button id="btnStart">INICIAR SIMULA칂츾O</button>
            <button id="btnReset">REINICIAR TUDO</button>
        </div>
    </div>
    <div id="msg">Monitoriza칞칚o do Sistema Hidrogr치fico</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Inicializa칞칚o com servidor de tiles da ESRI (mais est치vel para carregar mapas)
    var map = L.map('map').setView([40.2100, -8.4400], 13);
    
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Coimbra Simulation'
    }).addTo(map);

    // Zonas de Inunda칞칚o
    var zonas = [
        { nome: "Esta칞칚o 츼gua (ETA)", centro: [40.2222, -8.4495], cor: "#00d2d3", threshold: 17.8, max: 400, critico: true },
        { nome: "Parque Verde", centro: [40.2045, -8.4275], cor: "#341f97", threshold: 16.2, max: 450, critico: false },
        { nome: "Santa Clara", centro: [40.2035, -8.4320], cor: "#f39c12", threshold: 16.8, max: 550, critico: false },
        { nome: "Baixa de Coimbra", centro: [40.2115, -8.4305], cor: "#ee5253", threshold: 18.8, max: 600, critico: false },
        { nome: "Baixo Mondego", centro: [40.2200, -8.4800], cor: "#10ac84", threshold: 17.4, max: 2500, critico: false }
    ];

    zonas.forEach(z => {
        z.shape = L.circle(z.centro, { color: 'none', fillColor: z.cor, fillOpacity: 0, radius: 0 }).addTo(map);
        if(z.critico) {
            L.marker(z.centro).addTo(map).bindPopup("<b>" + z.nome + "</b><br>Ponto Cr칤tico");
        }
    });

    var nivel = 15.0, tempo = 0, timer = null;

    const inpFlow = document.getElementById('inpFlow');
    const inpStartLevel = document.getElementById('inpStartLevel');
    const msgDiv = document.getElementById('msg');

    function atualizarVisual() {
        document.getElementById('valLevel').innerText = nivel.toFixed(2) + "m";
        document.getElementById('valTime').innerText = tempo + "h";
        let ativos = [];
        let etaEmPerigo = false;

        zonas.forEach(z => {
            if (nivel > z.threshold) {
                let d = nivel - z.threshold;
                z.shape.setRadius(Math.min(d * 300, z.max));
                z.shape.setStyle({ fillOpacity: Math.min(d * 0.35, 0.6) });
                ativos.push(z.nome);
                if(z.critico) etaEmPerigo = true;
            } else {
                z.shape.setRadius(0);
            }
        });

        if (etaEmPerigo) {
            msgDiv.innerHTML = "<span class='critical-alert'>游뚿 EMERG칅NCIA: ESTA칂츾O DE 츼GUA COMPROMETIDA!</span>";
        } else if (ativos.length > 0) {
            msgDiv.innerHTML = "丘멆잺 Inunda칞칚o em curso: " + ativos.join(", ");
            msgDiv.style.color = "#f1c40f";
        } else {
            msgDiv.innerText = "N칤vel do rio est치vel.";
            msgDiv.style.color = "#2ecc71";
        }
    }

    inpStartLevel.oninput = function() {
        if(!timer) {
            nivel = parseFloat(this.value);
            document.getElementById('lblStartLevel').innerText = nivel.toFixed(1);
            atualizarVisual();
        }
    };

    inpFlow.oninput = () => document.getElementById('lblFlow').innerText = inpFlow.value;

    document.getElementById('btnStart').onclick = function() {
        if (timer) {
            clearInterval(timer); timer = null;
            this.innerText = "RESUMIR SIMULA칂츾O";
            this.style.background = "#27ae60";
        } else {
            this.innerText = "PAUSAR";
            this.style.background = "#f39c12";
            inpStartLevel.disabled = true;
            timer = setInterval(() => {
                tempo++;
                // L칩gica de subida acumulada
                nivel += (parseInt(inpFlow.value) - 1050) / 4500;
                if (nivel < 14) nivel = 14;
                if (nivel > 24) nivel = 24;
                atualizarVisual();
            }, 800);
        }
    };

    document.getElementById('btnReset').onclick = () => location.reload();
    atualizarVisual();
</script>
</body>
</html>

