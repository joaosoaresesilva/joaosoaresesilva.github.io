<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Simulação Topográfica: Alagamento de Coimbra</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a2e; color: white; }
        #map { height: 70vh; width: 100%; background: #222; }
        .panel { padding: 15px; background: #16213e; border-top: 4px solid #48dbfb; box-shadow: 0 -5px 15px rgba(0,0,0,0.5); }
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .slider-box { background: #0f3460; padding: 12px; border-radius: 8px; border: 1px solid #1e3799; }
        .stats-val { font-size: 1.4em; color: #48dbfb; font-weight: bold; display: block; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #48dbfb; margin-top: 8px; }
        button { padding: 12px; font-weight: bold; cursor: pointer; border-radius: 4px; border: none; width: 100%; transition: 0.3s; text-transform: uppercase; }
        #btnStart { background: #1dd1a1; color: white; }
        #btnStart:hover { background: #10ac84; }
        #btnReset { background: #ee5253; color: white; margin-top: 5px; }
        #msg { text-align: center; margin-top: 10px; font-weight: bold; color: #feca57; min-height: 1.2em; }
        .label-style { background: rgba(0,0,0,0.7); border: 1px solid #48dbfb; color: white; font-weight: bold; font-size: 11px; padding: 3px 6px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
    <div class="controls-grid">
        <div class="slider-box">
            <label>Caudal do Rio: <b id="lblFlow">1000</b> m³/s</label>
            <input type="range" id="inpFlow" min="500" max="12000" step="100" value="1000">
        </div>
        <div class="slider-box">
            <label>Nível Inicial: <b id="lblStartLevel">15.0</b> m</label>
            <input type="range" id="inpStartLevel" min="14.0" max="25.0" step="0.1" value="15.0">
        </div>
        <div class="slider-box">
            <button id="btnStart">Iniciar Simulação</button>
            <button id="btnReset">Reiniciar Mapa</button>
        </div>
        <div class="slider-box" style="text-align:center">
            <span>Tempo Decorrido</span>
            <span id="valTime" class="stats-val">0h</span>
        </div>
        <div class="slider-box" style="text-align:center">
            <span>Elevação da Água</span>
            <span id="valLevel" class="stats-val">15.00m</span>
        </div>
    </div>
    <div id="msg">Sistema pronto. Analisando altimetria das margens do Mondego.</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Foco inicial: Coimbra e o Rio Mondego
    var map = L.map('map').setView([40.2050, -8.4350], 14);
    
    // Camada Topográfica para ver curvas de nível
    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data: &copy; OpenStreetMap contributors, SRTM | Style: &copy; OpenTopoMap'
    }).addTo(map);

    // Definição das zonas baseada em cotas reais (aproximadas para simulação)
    var zonas = [
        { nome: "Baixo Mondego / Choupal (14.2m)", centro: [40.2185, -8.4480], threshold: 14.2, max: 1200 },
        { nome: "Santa Clara-a-Velha (15.1m)", centro: [40.2018, -8.4338], threshold: 15.1, max: 350 },
        { nome: "Parque Verde - Docas (15.5m)", centro: [40.2025, -8.4258], threshold: 15.5, max: 400 },
        { nome: "Baixa / Estação Nova (15.8m)", centro: [40.2095, -8.4315], threshold: 15.8, max: 500 },
        { nome: "Parque do Choupalinho (15.8m)", centro: [40.2065, -8.4370], threshold: 15.8, max: 350 },
        { nome: "ETA Boavista (16.2m)", centro: [40.1880, -8.4180], threshold: 16.2, max: 450 },
        { nome: "Campos de Taveiro (14.5m)", centro: [40.1850, -8.4900], threshold: 14.5, max: 2500 }
    ];

    // Criar círculos e marcadores invisíveis para labels
    zonas.forEach(function(z) {
        z.shape = L.circle(z.centro, {
            color: '#2e86de', weight: 2, fillColor: "#48dbfb", fillOpacity: 0, radius: 0, interactive: false
        }).addTo(map);
        
        L.marker(z.centro, {opacity: 0}).addTo(map)
         .bindTooltip(z.nome, {permanent: true, direction: 'top', className: 'label-style'});
    });

    var nivelAtual = 15.0;
    var tempo = 0;
    var timer = null;

    const inpFlow = document.getElementById('inpFlow');
    const inpStartLevel = document.getElementById('inpStartLevel');
    const valLevel = document.getElementById('valLevel');
    const valTime = document.getElementById('valTime');
    const msgDiv = document.getElementById('msg');
    const btnStart = document.getElementById('btnStart');

    // Sincronizar sliders
    inpFlow.oninput = function() { document.getElementById('lblFlow').innerText = this.value; };
    inpStartLevel.oninput = function() { 
        if(!timer) {
            nivelAtual = parseFloat(this.value);
            document.getElementById('lblStartLevel').innerText = nivelAtual.toFixed(1);
            valLevel.innerText = nivelAtual.toFixed(2) + "m";
            atualizarMapa();
        }
    };

    function atualizarMapa() {
        var afetados = [];
        zonas.forEach(function(z) {
            if (nivelAtual > z.threshold) {
                var diff = nivelAtual - z.threshold;
                // Cálculo de expansão do raio: cresce com a diferença de cota
                var novoRaio = Math.min(diff * 500, z.max);
                z.shape.setRadius(novoRaio);
                z.shape.setStyle({ 
                    fillOpacity: Math.min(diff * 0.3, 0.7),
                    color: nivelAtual > 18 ? '#ee5253' : '#2e86de' // Muda cor se o nível for crítico
                });
                afetados.push(z.nome.split(" (")[0]);
            } else {
                z.shape.setRadius(0);
            }
        });

        if (afetados.length > 0) {
            msgDiv.innerHTML = "⚠️ ALERTA DE INUNDAÇÃO: " + afetados.join(", ");
        } else {
            msgDiv.innerText = "Nível do rio dentro da normalidade.";
        }
    }

    btnStart.onclick = function() {
        if (timer) {
            clearInterval(timer);
            timer = null;
            this.innerText = "Retomar";
            this.style.background = "#1dd1a1";
        } else {
            this.innerText = "Pausar";
            this.style.background = "#ff9f43";
            timer = setInterval(function() {
                tempo++;
                // Lógica simplificada: se o caudal for > 1200m3/s, o nível sobe. 
                // Abaixo disso, estabiliza ou desce.
                let delta = (parseInt(inpFlow.value) - 1200) / 10000;
                nivelAtual += delta;
                
                valLevel.innerText = Math.max(14, nivelAtual).toFixed(2) + "m";
                valTime.innerText = tempo + "h";
                atualizarMapa();
            }, 800);
        }
    };

    document.getElementById('btnReset').onclick = () => location.reload();
</script>
</body>
</html>
