<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>MONDEGO RIO</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; font-family:'Courier New', monospace; background:#050505; color:#d0d0d0; display:flex; flex-direction:column; height:100vh; overflow:hidden; }
#map { height:35vh; width:100%; background:#000; filter:grayscale(1) contrast(1.2) brightness(0.7); border-bottom:2px solid #0044ff; }
.sar-header { background:#111; padding:10px 20px; display:flex; justify-content:space-between; font-size:11px; border-bottom:1px solid #333; color:#00d2ff; }
.main-container { display:flex; flex:1; overflow:hidden; }
.panel { flex:0.8; padding:15px; display:flex; flex-direction:column; gap:12px; border-right:1px solid #222; background:#0a0a0a; overflow-y:auto; }
.sidebar { flex:2.2; padding:10px; background:#050505; overflow-y:auto; }
.data-card { background:#111; padding:10px; border:1px solid #333; border-left:4px solid #00d2ff; }
.value-display { font-size:1.8em; font-weight:bold; color:#fff; letter-spacing:-1px; }
table { width:100%; font-size:10px; border-collapse:collapse; }
th { border-bottom:2px solid #444; padding:10px; text-align:left; color:#00d2ff; position:sticky; top:0; background:#050505; z-index:10; }
td { padding:8px; border-bottom:1px solid #1a1a1a; color:#fff; }
.status-alagado { color:#ff3333 !important; font-weight:bold; background: rgba(255,0,0,0.1); }
.status-provavel { color:#ffa500 !important; font-weight:bold; }
.status-seco { color:#00ff77 !important; }
.historic-tag { color:#f1c40f; font-size:9px; border:1px solid #f1c40f; padding:1px 3px; border-radius:2px; margin-right:5px; }
#btnLog { color:#00d2ff; border:1px solid #00d2ff; background:transparent; padding:12px; cursor:pointer; font-weight:bold; width:100%; transition:0.3s; margin-top:auto;}
#btnLog:hover { background:#00d2ff; color:#000; }
.leaflet-control.legend { font-size:12px; }
</style>
</head>
<body>

<div class="sar-header">
    <div>FONTE: <b>APA (AÇUDE) + DGT (MARÉ)</b></div>
    <div>SINC STATUS: <b id="syncStatus">---</b></div>
    <div>MARÉ (FIG. FOZ): <b id="mareStatus">---</b></div>
</div>

<div id="map"></div>

<div class="main-container">
    <div class="panel">
        <div class="data-card">
            <h3>CAUDAL AFL(Q)</h3>
            <div id="valFlow" class="value-display">---</div><small>m³/s</small>
        </div>
        <div class="data-card">
            <h3>COTA AÇUDE (hA)</h3>
            <div id="valCota" class="value-display">---</div><small>m (Nível Real)</small>
        </div>
        <div class="data-card">
            <h3>MARÉ  (M)</h3>
            <div id="valMare" class="value-display" style="color:#00d2ff;">---</div><small>m (Nível Mar)</small>
        </div>
        <button id="btnLog">EXPORTAR DATASET (.CSV)</button>
    </div>
    <div class="sidebar">
        <table id="mainTable">
            <thead>
                <tr><th>ID PONTO / LOCALIDADE</th><th>SOLO (Z)</th><th>NÍVEL (h)</th><th>ESTADO</th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map', {zoomControl:false}).setView([40.15, -8.6], 11);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

const localidades = [
    {id:"AV. eMÍDIO NAVARRO", pos:[40.2073,-8.4308], cota:20.1, reg:"A", hist:true, dist:0.15},
    {id:"ETA DA BOAVISTA", pos:[40.1947,-8.4190], cota:22.0, reg:"A", hist:false, dist:0},
    {id:"DOCAS DO MONDEGO", pos:[40.2078,-8.4312], cota:18.6, reg:"A", hist:false, dist:0.1},
    {id:"PAVILHÃO CENTRO DE PORTUGAL", pos:[40.1989,-8.4332], cota:18.5, reg:"A", hist:true, dist:0.2},
    // ... podes adicionar o resto como antes
];

let apaQ = 0, apaH = 17.45, hMareReal = 0.8;
let logData = "TIMESTAMP,ID,Z_SOLO,H_RIO,STATUS,Q,M\n";
let markers = {};
let estadosAnteriores = {};

// Cria os círculos
localidades.forEach(l => {
    markers[l.id] = L.circle(l.pos, {radius:180, weight:2, color:'#555', fillColor:'#00ff77', fillOpacity:0.1}).addTo(map);
});

// Legenda
const legend = L.control({position:'bottomright'});
legend.onAdd = function(map){
    const div = L.DomUtil.create('div','info legend');
    div.style.background = '#111';
    div.style.padding = '8px';
    div.style.border = '1px solid #333';
    div.style.color = '#fff';
    div.innerHTML = `<h4>Status</h4>
        <i style="background:#ff3333;width:12px;height:12px;display:inline-block;margin-right:5px;"></i>ALAGADO<br>
        <i style="background:#ffa500;width:12px;height:12px;display:inline-block;margin-right:5px;"></i>PROVÁVEL<br>
        <i style="background:#00ff77;width:12px;height:12px;display:inline-block;margin-right:5px;"></i>SECO`;
    return div;
};
legend.addTo(map);

// Função de sincronização APA via proxy SNIRH
async function syncAPA(){
    try {
        const res = await fetch('http://localhost:3000/snirh/12G/01H');
        const data = await res.json();
        if(data.Q) apaQ = parseFloat(data.Q);
        if(data.H) apaH = parseFloat(data.H);
        document.getElementById('syncStatus').innerText = "LIVE: "+new Date().toLocaleTimeString();
        document.getElementById('syncStatus').style.color="#00ff77";
    } catch(e){
        console.error("Erro APA:",e);
        document.getElementById('syncStatus').innerText="ERRO SINC / ESTIMATIVA";
        document.getElementById('syncStatus').style.color="#ff3333";
    }
}

// Função de sincronização da Maré
async function syncMare(){
    try{
        const proxy = 'https://api.allorigins.win/get?url=';
        const urlIH = "https://www.hidrografico.pt/json/mare.grafico.json.php?id=82";
        const res = await fetch(proxy + encodeURIComponent(urlIH));
        const data = await res.json();
        if(data.contents){
            const mareData = JSON.parse(data.contents);
            if(mareData && mareData.dados && mareData.dados.length>0){
                const agora = new Date().getTime();
                let closest = mareData.dados[0];
                let minDiff = Math.abs(new Date(closest.data).getTime()-agora);
                mareData.dados.forEach(d=>{
                    let diff=Math.abs(new Date(d.data).getTime()-agora);
                    if(diff<minDiff){ minDiff=diff; closest=d; }
                });
                hMareReal = parseFloat(closest.valor);
            }
        }
    }catch(e){ console.log("Erro Maré, usando fallback"); }
}

// Função de atualização protegida
function update(){
    try{
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML='';
        let hJusanteBase = apaH-4.5;

        document.getElementById('valFlow').innerText = apaQ.toFixed(2);
        document.getElementById('valCota').innerText = apaH.toFixed(2);
        document.getElementById('valMare').innerText = hMareReal.toFixed(2);
        document.getElementById('mareStatus').innerText = hMareReal.toFixed(1)+'m';

        localidades.forEach(l=>{
            let hFinal = l.reg==='A' ? apaH+(apaQ/15000) : hJusanteBase-(l.dist*0.06)+(apaQ/4500)+(hMareReal*0.6*Math.max(0,1-l.dist/35));
            let diff = hFinal-l.cota;
            let status = diff>=0?"ALAGADO":(diff>=-0.7?"PROVÁVEL":"SECO");
            let sColor = diff>=0?"#ff3333":(diff>=-0.7?"#ffa500":"#00ff77");

            if(l.hist && estadosAnteriores[l.id]!==status){
                logData += `${new Date().toISOString()},"${l.id}",${l.cota},${hFinal.toFixed(2)},${status},${apaQ},${hMareReal}\n`;
                estadosAnteriores[l.id]=status;
            }

            let row = tbody.insertRow();
            row.insertCell(0).innerHTML = (l.hist?'<span class="historic-tag">H</span>':'')+l.id;
            row.insertCell(1).innerText = l.cota.toFixed(1)+'m';
            row.insertCell(2).innerText = hFinal.toFixed(2)+'m';
            let cStatus = row.insertCell(3);
            cStatus.innerText = status;
            cStatus.className = diff>=0?"status-alagado":(diff>=-0.7?"status-provavel":"status-seco");

            // Atualiza cor do círculo
            markers[l.id].setStyle({fillColor:sColor, fillOpacity: diff>=0?0.8:(diff>=-0.7?0.5:0.1)});
            // Adiciona popup
            markers[l.id].bindPopup(`<b>${l.id}</b><br>Solo: ${l.cota} m<br>Nível: ${hFinal.toFixed(2)} m<br>Estado: <span style="color:${sColor}">${status}</span><br>Distância jusante: ${l.dist} km`);
        });
    } catch(e){ console.error("Erro update():",e); }
}

// Botão export CSV
document.getElementById('btnLog').addEventListener('click',()=>{
    const blob = new Blob([logData],{type:'text/csv;charset=utf-8;'});
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download=`dataset_mondego_${new Date().getTime()}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
});

// Inicializa
syncAPA();
syncMare();
setInterval(syncAPA,300000); // 5 min
setInterval(syncMare,600000); // 10 min
setInterval(update,1000);
</script>
</body>
</html>

