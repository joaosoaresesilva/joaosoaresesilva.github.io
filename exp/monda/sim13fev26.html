<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Gestão de Cheias - Mondego</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #fff; color: #000; padding: 20px; }
        .dashboard { display: grid; grid-template-columns: 320px 1fr 250px; gap: 20px; }
        .controls, .history-panel { border: 2px solid #000; padding: 15px; background: #f9f9f9; }
        .control-group { margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        input[type="range"] { width: 100%; }
        
        /* Gráfico Principal */
        .chart-container { position: relative; height: 400px; border-left: 2px solid #000; border-bottom: 2px solid #000; margin-left: 40px; background: #f0f0f0; overflow: hidden; }
        .y-axis-label { position: absolute; transform: rotate(-90deg); left: -75px; top: 50%; font-weight: bold; font-size: 12px; }
        
        .zone-point { position: absolute; width: 12px; height: 12px; background: #fff; border: 2px solid #000; border-radius: 50%; transform: translate(-50%, 50%); transition: bottom 0.1s; z-index: 2; }
        .zone-tag { position: absolute; font-size: 9px; transform: rotate(-45deg); white-space: nowrap; top: 15px; }
        
        /* Gráfico de Histórico */
        .mini-chart { width: 100%; height: 150px; border: 1px solid #000; background: #eee; position: relative; margin-top: 10px; }
        .history-bar { position: absolute; bottom: 0; width: 2px; background: #00f; opacity: 0.6; }
        .history-bar-q { background: #666; opacity: 0.3; }

        .status-box { margin-top: 20px; padding: 10px; border: 2px solid #000; font-size: 11px; background: #fff; }
        button { background: #000; color: #fff; border: none; padding: 10px; cursor: pointer; width: 100%; font-family: 'Courier New'; font-weight: bold; margin-bottom: 5px; }
        .active-auto { background: #0056b3 !important; }
        .target-line { position: absolute; width: 100%; border-top: 2px dashed blue; z-index: 1; opacity: 0.4; }
    </style>
</head>
<body>
    <h2>MONITORIZAÇÃO EM TEMPO REAL: AGUIEIRA -> COIMBRA</h2>
    <div class="dashboard">
        <div class="controls">
            <div class="control-group">
                <label><b>SISTEMA AUTOMÁTICO</b></label>
                <button id="btn-auto" onclick="toggleAuto()">LIGAR CONTROLO AUTO</button>
                <small id="auto-status">MODO: MANUAL</small>
            </div>
            <div class="control-group">
                <label><b>CAUDAL NA AGUIEIRA</b></label><br>
                <input type="range" id="q-in" min="0" max="4000" value="760">
                <span id="val-q">760</span> m³/s
            </div>
            <div class="control-group">
                <label><b>MARÉ (FOZ)</b></label><br>
                <input type="range" id="m-in" min="-100" max="450" value="0">
                <span id="val-m">0.0</span> m
            </div>
            <div class="status-box" id="status">STATUS: AGUARDANDO DADOS...</div>
        </div>

        <div class="chart-area">
            <div class="chart-container" id="chart">
                <div class="y-axis-label">COTA ATUAL (m)</div>
                <div class="target-line" style="bottom: 47.5%;"> <small style="color:blue; margin-left:5px;">ALVO 19m</small></div>
                <svg id="svg-line" width="100%" height="100%" style="position:absolute; bottom:0; overflow:visible;">
                    <path id="path-line" d="" fill="none" stroke="black" stroke-width="2" />
                </svg>
                <div id="z-coimbra" class="zone-point" style="left: 0%;"><span class="zone-tag">Coimbra</span></div>
                <div id="z-montemor" class="zone-point" style="left: 55%;"><span class="zone-tag">Montemor</span></div>
                <div id="z-foz" class="zone-point" style="left: 100%;"><span class="zone-tag">Foz</span></div>
            </div>
            <p style="font-size: 10px; text-align: center;">PERFIL LONGITUDINAL DO MONDEGO (COORDENADAS REAIS)</p>
        </div>

        <div class="history-panel">
            <label><b>HISTÓRICO (Tempo)</b></label>
            <div class="mini-chart" id="hist-cota">
                <small style="position:absolute; top:2px; left:2px; font-size:9px;">COTA EM COIMBRA</small>
            </div>
            <div class="mini-chart" id="hist-caudal">
                <small style="position:absolute; top:2px; left:2px; font-size:9px;">CAUDAL NA BARRAGEM</small>
            </div>
            <div style="margin-top:15px; font-size: 10px; line-height: 1.4;">
                <b>DELAY DE PROPAGAÇÃO:</b><br>
                A água demora aprox. 40 ciclos para percorrer a distância entre a Barragem e a Cidade.
            </div>
        </div>
    </div>

    <script>
        let autoAtivo = false;
        let bufferCaudal = new Array(40).fill(760); // Buffer de atraso (40 unidades de tempo)
        let histCota = [];
        let histQ = [];
        const MAX_HIST = 120;

        const zones = [
            { id: 'z-coimbra', x: 0, k: 1.0, d: 0.05 },
            { id: 'z-montemor', x: 55, k: 1.4, d: 0.4 },
            { id: 'z-foz', x: 100, k: 1.0, d: 1.5 }
        ];

        function toggleAuto() {
            autoAtivo = !autoAtivo;
            document.getElementById('btn-auto').classList.toggle('active-auto');
            document.getElementById('btn-auto').innerText = autoAtivo ? "AUTO: ATIVO" : "LIGAR CONTROLO AUTO";
            document.getElementById('q-in').disabled = autoAtivo;
        }

        function update() {
            const Q_Saida = parseInt(document.getElementById('q-in').value);
            const M = parseInt(document.getElementById('m-in').value) / 100;
            
            // Atualiza memória de propagação
            bufferCaudal.push(Q_Saida);
            const Q_ChegadaCoimbra = bufferCaudal.shift(); // O que sai da frente é o que chega a Coimbra

            // Lógica Auto (PID simplificado)
            if (autoAtivo) {
                const alvo = 47.5; // Cota 19m
                const cotaAtual = (Q_ChegadaCoimbra / 40) * zones[0].k + (M * 20) * zones[0].d;
                let erro = alvo - cotaAtual;
                document.getElementById('q-in').value = parseInt(document.getElementById('q-in').value) + (erro > 0 ? 2 : -2);
            }

            document.getElementById('val-q').innerText = Q_Saida;
            document.getElementById('val-m').innerText = M.toFixed(2);

            // Atualiza Gráfico Principal
            let pathData = "";
            zones.forEach((z, i) => {
                // Simulação: zonas intermédias usam valores intermédios do buffer
                const idxBuffer = Math.floor((1 - (z.x / 100)) * (bufferCaudal.length - 1));
                const Q_Local = bufferCaudal[idxBuffer];
                
                let pressure = (Q_Local / 40) * z.k + (M * 20) * z.d;
                let visualY = Math.min(100, pressure);
                
                document.getElementById(z.id).style.bottom = visualY + "%";
                let px = (z.x / 100) * document.getElementById('chart').offsetWidth;
                let py = 400 - (visualY / 100 * 400);
                pathData += (i === 0 ? "M" : "L") + px + "," + py;

                if (i === 0) updateHistory(visualY, Q_Saida); // Regista Coimbra e a Saída da Barragem
            });
            document.getElementById('path-line').setAttribute("d", pathData);
        }

        function updateHistory(cota, caudal) {
            histCota.push(cota);
            histQ.push(caudal);
            if (histCota.length > MAX_HIST) { histCota.shift(); histQ.shift(); }

            drawMiniChart('hist-cota', histCota, '#00f');
            drawMiniChart('hist-caudal', histQ, '#666', 4000);
        }

        function drawMiniChart(id, data, color, maxVal = 100) {
            const container = document.getElementById(id);
            container.innerHTML = `<small style="position:absolute; top:2px; left:2px; font-size:9px;">${id.replace('hist-', '').toUpperCase()}</small>`;
            data.forEach((val, i) => {
                const bar = document.createElement('div');
                bar.className = 'history-bar';
                bar.style.left = (i * 2) + 'px';
                bar.style.height = (val / maxVal * 100) + '%';
                bar.style.backgroundColor = color;
                container.appendChild(bar);
            });
        }

        setInterval(update, 100); // Roda o tempo
    </script>
</body>
</html>
