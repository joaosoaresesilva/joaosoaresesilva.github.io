<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Simulador Mondego</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 70vh; width: 100%; background: #ccd; }
        .panel { 
            height: 30vh; 
            background: #1a1a1a; 
            color: white; 
            padding: 15px; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .row { display: flex; justify-content: space-around; align-items: center; margin-bottom: 10px; }
        .stats { font-size: 1.5em; color: #00bbff; font-weight: bold; }
        input[type=range] { width: 250px; }
        button { padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 5px; border: none; }
        #btnStart { background: #2ecc71; color: white; }
        #btnReset { background: #e74c3c; color: white; }
        #msg { text-align: center; font-weight: bold; color: #ffcc00; margin-top: 10px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
    <div class="row">
        <div>
            <label>Caudal: <span id="valFlow">500</span> m³/s</label><br>
            <input type="range" id="inpFlow" min="500" max="3000" step="100" value="500">
        </div>
        <div>
            <button id="btnStart">INICIAR</button>
            <button id="btnReset">RESET</button>
        </div>
        <div>
            Tempo: <span id="valTime" class="stats">0</span>h | 
            Nível: <span id="valLevel" class="stats">15.0</span>m
        </div>
    </div>
    <div id="msg">Sistema Pronto - Coimbra (Margens Direita e Esquerda)</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Inicialização do Mapa
    var map = L.map('map').setView([40.2065, -8.4300], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Configuração das Manchas (Zonas)
    var zonas = [
        { nome: "Parque Verde", lat: 40.2045, lng: -8.4275, cor: "#00f", threshold: 16.2, max: 400 },
        { nome: "Santa Clara", lat: 40.2035, lng: -8.4320, cor: "#f80", threshold: 16.8, max: 500 },
        { nome: "Baixa", lat: 40.2110, lng: -8.4310, cor: "#f00", threshold: 18.8, max: 600 }
    ];

    // Criar círculos no mapa
    zonas.forEach(function(z) {
        z.shape = L.circle([z.lat, z.lng], {
            color: 'none', fillColor: z.cor, fillOpacity: 0, radius: 0
        }).addTo(map);
    });

    // Variáveis de Controlo
    var nivel = 15.0;
    var tempo = 0;
    var timer = null;

    // Elementos
    var flowInp = document.getElementById('inpFlow');
    var flowVal = document.getElementById('valFlow');
    var timeVal = document.getElementById('valTime');
    var levelVal = document.getElementById('valLevel');
    var msgDiv = document.getElementById('msg');

    flowInp.oninput = function() { flowVal.innerText = this.value; };

    function atualizar() {
        levelVal.innerText = nivel.toFixed(2);
        timeVal.innerText = tempo;
        var perigo = [];

        zonas.forEach(function(z) {
            if (nivel > z.threshold) {
                var diff = nivel - z.threshold;
                z.shape.setRadius(Math.min(diff * 200, z.max));
                z.shape.setStyle({ fillOpacity: Math.min(diff * 0.2, 0.7) });
                perigo.push(z.nome);
            } else {
                z.shape.setRadius(0);
            }
        });

        msgDiv.innerText = perigo.length > 0 ? "Inundação: " + perigo.join(", ") : "Nível do Mondego Normal";
    }

    document.getElementById('btnStart').onclick = function() {
        if (timer) {
            clearInterval(timer);
            timer = null;
            this.innerText = "CONTINUAR";
        } else {
            this.innerText = "PAUSAR";
            timer = setInterval(function() {
                tempo++;
                var caudal = parseInt(flowInp.value);
                // Lógica: sobe acima de 1000m3/s, desce abaixo disso
                nivel += (caudal - 1000) / 4000;
                if (nivel < 14.5) nivel = 14.5;
                if (nivel > 22) nivel = 22;
                atualizar();
            }, 600);
        }
    };

    document.getElementById('btnReset').onclick = function() {
        location.reload(); // Forma mais segura de limpar tudo
    };

</script>
</body>
</html>
