<!DOCTYPE html>
<html>
<head>
    <title>MODELO HIDRODINÂMICO MONDEGO v2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; }
        .container { width: 950px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-top: 20px; }
        .controls { display: flex; justify-content: space-around; padding: 20px; background: #e9ecef; border-radius: 8px; margin-bottom: 20px; align-items: center; }
        .status { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; text-align: center; }
        .critical { color: #dc3545; }
        .info-panel { display: flex; justify-content: space-between; font-size: 0.9em; color: #666; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Gestão de Cheia: Influência de Montante e Maré</h2>
    
    <div class="info-panel">
        <span>Tempo de Propagação (Aguieira -> Coimbra): <b>~5 horas</b></span>
        <span>Referência: <b>Baixa de Coimbra (20.0m)</b></span>
    </div>

    <div class="controls">
        <div>
            <label>Comportas Açude (G): <b id="gVal">10</b>%</label><br>
            <input type="range" id="gateCtrl" min="0" max="100" value="10">
        </div>
        <div style="text-align: center;">
            <div id="mareTxt" style="font-weight: bold; color: #2e86de;">Maré: Estável</div>
            <small id="mareVal">Nível Jusante: 15.0m</small>
        </div>
        <div>
            <button id="stormBtn" style="padding: 10px 20px; cursor:pointer; background: #dc3545; color: white; border: none; border-radius: 4px;">Simular Pico da Aguieira (2200 m³/s)</button>
        </div>
    </div>

    <div class="status" id="statusTxt">Estado: Estável</div>
    <canvas id="hidrograma"></canvas>
</div>

<script>
    const ctx = document.getElementById('hidrograma').getContext('2d');
    
    // Variáveis do Modelo
    let tick = 0;
    let tempo = Array.from({length: 80}, (_, i) => i); 
    let qIn = new Array(80).fill(200);   
    let qOut = new Array(80).fill(200);  
    let hCoimbra = new Array(80).fill(16); 
    let hMare = new Array(80).fill(15); // Novo dado: Nível de Jusante
    
    let gateAperture = 0.1; 
    const tau = 15; // Atraso de transporte (Dead Time)
    const area = 6000; 

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: tempo,
            datasets: [
                { label: 'Caudal Aguieira (m³/s)', data: qIn, borderColor: '#ff9f43', fill: false, tension: 0.3 },
                { label: 'Caudal Açude (m³/s)', data: qOut, borderColor: '#2e86de', fill: false },
                { label: 'Nível Coimbra (m)', data: hCoimbra, borderColor: '#ee5253', yAxisID: 'y1', borderWidth: 3 },
                { label: 'Nível Maré (m)', data: hMare, borderColor: '#999', borderDash: [5, 5], yAxisID: 'y1' }
            ]
        },
        options: {
            responsive: true,
            animation: false,
            scales: {
                y: { title: { display: true, text: 'Caudal (m³/s)' }, min: 0, max: 3000 },
                y1: { 
                    position: 'right', 
                    title: { display: true, text: 'Cota (m)' }, 
                    min: 12, 
                    max: 25, // Aumentado para a linha vermelha não desaparecer
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });

    function simularPasso() {
        tick++;
        
        // 1. Deslocar dados
        qIn.shift(); qOut.shift(); hCoimbra.shift(); hMare.shift();

        // 2. Simular Ciclo de Maré (Senoidal)
        // Oscila entre 14m e 17m
        let nivelMareAtual = 15.5 + Math.sin(tick * 0.1) * 1.5;
        hMare.push(nivelMareAtual);
        document.getElementById('mareVal').innerText = "Nível Jusante: " + nivelMareAtual.toFixed(2) + "m";
        document.getElementById('mareTxt').innerText = (hMare[78] < nivelMareAtual) ? "Maré: Enchente" : "Maré: Vazante";

        // 3. Novo Caudal de Entrada (Aguieira)
        let novoQin = qIn[qIn.length-1];
        qIn.push(novoQin);

        // 4. Cálculo da Saída (Física Real: Bernoulli)
        let hC = hCoimbra[hCoimbra.length-1];
        // O caudal de saída depende da diferença de altura entre Coimbra e a Maré
        let deltaH = Math.max(0.1, hC - nivelMareAtual); 
        let calculoSaida = gateAperture * 2200 * Math.sqrt(deltaH / 2); // 2 é o fator de escala de carga
        qOut.push(calculoSaida);

        // 5. Balanço de Massa com Atraso (Tau)
        let qChegada = qIn[qIn.length - tau] || qIn[0];
        let dhdt = (qChegada - calculoSaida) / area;
        let novoH = hC + dhdt;
        
        // Limite físico do leito do rio
        if (novoH < 14.2) novoH = 14.2;
        hCoimbra.push(novoH);

        // 6. Alertas e UI
        if(novoH > 20) {
            document.getElementById('statusTxt').innerHTML = "!!! ALERTA DE CHEIA NA BAIXA !!!";
            document.getElementById('statusTxt').className = "status critical";
        } else if (novoH > 19.2) {
            document.getElementById('statusTxt').innerHTML = "Estado: Atenção (Cota Crítica)";
            document.getElementById('statusTxt').className = "status";
            document.getElementById('statusTxt').style.color = "#f39c12";
        } else {
            document.getElementById('statusTxt').innerHTML = "Estado: Seguro";
            document.getElementById('statusTxt').className = "status";
            document.getElementById('statusTxt').style.color = "#27ae60";
        }

        chart.update('none');
    }

    // Controles
    document.getElementById('gateCtrl').oninput = function() {
        gateAperture = this.value / 100;
        document.getElementById('gVal').innerText = this.value;
    };

    document.getElementById('stormBtn').onclick = function() {
        // Simular descarga de emergência na Aguieira
        let pico = 2200;
        // Aplica o pico gradualmente para ser mais realista
        for(let j=0; j<30; j++) {
            setTimeout(() => { qIn[qIn.length-1] = pico; }, j * 100);
        }
    };

    setInterval(simularPasso, 200); // Mais rápido para melhor feedback visual
</script>
</body>
</html>
