<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA MONDEGO: Filtro de Sinais Hidráulicos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b1015; color: #c9d1d9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .dashboard { width: 1100px; background: #161b22; padding: 25px; border-radius: 12px; border: 1px solid #30363d; }
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 20px 0; background: #0d1117; padding: 20px; border-radius: 8px; }
        .btn-auto { width: 100%; padding: 12px; font-weight: bold; cursor: pointer; border-radius: 6px; border: none; }
        .auto-on { background: #238636; color: white; }
        .auto-off { background: #30363d; color: white; }
        .indicator { font-size: 1.2em; color: #58a6ff; font-family: monospace; }
        h2 { color: #58a6ff; margin-top: 0; }
    </style>
</head>
<body>

<div class="dashboard">
    <h2>Processamento de Sinal Hidráulico: Filtro Ativo Açude</h2>
    
    <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
        <div style="text-align:center">COIMBRA (Saída do Filtro)<br><span id="hC_txt" class="indicator">15.50</span>m</div>
        <div style="text-align:center">ESTADO DO CANAL<br><span id="status_txt" class="indicator">NOMINAL</span></div>
        <div style="text-align:center">AGUIEIRA (Sinal In)<br><span id="qIn_txt" class="indicator">250</span> m³/s</div>
    </div>

    <div class="controls">
        <div>
            <label>Amplitude do Sinal (Aguieira)</label>
            <input type="range" id="qInCtrl" min="200" max="2500" value="250" style="width: 100%;">
        </div>
        <div style="text-align: center;">
            <button id="btnAuto" class="btn-auto auto-off">FILTRO INTELIGENTE: OFF</button>
            <div style="margin-top:5px; font-size:0.8em">Fase: <span id="clock">00:00</span></div>
        </div>
        <div>
            <label>Abertura Açude (Compensação)</label>
            <input type="range" id="gateCtrl" min="0" max="100" value="20" style="width: 100%;">
        </div>
    </div>

    <canvas id="mainChart"></canvas>
</div>

<script>
    const ctx = document.getElementById('mainChart').getContext('2d');
    const totalSamples = 96; 
    let labels = Array.from({length: totalSamples}, (_, i) => i);
    
    let signalIn = new Array(totalSamples).fill(250);
    let signalOut = new Array(totalSamples).fill(15.5);
    let signalComp = new Array(totalSamples).fill(20);
    let tideSignal = new Array(totalSamples).fill(15);
    
    let tick = 0, gatePos = 0.2, autoMode = false, qAmplitude = 250;

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'Sinal In (Aguieira)', data: signalIn, borderColor: '#ff9f43', pointRadius: 0 },
                { label: 'Resposta Coimbra (m)', data: signalOut, borderColor: '#f85149', yAxisID: 'y1', pointRadius: 0 },
                { label: 'Compensação Açude (%)', data: signalComp, borderColor: '#58a6ff', pointRadius: 0, fill: true, backgroundColor: 'rgba(88,166,255,0.1)' }
            ]
        },
        options: { animation: false, scales: { y: { min: 0, max: 3000 }, y1: { position: 'right', min: 14, max: 22 } } }
    });

    // --- LÓGICA DE FILTRAGEM INTELIGENTE ---
    function aplicarFiltroPreditivo() {
        // O Açude atua como um preditor: ele olha para o sinal que entrou no canal há X tempo
        // e ajusta a sua admitância para manter a saída constante (Cota 15-18m).
        let atrasoCanal = 20; // Amostras (aprox 5 horas)
        let sinalFuturo = signalIn[signalIn.length - 1];
        
        let alvoCompensacao = 20;

        // Se o sinal de entrada (Aguieira) sobe, o filtro abre ANTES do impacto
        if (sinalFuturo > 800) {
            // Ganho Proporcional à amplitude do sinal de entrada
            alvoCompensacao = Math.min(100, 20 + (sinalFuturo - 800) * 0.12);
        }

        // Ajuste fino baseado no erro atual (Feedback local)
        let cotaAtual = signalOut[signalOut.length - 1];
        if (cotaAtual > 18.5) alvoCompensacao = 100;

        // Resposta do atuador (comporta)
        let delta = (alvoCompensacao/100) - gatePos;
        gatePos += delta * 0.3; 

        document.getElementById('gateCtrl').value = gatePos * 100;
    }

    function simular() {
        tick++;
        // Simulação de sinal sinusoidal na Aguieira (se houver variação manual)
        let sIn = qAmplitude + Math.sin(tick * 0.2) * (qAmplitude > 500 ? 50 : 0);
        
        if(autoMode) aplicarFiltroPreditivo();

        // Modelo de Canal (Atraso + Atenuação)
        let nM = 15.0 + Math.sin(tick * 0.1) * 1.5;
        let hPrev = signalOut[signalOut.length - 1];
        
        // Equação de Fluxo (Filtro Ativo)
        let vazaoSaida = gatePos * 4800 * Math.sqrt(Math.max(0.1, hPrev - nM) / 1.1);
        let vazaoChegada = signalIn[signalIn.length - 20];
        
        let novoH = hPrev + (vazaoChegada - vazaoSaida) / 9000;
        if(novoH < 14.5) novoH = 14.5;

        // Atualização de Memória do Sistema
        signalIn.shift(); signalIn.push(sIn);
        signalOut.shift(); signalOut.push(novoH);
        signalComp.shift(); signalComp.push(gatePos * 100);

        // UI
        document.getElementById('hC_txt').innerText = novoH.toFixed(2);
        document.getElementById('qIn_txt').innerText = Math.round(sIn);
        document.getElementById('status_txt').innerText = novoH >= 20 ? "INUNDAÇÃO!" : (sIn > 1000 ? "ALERTA" : "ESTÁVEL");
        document.getElementById('status_txt').style.color = novoH >= 20 ? "#f85149" : (sIn > 1000 ? "#d29922" : "#3fb950");
        
        chart.update('none');
    }

    document.getElementById('qInCtrl').oninput = function() { qAmplitude = parseInt(this.value); };
    document.getElementById('gateCtrl').oninput = function() { if(!autoMode) gatePos = this.value / 100; };
    document.getElementById('btnAuto').onclick = function() { 
        autoMode = !autoMode; 
        this.className = "btn-auto " + (autoMode ? "auto-on" : "auto-off");
        this.innerText = autoMode ? "FILTRO INTELIGENTE: ON" : "FILTRO INTELIGENTE: OFF";
    };

    setInterval(simular, 400);
</script>
</body>
</html>
