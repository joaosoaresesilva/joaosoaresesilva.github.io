<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA MONDEGO V8: Escala Corrigida</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0d1117; color: #c9d1d9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .dashboard { width: 1150px; background: #161b22; padding: 25px; border-radius: 12px; border: 1px solid #30363d; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .status-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; text-align: center; }
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 20px 0; background: #0d1117; padding: 20px; border-radius: 8px; border: 1px solid #30363d; }
        .btn-auto { width: 100%; padding: 12px; font-weight: bold; cursor: pointer; border-radius: 6px; border: none; transition: 0.3s; }
        .auto-on { background: #238636; color: white; box-shadow: 0 0 15px rgba(35, 134, 54, 0.4); }
        .auto-off { background: #30363d; color: white; }
        .indicator { font-size: 1.3em; color: #58a6ff; font-family: monospace; font-weight: bold; }
        .danger { color: #f85149 !important; }
        .safe { color: #3fb950 !important; }
        label { font-size: 0.75em; color: #8b949e; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="dashboard">
    <h2 style="color: #58a6ff; margin-top: 0; text-align: center;">Otimização Mondego: Escala Real Alfarelos</h2>
    
    <div class="status-grid">
        <div class="stat-card">
            <label>Aguieira (Sinal In)</label><br>
            <span id="qIn_txt" class="indicator">250</span> <small>m³/s</small>
        </div>
        <div class="stat-card">
            <label>Cota Coimbra</label><br>
            <span id="hC_txt" class="indicator">15.50</span> <small>m</small>
        </div>
        <div class="stat-card">
            <label>Cota Alfarelos</label><br>
            <span id="hA_txt" class="indicator">8.50</span> <small>m</small>
        </div>
        <div class="stat-card">
            <label>Maré (Ruído)</label><br>
            <span id="mare_txt" class="indicator">15.00</span> <small>m</small>
        </div>
    </div>

    <div class="controls">
        <div>
            <label>Caudal Aguieira</label>
            <input type="range" id="qInCtrl" min="200" max="2800" value="250" style="width: 100%;">
        </div>
        <div style="text-align: center;">
            <button id="btnAuto" class="btn-auto auto-off">FILTRO DE IMPACTO: OFF</button>
            <div id="strategy_txt" style="font-size: 0.7em; margin-top: 8px; color: #8b949e;">GEOMETRIA CORRIGIDA</div>
        </div>
        <div>
            <label>Comportas (Compensação)</label>
            <input type="range" id="gateCtrl" min="0" max="100" value="20" style="width: 100%;">
            <div style="text-align:right; font-size:0.8em;"><span id="gVal">20</span>% Aberto</div>
        </div>
    </div>

    <canvas id="mainChart" height="100"></canvas>
</div>

<script>
    const ctx = document.getElementById('mainChart').getContext('2d');
    const samples = 120;
    let signalIn = new Array(samples).fill(250), signalOutC = new Array(samples).fill(15.5);
    let signalOutA = new Array(samples).fill(8.5), signalTide = new Array(samples).fill(15);
    let signalGate = new Array(samples).fill(0.2);

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: samples}, (_, i) => i),
            datasets: [
                { label: 'Aguieira (m3/s)', data: signalIn, borderColor: '#ff9f43', pointRadius: 0, borderWidth: 1 },
                { label: 'Coimbra (m)', data: signalOutC, borderColor: '#f85149', yAxisID: 'y1', pointRadius: 0, borderWidth: 3 },
                { label: 'Alfarelos (m)', data: signalOutA, borderColor: '#3fb950', yAxisID: 'y1', pointRadius: 0, borderWidth: 2 },
                { label: 'Maré (m)', data: signalTide, borderColor: '#777', borderDash: [5, 5], yAxisID: 'y1', pointRadius: 0, borderWidth: 1 }
            ]
        },
        options: { animation: false, scales: { y: { min: 0, max: 3000 }, y1: { position: 'right', min: 7, max: 22 } } }
    });

    let tick = 0, gatePos = 0.2, autoMode = false, qAmplitude = 250;

    function filtroOtimizador(hC, hA, qFuturo, mare) {
        let alvo = 20;
        let estrategia = "FLUXO NOMINAL";

        // PREDITIVO: Se o sinal da Aguieira sobe, Coimbra abre preventivamente
        if (qFuturo > 800) {
            alvo = 50 + (qFuturo - 800) * 0.05;
            estrategia = "PRÉ-VAZIAMENTO";
        }

        // LAMINAGEM: Se Coimbra está a subir (até 19.5m), limitamos Alfarelos
        if (qFuturo >= 1200 && hC < 19.5) {
            alvo = Math.min(alvo, 75); // "Corta" o pico para Alfarelos
            estrategia = "LAMINAGEM (POUPAR ALFARELOS)";
        }

        // EMERGÊNCIA: Coimbra no limite
        if (hC > 19.6) {
            alvo = 100;
            estrategia = "PROTEÇÃO URBANA CRÍTICA";
        }

        let erro = (alvo/100) - gatePos;
        gatePos += erro * 0.15;
        document.getElementById('gateCtrl').value = Math.round(gatePos * 100);
        document.getElementById('gVal').innerText = Math.round(gatePos * 100);
        document.getElementById('strategy_txt').innerText = estrategia;
    }

    function simular() {
        tick++;
        let currentTide = 15.0 + Math.sin(tick * 0.1) * 1.5;
        let sIn = qAmplitude + Math.sin(tick * 0.3) * (qAmplitude > 600 ? 30 : 0);
        
        if(autoMode) filtroOtimizador(signalOutC[samples-1], signalOutA[samples-1], sIn, currentTide);

        // Física Coimbra
        let hC_old = signalOutC[samples-1];
        let qC_in = signalIn[samples-20]; 
        let qC_out = gatePos * 5200 * Math.sqrt(Math.max(0.1, hC_old - currentTide) / 1.1);
        let nHC = hC_old + (qC_in - qC_out) / 9500;

        // FÍSICA ALFARELOS (CORREÇÃO DE ESCALA)
        let hA_old = signalOutA[samples-1];
        let qA_in = signalGate[samples-12] * 4800; // Atraso de transporte aumentado
        
        // Saída para o mar (impedância da maré)
        let qA_out = 320 * Math.sqrt(Math.max(0.1, hA_old - (currentTide - 7.5))); 
        
        // O divisor 35000 garante que Alfarelos suba em centímetros, não dezenas de metros
        let nHA = hA_old + (qA_in - qA_out) / 35000;

        // Limite inferior (Cota do leito normal)
        if(nHA < 8.5) nHA = 8.5;

        // Updates Arrays
        signalIn.shift(); signalIn.push(sIn);
        signalOutC.shift(); signalOutC.push(nHC);
        signalOutA.shift(); signalOutA.push(nHA);
        signalTide.shift(); signalTide.push(currentTide);
        signalGate.shift(); signalGate.push(gatePos);

        // UI
        document.getElementById('hC_txt').innerText = nHC.toFixed(2);
        document.getElementById('hA_txt').innerText = nHA.toFixed(2);
        document.getElementById('mare_txt').innerText = currentTide.toFixed(2);
        document.getElementById('qIn_txt').innerText = Math.round(sIn);
        
        // Cores de Alerta
        document.getElementById('hC_txt').className = nHC > 19.8 ? "indicator danger" : "indicator safe";
        document.getElementById('hA_txt').className = nHA > 11.0 ? "indicator danger" : "indicator safe";

        chart.update('none');
    }

    document.getElementById('qInCtrl').oninput = function() { qAmplitude = parseInt(this.value); };
    document.getElementById('gateCtrl').oninput = function() { if(!autoMode) gatePos = this.value / 100; document.getElementById('gVal').innerText = this.value; };
    document.getElementById('btnAuto').onclick = function() { 
        autoMode = !autoMode; 
        this.className = "btn-auto " + (autoMode ? "auto-on" : "auto-off");
        this.innerText = autoMode ? "OTIMIZADOR: ON" : "OTIMIZADOR: OFF";
    };

    setInterval(simular, 400);
</script>
</body>
</html>
