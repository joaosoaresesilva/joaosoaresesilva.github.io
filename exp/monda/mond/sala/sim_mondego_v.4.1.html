<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>MONDEGO SMART GESTÃO: Piloto Automático Preditivo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b0e14; color: #e0e0e0; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        .dashboard { width: 1100px; background: #161b22; padding: 25px; border-radius: 12px; border: 1px solid #30363d; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .flood-zones { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .zone-card { background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; position: relative; height: 110px; overflow: hidden; }
        .water-fill { position: absolute; bottom: 0; left: 0; width: 100%; background: #58a6ff; transition: height 0.4s ease; opacity: 0.6; }
        .danger-fill { background: #f85149 !important; }
        .zone-label { position: relative; z-index: 2; font-weight: bold; font-size: 0.9em; }

        .controls { display: grid; grid-template-columns: 1.2fr 1fr 1.2fr; gap: 20px; background: #0d1117; padding: 20px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 20px; align-items: center; }
        
        .panel-aguieira { border: 1px solid #ff9f43; padding: 10px; border-radius: 6px; }
        .panel-acude { border: 1px solid #58a6ff; padding: 10px; border-radius: 6px; }
        
        .btn-auto { width: 100%; padding: 15px; font-weight: bold; border-radius: 6px; border: none; cursor: pointer; transition: 0.3s; }
        .auto-off { background: #30363d; color: white; }
        .auto-on { background: #238636; color: white; box-shadow: 0 0 15px rgba(35, 134, 54, 0.4); }
        
        h2 { margin-top: 0; color: #58a6ff; }
        .value-bold { color: #d29922; font-family: monospace; font-size: 1.2em; }
    </style>
</head>
<body>

<div class="dashboard">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
        <div>
            <h2>Centro de Gestão Preditiva (IA)</h2>
            <small id="txtEstado" style="color: #8b949e;">SISTEMA DE MONITORIZAÇÃO ATIVO</small>
        </div>
        <div id="clock" style="font-family: monospace; font-size: 1.8em; color: #58a6ff;">00:00</div>
    </div>

    <div class="flood-zones">
        <div class="zone-card">
            <div class="zone-label">COIMBRA (Urbano)<br>Nível: <span id="hC_txt">15.50</span>m | Alerta: 20.0m</div>
            <div id="fillCoimbra" class="water-fill"></div>
        </div>
        <div class="zone-card">
            <div class="zone-label">ALFARELOS (Baixo Mondego)<br>Nível: <span id="hA_txt">9.50</span>m | Alerta: 11.5m</div>
            <div id="fillAlfarelos" class="water-fill"></div>
        </div>
    </div>

    <div class="controls">
        <div class="panel-aguieira">
            <label style="color: #ff9f43;">BARRAGEM DA AGUIEIRA (Input)</label><br>
            <input type="range" id="qInCtrl" min="200" max="3000" value="250" style="width: 100%;">
            <div style="margin-top:5px;">Caudal: <b id="qInVal" class="value-bold">250</b> m³/s</div>
        </div>

        <div style="text-align: center;">
            <button id="btnAuto" class="btn-auto auto-off">PILOTO AUTOMÁTICO: OFF</button>
            <div style="margin-top:10px; font-size: 0.8em; color: #8b949e;">MARÉ: <span id="mareStatus">---</span></div>
        </div>

        <div class="panel-acude">
            <label style="color: #58a6ff;">AÇUDE DE COIMBRA (Ação)</label><br>
            <input type="range" id="gateCtrl" min="0" max="100" value="20" style="width: 100%;">
            <div style="margin-top:5px;">Abertura: <b id="gVal" class="value-bold">20</b>%</div>
        </div>
    </div>

    <canvas id="mainChart"></canvas>
</div>

<script>
    const ctx = document.getElementById('mainChart').getContext('2d');
    const totalPontos = 96; 
    let labelsHoras = [];
    for(let i=0; i<totalPontos; i++) {
        let h = Math.floor(i / 4).toString().padStart(2,'0');
        let m = ((i % 4) * 15).toString().padStart(2,'0');
        labelsHoras.push(`${h}:${m}`);
    }

    let qIn = new Array(totalPontos).fill(250);
    let qOutCoimbra = new Array(totalPontos).fill(250);
    let hCoimbra = new Array(totalPontos).fill(15.5);
    let hAlfarelos = new Array(totalPontos).fill(9.5);
    let hMare = new Array(totalPontos).fill(15.0);
    
    let tick = 0;
    let gateAperture = 0.2;
    let autoMode = false;
    let qInManual = 250;

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labelsHoras,
            datasets: [
                { label: 'Caudal Aguieira (m³/s)', data: qIn, borderColor: '#ff9f43', pointRadius: 0, tension: 0.3 },
                { label: 'Nível Coimbra (m)', data: hCoimbra, borderColor: '#f85149', yAxisID: 'y1', borderWidth: 3, pointRadius: 0 },
                { label: 'Nível Alfarelos (m)', data: hAlfarelos, borderColor: '#3fb950', yAxisID: 'y1', borderWidth: 2, pointRadius: 0 },
                { label: 'Maré (m)', data: hMare, borderColor: '#444', borderDash: [3,3], yAxisID: 'y1', pointRadius: 0 }
            ]
        },
        options: { animation: false, scales: { y: { min: 0, max: 3500 }, y1: { position: 'right', min: 8, max: 24 } } }
    });

    // --- O CÉREBRO DO PILOTO AUTOMÁTICO ---
    function logicaIA(hC, hA, qFuturo, nivelMare) {
        let alvoAperture = 0.2; // Repouso

        // 1. ANTECIPAÇÃO: Pré-vaziamento
        if (qFuturo > 850) {
            alvoAperture = 0.0; // Abre tudo para baixar o nível antes da água chegar
        }

        // 2. GESTÃO DE CONFLITO: Tenta poupar Alfarelos se Coimbra estiver longe do perigo
        if (hA > 11.2 && hC < 19.2 && qFuturo < 1800) {
            alvoAperture = 0.35; // Fecha um pouco para segurar o volume
        }

        // 3. PRIORIDADE MÁXIMA: Salvar Coimbra
        if (hC > 19.3) {
            alvoAperture = 0.0;
        }

        // Suavização da comporta (PID simples)
        gateAperture += (alvoAperture - gateAperture) * 0.12;
        
        // Atualiza sliders e labels
        document.getElementById('gateCtrl').value = gateAperture * 100;
        document.getElementById('gVal').innerText = Math.round(gateAperture * 100);
    }

    function simular() {
        tick = (tick + 1) % totalPontos;
        document.getElementById('clock').innerText = labelsHoras[tick];

        let nivelMare = 15.0 + Math.sin((tick / totalPontos) * Math.PI * 4) * 1.5;
        let hC = hCoimbra[hCoimbra.length - 1];
        let hA = hAlfarelos[hAlfarelos.length - 1];

        // Executar IA se ativa
        if (autoMode) {
            logicaIA(hC, hA, qInManual, nivelMare);
        }

        // Física Hidrodinâmica
        let descargaC = gateAperture * 2850 * Math.sqrt(Math.max(0.1, hC - nivelMare) / 2);
        let qChegadaC = qIn[qIn.length - 20] || qIn[0]; // 5h atraso
        let novoHC = hC + (qChegadaC - descargaC) / 7200;

        let qChegadaA = qOutCoimbra[qOutCoimbra.length - 8] || qOutCoimbra[0]; // 2h atraso
        let escoamentoA = 190 * Math.sqrt(Math.max(0.1, hA - 8.5));
        let novoHA = hA + (qChegadaA - escoamentoA) / 15500;

        // Limites físicos de segurança
        if(novoHC < 14.1) novoHC = 14.1;
        if(novoHA < 8.6) novoHA = 8.6;

        // Update Dados
        qIn.shift(); qIn.push(qInManual);
        qOutCoimbra.shift(); qOutCoimbra.push(descargaC);
        hCoimbra.shift(); hCoimbra.push(novoHC);
        hAlfarelos.shift(); hAlfarelos.push(novoHA);
        hMare.shift(); hMare.push(nivelMare);

        // UI Feedback
        document.getElementById('hC_txt').innerText = novoHC.toFixed(2);
        document.getElementById('hA_txt').innerText = novoHA.toFixed(2);
        document.getElementById('mareStatus').innerText = nivelMare > 15 ? "MARÉ CHEIA ↑" : "MARÉ BAIXA ↓";
        
        document.getElementById('fillCoimbra').style.height = Math.max(0, (novoHC - 14) * 16) + "%";
        document.getElementById('fillAlfarelos').style.height = Math.max(0, (novoHA - 8.5) * 33) + "%";
        
        if(novoHC >= 20) document.getElementById('fillCoimbra').classList.add('danger-fill');
        else document.getElementById('fillCoimbra').classList.remove('danger-fill');
        
        if(novoHA >= 11.5) document.getElementById('fillAlfarelos').classList.add('danger-fill');
        else document.getElementById('fillAlfarelos').classList.remove('danger-fill');

        chart.update('none');
    }

    document.getElementById('qInCtrl').oninput = function() {
        qInManual = parseInt(this.value);
        document.getElementById('qInVal').innerText = qInManual;
    };

    document.getElementById('gateCtrl').oninput = function() {
        if(!autoMode) gateAperture = this.value / 100;
        document.getElementById('gVal').innerText = this.value;
    };

    document.getElementById('btnAuto').onclick = function() {
        autoMode = !autoMode;
        this.innerText = autoMode ? "PILOTO AUTOMÁTICO: ON" : "PILOTO AUTOMÁTICO: OFF";
        this.className = autoMode ? "btn-auto auto-on" : "btn-auto auto-off";
    };

    setInterval(simular, 500);
</script>
</body>
</html>
