<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA INTEGRADO MONDEGO: Coimbra & Alfarelos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0b0e14; color: #e0e0e0; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        .dashboard { width: 1100px; background: #161b22; padding: 25px; border-radius: 12px; border: 1px solid #30363d; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #30363d; padding-bottom: 15px; margin-bottom: 20px; }
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; background: #0d1117; padding: 20px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 20px; }
        .status-panel { display: flex; justify-content: space-around; padding: 10px; background: #1c2128; border-radius: 4px; margin-bottom: 15px; font-weight: bold; border-left: 5px solid #58a6ff; }
        .critical { color: #f85149; text-shadow: 0 0 10px rgba(248, 81, 73, 0.5); }
        button { padding: 12px; cursor: pointer; background: #238636; color: white; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        button:hover { background: #2ea043; }
        input[type=range] { width: 100%; cursor: pointer; }
        .label-val { color: #d29922; font-family: monospace; font-size: 1.2em; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="header">
        <div>
            <h2 style="margin:0; color:#58a6ff;">Centro de Comando de Bacia</h2>
            <small style="color:#8b949e;">Simulador Hidrodinâmico: Aguieira - Coimbra - Alfarelos</small>
        </div>
        <div style="text-align: right;">
            <div id="clock" style="font-size: 1.5em; font-family: monospace;">00:00</div>
            <div id="txtEstado" style="color: #3fb950;">SISTEMA NOMINAL</div>
        </div>
    </div>

    <div class="status-panel">
        <div>COIMBRA: <span id="hCoimbraVal">15.50</span>m</div>
        <div>ALFARELOS: <span id="hAlfarelosVal">9.50</span>m</div>
        <div>MARÉ: <span id="mareVal">15.00</span>m</div>
    </div>

    <div class="controls">
        <div>
            <label>Abertura do Açude: <b id="gVal" class="label-val">20</b>%</label>
            <input type="range" id="gateCtrl" min="0" max="100" value="20">
            <p style="font-size: 0.7em; color: #8b949e;">Nota: 0% abre totalmente as comportas.</p>
        </div>
        <div style="text-align: center; border-left: 1px solid #30363d; border-right: 1px solid #30363d;">
            <span style="font-size: 0.8em;">MARÉ NA FIGUEIRA DA FOZ</span>
            <div id="mareStatus" style="font-size: 1.1em; margin-top: 10px; color: #d29922;">---</div>
        </div>
        <div>
            <button id="stormBtn" style="width: 100%; background: #da3633;">SIMULAR DESCARGA AGUIEIRA (2200 m³/s)</button>
            <button id="resetBtn" style="width: 100%; margin-top: 10px; background: #30363d;">RESET SISTEMA</button>
        </div>
    </div>

    <canvas id="mainChart"></canvas>
</div>

<script>
    const ctx = document.getElementById('mainChart').getContext('2d');
    
    // Configuração de Tempo (Janela de 24h em intervalos de 15min)
    const totalPontos = 96;
    let labelsHoras = [];
    for(let i=0; i<totalPontos; i++) {
        let h = Math.floor(i / 4).toString().padStart(2,'0');
        let m = ((i % 4) * 15).toString().padStart(2,'0');
        labelsHoras.push(`${h}:${m}`);
    }

    // Vetores de Dados
    let qIn = new Array(totalPontos).fill(250);      // Aguieira (Entrada)
    let qOutCoimbra = new Array(totalPontos).fill(250); // Saída do Açude
    let hCoimbra = new Array(totalPontos).fill(15.5);
    let hAlfarelos = new Array(totalPontos).fill(9.5);
    let hMare = new Array(totalPontos).fill(15.0);
    
    let tick = 0;
    let gateAperture = 0.2;
    const tauAC = 20; // 5 Horas de atraso Aguieira -> Coimbra
    const tauCA = 8;  // 2 Horas de atraso Coimbra -> Alfarelos

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labelsHoras,
            datasets: [
                { label: 'Caudal Aguieira (m³/s)', data: qIn, borderColor: '#ff9f43', pointRadius: 0, tension: 0.3 },
                { label: 'Cota Coimbra (m)', data: hCoimbra, borderColor: '#f85149', yAxisID: 'y1', borderWidth: 3, pointRadius: 0 },
                { label: 'Cota Alfarelos (m)', data: hAlfarelos, borderColor: '#3fb950', yAxisID: 'y1', borderWidth: 2, pointRadius: 0 },
                { label: 'Nível Maré (m)', data: hMare, borderColor: '#444', borderDash: [5,5], yAxisID: 'y1', pointRadius: 0 }
            ]
        },
        options: {
            animation: false,
            scales: {
                y: { title: {display: true, text: 'Caudal (m³/s)', color: '#8b949e'}, min: 0, max: 3500, grid: {color: '#30363d'} },
                y1: { position: 'right', title: {display: true, text: 'Cota (m)', color: '#8b949e'}, min: 8, max: 25, grid: {drawOnChartArea: false} }
            },
            plugins: { legend: { labels: { color: '#e0e0e0' } } }
        }
    });

    function processarSimulacao() {
        tick = (tick + 1) % totalPontos;
        document.getElementById('clock').innerText = labelsHoras[tick];

        // 1. Simulação da Maré (Período de 12.4h)
        let nivelMare = 15.0 + Math.sin((tick / totalPontos) * Math.PI * 4) * 1.5;
        
        // 2. Dinâmica de Coimbra (O coração do teu controlo)
        let hC = hCoimbra[hCoimbra.length - 1];
        let diffPressao = Math.max(0.1, hC - nivelMare);
        // Equação de comporta: Caudal depende da abertura e da pressão da água
        let descargaCoimbra = gateAperture * 2800 * Math.sqrt(diffPressao / 2);

        let qChegadaCoimbra = qIn[qIn.length - tauAC] || qIn[0];
        let dhCoimbra = (qChegadaCoimbra - descargaCoimbra) / 7000;
        let novoHC = hC + dhCoimbra;

        // 3. Dinâmica de Alfarelos (A jusante)
        let hA = hAlfarelos[hAlfarelos.length - 1];
        let qChegadaAlfarelos = qOutCoimbra[qOutCoimbra.length - tauCA] || qOutCoimbra[0];
        // Alfarelos tem escoamento natural para o oceano
        let escoamentoAlfarelos = 180 * Math.sqrt(Math.max(0.1, hA - 8.5));
        let dhAlfarelos = (qChegadaAlfarelos - escoamentoAlfarelos) / 15000;
        let novoHA = hA + dhAlfarelos;

        // Atualizar os Arrays para o gráfico
        qIn.shift(); qIn.push(qIn[qIn.length-1]);
        qOutCoimbra.shift(); qOutCoimbra.push(descargaCoimbra);
        hCoimbra.shift(); hCoimbra.push(novoHC);
        hAlfarelos.shift(); hAlfarelos.push(novoHA);
        hMare.shift(); hMare.push(nivelMare);

        // Atualização da Interface
        document.getElementById('hCoimbraVal').innerText = novoHC.toFixed(2);
        document.getElementById('hAlfarelosVal').innerText = novoHA.toFixed(2);
        document.getElementById('mareVal').innerText = nivelMare.toFixed(2);
        document.getElementById('mareStatus').innerText = nivelMare > 15 ? "ENCHENTE ↑" : "VAZANTE ↓";

        // Lógica de Alerta
        let estadoTxt = document.getElementById('txtEstado');
        if (novoHC > 20) {
            estadoTxt.innerText = "ALERTA: BAIXA INUNDADA";
            estadoTxt.className = "critical";
        } else if (novoHA > 11.5) {
            estadoTxt.innerText = "ALERTA: CHEIA EM ALFARELOS";
            estadoTxt.className = "critical";
        } else {
            estadoTxt.innerText = "SISTEMA NOMINAL";
            estadoTxt.style.color = "#3fb950";
        }

        chart.update('none');
    }

    // Listeners
    document.getElementById('gateCtrl').oninput = function() {
        gateAperture = this.value / 100;
        document.getElementById('gVal').innerText = this.value;
    };

    document.getElementById('stormBtn').onclick = function() {
        // Injeta uma onda de cheia nos últimos dados da Aguieira
        let pico = 2200;
        for(let i=0; i<30; i++) {
            setTimeout(() => { qIn[qIn.length - 1] = pico; }, i * 50);
        }
    };

    document.getElementById('resetBtn').onclick = () => location.reload();

    // Início da Simulação (500ms = 15 minutos reais)
    setInterval(processarSimulacao, 500);
</script>
</body>
</html>
