<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>MONDEGO SMART GRID: Mapa de Risco AC</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Courier New', monospace; background: #0a0a0a; color: #00ff41; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .dashboard { width: 1150px; background: #111; padding: 25px; border: 2px solid #00ff41; border-radius: 5px; }
        
        /* Layout do Mapa */
        .map-container { 
            width: 100%; height: 200px; background: #050505; border: 1px solid #222; 
            margin-bottom: 20px; position: relative; overflow: hidden;
        }
        .map-label { position: absolute; font-size: 0.7em; color: #00ff41; font-weight: bold; }
        
        .status-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #000; padding: 15px; border: 1px solid #333; text-align: center; }
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 20px 0; padding: 20px; border: 1px dashed #333; }
        .btn-auto { width: 100%; padding: 12px; font-weight: bold; cursor: pointer; background: #000; color: #00ff41; border: 1px solid #00ff41; }
        .auto-on { background: #00ff41; color: #000; }
        .indicator { font-size: 1.4em; font-weight: bold; }
        input[type=range] { width: 100%; accent-color: #00ff41; }
    </style>
</head>
<body>

<div class="dashboard">
    <h2 style="text-align: center; margin-top: 0;">MONITORIZAÇÃO ESPACIAL: COIMBRA - FIGUEIRA DA FOZ</h2>

    <div class="map-container" id="mapa">
        <svg width="1100" height="200" viewBox="0 0 1100 200">
            <path d="M 50 100 Q 300 80, 550 100 T 1050 120" stroke="#112244" stroke-width="8" fill="none" />
            
            <text x="50" y="70" fill="#00ff41" font-size="12">AGUIEIRA (FONTE)</text>
            <text x="350" y="70" fill="#00ff41" font-size="12">COIMBRA (NÓ 1)</text>
            <circle id="ringC1" cx="350" cy="95" r="10" fill="none" stroke="#f85149" stroke-width="2" opacity="0.5" />
            <circle id="ringC2" cx="350" cy="95" r="20" fill="none" stroke="#f85149" stroke-width="1" opacity="0.3" />
            
            <text x="700" y="150" fill="#00ff41" font-size="12">ALFARELOS (NÓ 2 / CANAL ESTREITO)</text>
            <circle id="ringA1" cx="750" cy="115" r="10" fill="none" stroke="#3fb950" stroke-width="2" opacity="0.5" />
            <circle id="ringA2" cx="750" cy="115" r="25" fill="none" stroke="#3fb950" stroke-width="1" opacity="0.3" />

            <text x="980" y="90" fill="#00ff41" font-size="12">FOZ (MARÉ)</text>
            <rect x="1050" y="50" width="40" height="100" fill="#112244" opacity="0.5" />
        </svg>
    </div>

    <div class="status-grid">
        <div class="stat-card"><label>I_in (Aguieira)</label><br><span id="qIn_txt" class="indicator">250</span></div>
        <div class="stat-card"><label>V1 (Coimbra)</label><br><span id="hC_txt" class="indicator">15.50</span></div>
        <div class="stat-card"><label>V2 (Alfarelos)</label><br><span id="hA_txt" class="indicator">8.50</span></div>
        <div class="stat-card"><label>V_ac (Maré)</label><br><span id="mare_txt" class="indicator">15.00</span></div>
    </div>

    <div class="controls">
        <div><label>Caudal Fonte</label><input type="range" id="qInCtrl" min="200" max="2800" value="250"></div>
        <div style="text-align: center;"><button id="btnAuto" class="btn-auto">COMPENSADOR AC: OFF</button></div>
        <div><label>Abertura Açude (Z)</label><input type="range" id="gateCtrl" min="0" max="100" value="20"></div>
    </div>

    <canvas id="mainChart" height="90"></canvas>
</div>

<script>
    const ctx = document.getElementById('mainChart').getContext('2d');
    const samples = 120;
    let signalIn = new Array(samples).fill(250), signalOutC = new Array(samples).fill(15.5);
    let signalOutA = new Array(samples).fill(8.5), signalTide = new Array(samples).fill(15);
    let signalGate = new Array(samples).fill(0.2);

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: samples}, (_, i) => i),
            datasets: [
                { label: 'Caudal [I] (m3/s)', data: signalIn, borderColor: '#ff9f43', pointRadius: 0, borderWidth: 1 },
                { label: 'Cota Coimbra [V1] (m)', data: signalOutC, borderColor: '#f85149', yAxisID: 'y1', pointRadius: 0, borderWidth: 2 },
                { label: 'Cota Alfarelos [V2] (m)', data: signalOutA, borderColor: '#3fb950', yAxisID: 'y1', pointRadius: 0, borderWidth: 3 }
            ]
        },
        options: { animation: false, scales: { y: { min: 0, max: 3000 }, y1: { position: 'right', min: 7, max: 22 } } }
    });

    let tick = 0, gatePos = 0.2, autoMode = false, qAmplitude = 250;

    function atualizarMapa(vC, vA) {
        // Coimbra: O raio do círculo cresce exponencialmente após os 18m
        let rC = Math.max(5, (vC - 14) * 15);
        document.getElementById('ringC1').setAttribute('r', rC);
        document.getElementById('ringC2').setAttribute('r', rC * 1.5);
        document.getElementById('ringC1').style.stroke = vC > 19.5 ? "#ff0000" : "#f85149";

        // Alfarelos: O impacto é visível a partir dos 9.5m
        let rA = Math.max(5, (vA - 8) * 20);
        document.getElementById('ringA1').setAttribute('r', rA);
        document.getElementById('ringA2').setAttribute('r', rA * 1.8);
        document.getElementById('ringA1').style.stroke = vA > 11.0 ? "#ff0000" : "#3fb950";
    }

    function simular() {
        tick++;
        let vMare = 15.0 + Math.sin(tick * 0.1) * 1.5;
        let iIn = qAmplitude + Math.sin(tick * 0.3) * (qAmplitude > 600 ? 50 : 0);
        
        // Dinâmica AC
        let vC_old = signalOutC[samples-1];
        let iAçude = gatePos * 5000 * Math.sqrt(Math.max(0.1, vC_old - vMare) / 1.1);
        let vC_new = vC_old + (signalIn[samples-20] - iAçude) / 9500;
        
        let vA_old = signalOutA[samples-1];
        let iOut = 480 * Math.pow(Math.max(0.1, vA_old - 7.8), 1.6);
        if (vMare > 15.3) iOut *= 0.75;
        let vA_new = vA_old + (signalGate[samples-12] * 4600 - iOut) / 42000;

        // Updates
        signalIn.shift(); signalIn.push(iIn);
        signalOutC.shift(); signalOutC.push(vC_new);
        signalOutA.shift(); signalOutA.push(vA_new);
        signalTide.shift(); signalTide.push(vMare);
        signalGate.shift(); signalGate.push(gatePos);

        // UI e Mapa
        document.getElementById('qIn_txt').innerText = Math.round(iIn);
        document.getElementById('hC_txt').innerText = vC_new.toFixed(2);
        document.getElementById('hA_txt').innerText = vA_new.toFixed(2);
        document.getElementById('mare_txt').innerText = vMare.toFixed(2);
        
        atualizarMapa(vC_new, vA_new);
        chart.update('none');
    }

    document.getElementById('qInCtrl').oninput = function() { qAmplitude = parseInt(this.value); };
    document.getElementById('gateCtrl').oninput = function() { gatePos = this.value / 100; };
    document.getElementById('btnAuto').onclick = function() { 
        autoMode = !autoMode; 
        this.className = "btn-auto " + (autoMode ? "auto-on" : "");
    };

    setInterval(simular, 400);
</script>
</body>
</html>
