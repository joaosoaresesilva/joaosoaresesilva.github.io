<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>MONDEGO MONITOR V5 - CENTROIDES ISOMÉTRICOS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Courier New', monospace; background: #050505; color: #d0d0d0; display: flex; flex-direction: column; height: 100vh; }
        #map { height: 45vh; width: 100%; background: #000; border-bottom: 2px solid #333; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .panel { flex: 1; padding: 20px; background: #0a0a0a; border-right: 1px solid #222; }
        .sidebar { flex: 2; padding: 10px; background: #050505; overflow-y: auto; }
        .data-card { background: #111; padding: 15px; border-left: 4px solid #00d2ff; margin-bottom: 10px; }
        table { width: 100%; font-size: 11px; color: #eee; border-collapse: collapse; }
        th { text-align: left; padding: 10px; border-bottom: 1px solid #444; color: #00d2ff; }
        td { padding: 8px; border-bottom: 1px solid #222; }
        .tag-centro { background: #333; padding: 2px 5px; font-size: 9px; border-radius: 3px; margin-right: 5px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="main-container">
    <div class="panel">
        <div class="data-card"><h3>CAUDAL (Q)</h3><div id="valFlow" style="font-size:2em; font-weight:bold;">---</div></div>
        <div class="data-card"><h3>MARÉ REAL</h3><div id="valMare" style="font-size:2em; color:#00d2ff;">---</div></div>
        <button id="btnLog" style="width:100%; padding:15px; background:none; border:1px solid #00d2ff; color:#00d2ff; cursor:pointer; font-weight:bold;">EXPORTAR CENTROIDES (.TXT)</button>
    </div>
    <div class="sidebar">
        <table>
            <thead><tr><th>ID CENTROIDE</th><th>COTA (Z)</th><th>RAIO MÉDIO</th><th>STATUS</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', {zoomControl: false}).setView([40.1800, -8.5800], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    // --- DEFINIÇÃO DOS CENTROIDES E RAIOS (LÓGICA DO UTILIZADOR) ---
    // Raio (r) em metros para representação no mapa
    const centros = [
        // Núcleos do Leito (Verde - Cotas mais Baixas)
        {id: "CTR-VERDE-BOLAO", pos: [40.218, -8.455], cota: 14.5, r: 400, color: "#00ff77", dist: 1.5},
        {id: "CTR-VERDE-ARZILA", pos: [40.162, -8.545], cota: 11.8, r: 600, color: "#00ff77", dist: 14.0},
        {id: "CTR-VERDE-ARUNCA", pos: [40.138, -8.718], cota: 3.8,  r: 350, color: "#00ff77", dist: 31.0},

        // Núcleos de Saturação (Azul Claro - Cotas Médias)
        {id: "CTR-CLARO-BOLAO", pos: [40.215, -8.465], cota: 16.2, r: 1200, color: "#00d2ff", dist: 2.5},
        {id: "CTR-CLARO-ARZILA", pos: [40.165, -8.555], cota: 13.5, r: 1800, color: "#00d2ff", dist: 15.5},
        {id: "CTR-CLARO-ARUNCA", pos: [40.142, -8.710], cota: 5.5,  r: 1500, color: "#00d2ff", dist: 32.5},

        // Núcleos Críticos (Azul Escuro - Cotas de Transbordo)
        {id: "CTR-ESC-BOLAO", pos: [40.220, -8.475], cota: 17.8, r: 800, color: "#0044ff", dist: 3.5},
        {id: "CTR-ESC-PEREIRA", pos: [40.160, -8.580], cota: 12.2, r: 2500, color: "#0044ff", dist: 18.0},
        {id: "CTR-ESC-VVERDE", pos: [40.135, -8.740], cota: 4.8,  r: 2000, color: "#0044ff", dist: 34.0}
    ];

    let apaQ = 0, apaH = 0, hMare = 0.5, circulos = {};

    centros.forEach(c => {
        circulos[c.id] = L.circle(c.pos, {
            radius: c.r,
            color: c.color,
            fillColor: c.color,
            fillOpacity: 0.2,
            weight: 2
        }).addTo(map);
    });

    async function fetchData() {
        try {
            // Simulação/Scraping (Ajustar para os links reais como nos scripts anteriores)
            apaQ = 850; // Exemplo fixo para demonstração
            apaH = 19.5; 
            hMare = 1.2;
            render();
        } catch(e) { console.log("Erro na leitura"); }
    }

    function render() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        document.getElementById('valFlow').innerText = apaQ + " m3/s";
        document.getElementById('valMare').innerText = hMare + " m";

        centros.forEach(c => {
            // Lógica de cálculo do nível de água no centroide
            let hLocal = (apaH - (c.dist * 0.05) + (apaQ/3000) + (hMare * 0.4 * Math.max(0, 1-(c.dist/40))));
            let inundado = hLocal > c.cota;
            
            let row = tbody.insertRow();
            row.innerHTML = `<td><span class="tag-centro">ID</span>${c.id}</td><td>${c.cota}m</td><td>${c.r}m</td><td style="color:${inundado ? '#ff4444' : '#00ff77'}">${inundado ? 'ATIVO' : 'SECO'}</td>`;
            
            // Alterar opacidade se estiver "ativo" (inundado)
            circulos[c.id].setStyle({
                fillOpacity: inundado ? 0.6 : 0.1,
                dashArray: inundado ? null : '5, 10'
            });
        });
    }

    fetchData();
    setInterval(fetchData, 60000);
</script>
</body>
</html>
