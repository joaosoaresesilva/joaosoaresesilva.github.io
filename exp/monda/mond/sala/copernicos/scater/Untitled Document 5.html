<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>EMSR864 COIMBRA - DYNAMIC SCATTER PLOT</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #050505; color: #d0d2d6; font-family: 'Courier New', monospace; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 45vh; width: 100%; filter: contrast(1.2) brightness(0.8); border-bottom: 2px solid #0044ff; }
        .sar-header { background: #111; padding: 10px 20px; font-size: 11px; color: #00d2ff; display: flex; justify-content: space-between; border-bottom: 1px solid #333; }
        .data-layout { flex: 1; display: flex; overflow: hidden; background: #0a0a0a; }
        .sidebar { width: 300px; padding: 15px; border-right: 1px solid #222; overflow-y: auto; }
        .table-container { flex: 1; overflow-y: auto; padding: 10px; font-size: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #00d2ff; border-bottom: 2px solid #333; padding: 8px; position: sticky; top: 0; background: #0a0a0a; }
        td { padding: 6px; border-bottom: 1px solid #1a1a1a; }
        .val-display { font-size: 1.5em; font-weight: bold; color: #fff; margin-bottom: 10px; }
        .status-pill { padding: 2px 6px; border-radius: 10px; font-weight: bold; font-size: 9px; }
        .green { color: #00ff77; border: 1px solid #00ff77; }
        .lblue { color: #00d2ff; border: 1px solid #00d2ff; }
        .dblue { color: #0044ff; border: 1px solid #0044ff; font-weight: 900; }
    </style>
</head>
<body>

<div class="sar-header">
    <div>MONITORIZAÇÃO SAR: <b>COIMBRA (AÇUDE)</b></div>
    <div>SINC STATUS: <b id="sync">A LER APA...</b></div>
</div>

<div id="map"></div>

<div class="data-layout">
    <div class="sidebar">
        <small>CAUDAL AÇUDE (Q)</small>
        <div id="dispQ" class="val-display">--- m3/s</div>
        <small>COTA CALCULADA (h)</small>
        <div id="dispH" class="val-display" style="color:#00d2ff">--- m</div>
        <hr style="border:0; border-top:1px solid #222; margin:15px 0;">
        <div style="font-size: 9px; opacity: 0.7;">
            IDs discretos mapeados para Coimbra. A cor reflete a interseção hidrostática em tempo real.
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr><th>ID DISCRETO</th><th>Z SOLO</th><th>H RIO</th><th>ESTADO SAR</th></tr>
            </thead>
            <tbody id="dataTable"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Foco em Coimbra (Açude e Parque da Canção)
    const map = L.map('map', {zoomControl: false}).setView([40.2080, -8.4350], 15);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    const scatterDataset = [];
    const centroidesCoimbra = [
        {id: "CBR-URB", pos: [40.2100, -8.4380], z: 18.5}, // Zona Açude
        {id: "CBR-PAR", pos: [40.2040, -8.4320], z: 19.2}, // Parque da Canção
        {id: "CBR-MON", pos: [40.2010, -8.4340], z: 18.0}  // Santa Clara Velha
    ];

    function initScatterCoimbra() {
        let globalID = 7000;
        centroidesCoimbra.forEach(c => {
            for (let i = 0; i < 60; i++) {
                const lat = c.pos[0] + (Math.random() - 0.5) * 0.008;
                const lng = c.pos[1] + (Math.random() - 0.5) * 0.012;
                const zSolo = c.z + (Math.random() * 2.5); // Variação de relevo urbana

                const marker = L.circleMarker([lat, lng], {
                    radius: 3,
                    weight: 1,
                    color: "#fff",
                    fillOpacity: 0.9
                }).addTo(map);

                scatterDataset.push({
                    id: `ID-${globalID++}`,
                    pos: [lat, lng],
                    z: zSolo,
                    marker: marker
                });
            }
        });
    }

    async function updateHydraulics() {
        // Simulação de pulso de cheia em Coimbra
        const Q = 950 + (Math.sin(Date.now()/5000) * 300);
        const hAgua = 19.5 + (Q / 1600); // Algoritmo de Coimbra

        document.getElementById('dispQ').innerText = Q.toFixed(0) + " m3/s";
        document.getElementById('dispH').innerText = hAgua.toFixed(2) + " m";
        document.getElementById('sync').innerText = "OK: " + new Date().toLocaleTimeString();

        const tbody = document.getElementById('dataTable');
        tbody.innerHTML = '';

        scatterDataset.forEach(p => {
            const diff = hAgua - p.z;
            let color, label, css;

            if (diff >= 0.5) {
                color = "#0044ff"; label = "AZUL ESCURO (CHEIA)"; css = "dblue";
            } else if (diff >= 0) {
                color = "#00d2ff"; label = "AZUL CLARO (ALERTA)"; css = "lblue";
            } else {
                color = "#00ff77"; label = "VERDE (REFERÊNCIA)"; css = "green";
            }

            p.marker.setStyle({ fillColor: color });

            // Popular Tabela (IDs Ativos)
            const row = tbody.insertRow();
            row.innerHTML = `
                <td style="color:#fff; font-weight:bold;">${p.id}</td>
                <td>${p.z.toFixed(2)}m</td>
                <td style="color:#00d2ff">${hAgua.toFixed(2)}m</td>
                <td><span class="status-pill ${css}">${label}</span></td>
            `;
        });
    }

    initScatterCoimbra();
    setInterval(updateHydraulics, 3000);
    updateHydraulics();

</script>
</body>
</html>
