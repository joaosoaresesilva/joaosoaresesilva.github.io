<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>MONDEGO LIVE - AUTO-SYNC APA</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #020508; color: #00d2ff; font-family: 'Courier New', monospace; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 50vh; width: 100%; filter: contrast(1.2) brightness(0.8); border-bottom: 2px solid #0044ff; }
        .dashboard { flex: 1; display: flex; background: #050a0f; }
        .station-card { width: 300px; padding: 20px; border-right: 1px solid #1a2a3a; background: #081018; }
        .val-big { font-size: 38px; font-weight: bold; color: #fff; text-shadow: 0 0 10px #0044ff; transition: all 0.5s; }
        .status-tag { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .flood { background: #900; color: #fff; animation: blink 1s infinite; }
        .safe { background: #050; color: #0f7; }
        .monitor-table { flex: 1; padding: 15px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { text-align: left; border-bottom: 1px solid #1a2a3a; padding: 10px; color: #5588ff; }
        td { padding: 10px; border-bottom: 1px solid #0d151d; }
        @keyframes blink { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

<div id="map"></div>

<div class="dashboard">
    <div class="station-card">
        <small>ESTAÇÃO APA: 1627743374</small>
        <div style="margin: 5px 0;"><b>AÇUDE PONTE (LIVE)</b></div>
        <div class="val-big" id="currentLevel">--.-- m</div>
        <div id="lastUpdate" style="font-size: 10px; opacity: 0.5; margin-top: 10px;">A conectar ao InfoÁgua...</div>
        <div id="syncStatus" style="font-size: 9px; color: #ffae00; margin-top: 5px;">A ler dados via Proxy...</div>
    </div>

    <div class="monitor-table">
        <table>
            <thead>
                <tr><th>ID INFRAESTRUTURA</th><th>COTA Z</th><th>DISTÂNCIA (H-Z)</th><th>ESTADO</th></tr>
            </thead>
            <tbody id="infraBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', {zoomControl: false}).setView([40.2060, -8.4340], 15);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    const infraestrutura = [
        {id: "MOSTEIRO STA CLARA", pos: [40.2018, -8.4340], cota: 18.2},
        {id: "PARQUE VERDE - SUL", pos: [40.2035, -8.4285], cota: 18.8},
        {id: "ESTÁDIO UNIVERSITÁRIO", pos: [40.2065, -8.4385], cota: 19.1},
        {id: "DOCAS - PARQUE", pos: [40.2078, -8.4312], cota: 18.6},
        {id: "RETA DO CHOUPAL", pos: [40.2155, -8.4465], cota: 19.4}
    ];

    infraestrutura.forEach(loc => {
        loc.marker = L.circleMarker(loc.pos, { radius: 7, weight: 2, color: "#fff", fillOpacity: 1 }).addTo(map);
    });

    async function fetchAPA() {
        const urlAPA = "https://infoagua.apambiente.pt/pt/cheias/cheia-detalhe/1627743374";
        // Usamos um proxy público para contornar o CORS
        const proxyUrl = "https://api.allorigins.win/get?url=" + encodeURIComponent(urlAPA);

        try {
            const response = await fetch(proxyUrl);
            const data = await response.json();
            
            // Aqui fazemos o "Scraping" do valor dentro do HTML retornado
            const parser = new DOMParser();
            const doc = parser.parseFromString(data.contents, "text/html");
            
            // Procuramos o valor na tabela de "Últimos dados" do InfoÁgua
            // Nota: O seletor pode precisar de ajuste se a APA mudar o site
            const tds = doc.querySelectorAll('td');
            let nivelEncontrado = null;

            for (let i = 0; i < tds.length; i++) {
                // Procuramos um valor que pareça uma cota (ex: 17.xx)
                let val = tds[i].innerText.replace(',', '.').trim();
                if (!isNaN(val) && val > 10 && val < 30) { 
                    nivelEncontrado = parseFloat(val);
                    break; 
                }
            }

            if (nivelEncontrado) {
                updateVisuals(nivelEncontrado);
                document.getElementById('syncStatus').innerText = "SINCRO OK (PROXY)";
            }
        } catch (e) {
            console.error("Erro na leitura:", e);
            document.getElementById('syncStatus').innerText = "ERRO NA LIGAÇÃO - A USAR ESTIMATIVA";
            // Em caso de erro, mantém o último valor ou simula
        }
    }

    function updateVisuals(hReal) {
        document.getElementById('currentLevel').innerText = hReal.toFixed(2) + " m";
        document.getElementById('lastUpdate').innerText = "ÚLTIMA ATUALIZAÇÃO: " + new Date().toLocaleTimeString();

        const tbody = document.getElementById('infraBody');
        tbody.innerHTML = '';

        infraestrutura.forEach(loc => {
            const diff = hReal - loc.cota;
            let status = "SECO", color = "#00ff77", sClass = "safe";

            if (diff >= 0) { status = "SUBMERSO"; color = "#0044ff"; sClass = "flood"; }
            else if (diff > -0.6) { status = "ALERTA"; color = "#00d2ff"; sClass = "safe"; }

            loc.marker.setStyle({ fillColor: color });
            tbody.innerHTML += `
                <tr>
                    <td><b>${loc.id}</b></td>
                    <td>${loc.cota}m</td>
                    <td style="color:${diff >= 0 ? '#ff4444' : '#aaa'}">${diff.toFixed(2)}m</td>
                    <td><span class="status-tag ${sClass}">${status}</span></td>
                </tr>
            `;
        });
    }

    // Atualiza a cada 5 minutos (evitar sobrecarga no proxy/APA)
    setInterval(fetchAPA, 300000); 
    fetchAPA(); // Primeira execução
</script>
</body>
</html>
