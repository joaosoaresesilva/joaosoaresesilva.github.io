<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA GESTÃO ADAPTATIVA - MONDEGO</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Mantenha os seus estilos aqui (CSS) */
        body { margin: 0; font-family: 'Courier New', monospace; background: #050505; color: #d0d0d0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 30vh; width: 100%; background: #000; filter: grayscale(1) contrast(1.2) brightness(0.8); border-bottom: 2px solid #333; }
        .sar-header { background: rgba(0,0,0,0.9); padding: 5px 20px; display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px solid #444; color: #aaa; align-items: center; }
        .sar-header b { color: #00d2ff; }
        #alertBox { padding: 2px 10px; border-radius: 3px; }
        .danger-blink { background: #e74c3c; color: white !important; animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }
        /* ... restantes estilos ... */
    </style>
</head>
<body>

<div class="sar-header">
    <div>SINC APA: <b id="lastSync">---</b></div>
    <div id="alertBox">RISCO JUSANTE: <b id="riskStatus">NORMAL</b></div>
    <div>MARÉ: <b id="txtMareStat">0.00m</b></div>
    <div>LINHAS DATASET: <b id="logCount">0</b></div>
    <div>SISTEMA: <b>GESTOR DINÂMICO (MARÉS)</b></div>
</div>

<div id="timeDisplay">
    <span id="simClock">--:--:--</span>
    <small id="elapsed">T+ 0 MIN</small>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- VARIÁVEIS GLOBAIS ---
    let amplitudeMare = 1.5;
    let periodoMareMinutos = 744;
    let nivelMareAtual = 0;
    // ... manter sensores, hC, hB, tempo, rodando, logBuffer ...

    // 2. SUBSTITUA A FUNÇÃO addSnapshot POR ESTA:
    function addSnapshot(tipo) {
        const hReal = new Date().toLocaleTimeString();
        const hSim = simTime.toLocaleTimeString();
        const caudal = document.getElementById('inpFlow').value;
        const açude = document.getElementById('inpGates').value;

        if (logBuffer.length === 1) {
            logBuffer[0] = "DATA_REAL\tHORA_SIM\tTIPO\tID_LOCAL\tREGIAO\tCOTA_REF\tNIVEL_ATUAL\tCAUDAL\tABERTURA_PERC\tNIVEL_MARE\n";
        }

        sensores.forEach(s => {
            let nivelBase = (s.reg === "C") ? hC : hB;
            
            // Lógica de influência da maré
            let influencia = 0;
            if (s.id.includes("FIGUEIRA")) influencia = 1.0;
            else if (s.id.includes("EREIRA") || s.id.includes("MONTEMOR")) influencia = 0.6;
            else if (s.id.includes("ARZILA") || s.id.includes("AMEAL")) influencia = 0.3;
            else if (s.id.includes("TAVEIRO")) influencia = 0.1;

            let nivelFinal = nivelBase + (nivelMareAtual * influencia);
            
            let linha = `${hReal}\t${hSim}\t${tipo}\t${s.id}\t${s.reg}\t${s.cota}\t${nivelFinal.toFixed(3)}\t${caudal}\t${açude}\t${nivelMareAtual.toFixed(2)}\n`;
            logBuffer.push(linha);
        });
        document.getElementById('logCount').innerText = logBuffer.length - 1;
    }

    // 3. SUBSTITUA A FUNÇÃO simular POR ESTA:
    function simular() {
        let flow = parseInt(document.getElementById('inpFlow').value);
        let gatesInput = document.getElementById('inpGates');
        let mode = document.querySelector('input[name="iaMode"]:checked').value;

        // Cálculo da Maré
        let fase = (tempo / periodoMareMinutos) * 2 * Math.PI;
        nivelMareAtual = Math.sin(fase) * amplitudeMare;
        
        const mareElem = document.getElementById('txtMareStat');
        mareElem.innerText = `${nivelMareAtual > 0 ? '+' : ''}${nivelMareAtual.toFixed(2)}m`;
        mareElem.style.color = nivelMareAtual > 1.2 ? '#e74c3c' : (nivelMareAtual < -1.0 ? '#2ecc71' : '#00d2ff');

        // Alerta de Risco Máximo
        const boxRisco = document.getElementById('alertBox');
        const txtRisco = document.getElementById('riskStatus');
        if (nivelMareAtual > 1.20 && flow > 2000) {
            boxRisco.className = "danger-blink";
            txtRisco.innerText = "RISCO MÁXIMO (BLOQUEIO)";
            if (tempo % 5 === 0) addSnapshot("RISCO_MAX_JUSANTE");
        } else {
            boxRisco.className = "";
            txtRisco.innerText = "NORMAL";
        }

        // Simulação Hidráulica
        if (mode === "baixa" && hC > 14.5) gatesInput.value = Math.min(100, parseInt(gatesInput.value) + 2);
        else if (mode === "total") {
            if (hC > 15.2) gatesInput.value = Math.min(100, parseInt(gatesInput.value) + 1);
            else if (hB > 11.5) gatesInput.value = Math.max(0, parseInt(gatesInput.value) - 1);
        }

        let abertura = parseInt(gatesInput.value) / 100;
        document.getElementById('txtGates').innerText = gatesInput.value;
        hC += ((13.0 + (flow / 3000) + ((1 - abertura) * 6.0)) - hC) * 0.1;
        let baseHB = 8.0 + (flow / 4000) + (abertura * 7.0);
        hB += (baseHB + (nivelMareAtual * 0.4) - hB) * 0.08;

        simTime.setMinutes(simTime.getMinutes() + 1);
        tempo++;
        updateUI();
        desenharGrafico();
    }
    
    // ... restantes funções (updateUI, fetchAPA, listeners de botões) ...
</script>
</body>
</html>
