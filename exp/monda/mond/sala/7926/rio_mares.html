<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA GESTÃO ADAPTATIVA - MONDEGO (FULL DATASET)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Courier New', monospace; background: #050505; color: #d0d0d0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 30vh; width: 100%; background: #000; filter: grayscale(1) contrast(1.2) brightness(0.8); border-bottom: 2px solid #333; }
        .sar-header { background: rgba(0,0,0,0.9); padding: 5px 20px; display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px solid #444; color: #aaa; align-items: center; }
        .sar-header b { color: #00d2ff; }
        #alertBox { padding: 2px 10px; border-radius: 3px; border: 1px solid #444; }
        .danger-blink { background: #e74c3c; color: white !important; animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }
        #timeDisplay { position: absolute; top: 50px; right: 20px; z-index: 1000; background: rgba(10, 10, 10, 0.9); padding: 10px; border: 1px solid #f1c40f; color: #f1c40f; text-align: right; }
        .main-container { display: flex; flex: 1; overflow: hidden; background: #0a0a0a; }
        .panel { flex: 1.2; padding: 15px; display: flex; flex-direction: column; gap: 8px; border-right: 1px solid #222; }
        
        /* CORREÇÃO DO SCROLL AQUI */
        .sidebar { flex: 1.8; padding: 15px; background: #050505; overflow-y: auto; max-height: 100%; }
        
        .slider-box { background: #111; padding: 8px; border: 1px solid #333; font-size: 0.75em; }
        .graph-container { background: #000; border: 1px solid #333; height: 60px; position: relative; }
        .graph-area { height: 100%; width: 100%; position: relative; overflow: hidden; }
        .bar-c { position: absolute; bottom: 0; width: 2px; background: #f1c40f; }
        .bar-b { position: absolute; bottom: 0; width: 2px; background: #00d2ff; }
        table { width: 100%; font-size: 10px; border-collapse: collapse; }
        th { position: sticky; top: 0; background: #050505; border-bottom: 2px solid #444; padding: 6px; text-align: left; color: #00d2ff; z-index: 10; }
        td { padding: 6px; border-bottom: 1px solid #222; }
        .at-risk { background: rgba(241, 196, 15, 0.1); color: #f1c40f; }
        .severe-risk { background: rgba(231, 76, 60, 0.15); color: #e74c3c; font-weight: bold; }
        button { font-family: inherit; padding: 10px; cursor: pointer; font-weight: bold; border: 1px solid; background: transparent; transition: 0.3s; width: 100%; margin-bottom: 5px; }
        #btnRun { color: #2ecc71; border-color: #2ecc71; }
        #btnLog { color: #f1c40f; border-color: #f1c40f; }
    </style>
</head>
<body>

<div class="sar-header">
    <div>SINC APA: <b id="lastSync">---</b></div>
    <div id="alertBox">RISCO JUSANTE: <b id="riskStatus">NORMAL</b></div>
    <div>MARÉ: <b id="txtMareStat">0.00m</b></div>
    <div>LINHAS DATASET: <b id="logCount">0</b></div>
</div>

<div id="timeDisplay">
    <span id="simClock" style="font-size: 1.5em; font-weight: bold; display: block;">--:--:--</span>
    <small id="elapsed">T+ 0 MIN</small>
</div>

<div id="map"></div>

<div class="main-container">
    <div class="panel">
        <div class="slider-box">COTA APA (C): <b id="txtInitC">--</b>m<input type="range" id="inpInitC" min="10.0" max="25.0" step="0.01" value="15.00"></div>
        <div class="slider-box">CAUDAL APA: <b id="txtFlow">--</b><input type="range" id="inpFlow" min="100" max="15000" step="1" value="2000"></div>
        <div class="slider-box">ABERTURA AÇUDE: <b id="txtGates">90</b>%<input type="range" id="inpGates" min="0" max="100" value="90"></div>
        <div class="graph-container"><div class="graph-area" id="graphArea"></div></div>
        <div style="background: #001a1a; padding: 10px; font-size: 10px; border: 1px solid #00d2ff;">
            MODO: <input type="radio" name="iaMode" value="manual" checked> Manual 
            <input type="radio" name="iaMode" value="total"> Auto
        </div>
        <button id="btnRun">INICIAR</button>
        <button id="btnLog">EXPORTAR R (.TXT)</button>
    </div>

    <div class="sidebar">
        <table>
            <thead><tr><th>LOCALIDADE</th><th>REF</th><th>NÍVEL</th><th>ESTADO</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([40.1850, -8.6000], 11); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // LISTA COMPLETA DOS 22 SENSORES
    const sensores = [
        {id: "PTE STA CLARA", pos: [40.2085, -8.4285], cota: 23.0, reg: "C"},
        {id: "BAIXA (P. COMÉRCIO)", pos: [40.2092, -8.4298], cota: 21.0, reg: "C"},
        {id: "ESTADIO UNIV.", pos: [40.2045, -8.4345], cota: 21.0, reg: "C"},
        {id: "PORTELA", pos: [40.1945, -8.4055], cota: 20.2, reg: "C"},
        {id: "R. FERREIRA BORGES", pos: [40.20918, -8.42912], cota: 20.0, reg: "C"},
        {id: "R. ADELINO VEIGA", pos: [40.209079, -8.43199], cota: 20.0, reg: "C"},
        {id: "ETA BOAVISTA", pos: [40.1895, -8.4190], cota: 20.0, reg: "C"},
        {id: "PARQUE VERDE", pos: [40.2035, -8.4275], cota: 20.0, reg: "C"},
        {id: "MOSTEIRO STA CLARA", pos: [40.2018, -8.4340], cota: 19.0, reg: "C"},
        {id: "MOSTEIRO STA CRUZ", pos: [40.2108, -8.4285], cota: 19.0, reg: "C"},
        {id: "R. DO GORGULHÃO", pos: [40.216701, -8.456282], cota: 19.0, reg: "C"},
        {id: "DOCAS RIO", pos: [40.202632, -8.426271], cota: 19.0, reg: "C"},
        {id: "CHOUPAL", pos: [40.2220, -8.4480], cota: 14.8, reg: "C"},
        {id: "TAVEIRO", pos: [40.1910, -8.5060], cota: 14.0, reg: "C"},
        {id: "AMEAL", pos: [40.1750, -8.5350], cota: 13.2, reg: "B"},
        {id: "CAMPOS DO BOLÃO", pos: [40.2150, -8.4650], cota: 13.0, reg: "B"},
        {id: "ARZILA", pos: [40.1650, -8.5550], cota: 12.5, reg: "B"},
        {id: "PEREIRA (LINHA)", pos: [40.1585, -8.5910], cota: 11.0, reg: "B"},
        {id: "FORMOSELHA", pos: [40.1550, -8.6250], cota: 10.8, reg: "B"},
        {id: "MONTEMOR (VILA)", pos: [40.1745, -8.6815], cota: 10.2, reg: "B"},
        {id: "EREIRA", pos: [40.1420, -8.6950], cota: 9.8, reg: "B"},
        {id: "FIGUEIRA (SALINAS)", pos: [40.1450, -8.8250], cota: 4.5, reg: "B"}
    ];

    let visualMarkers = {};
    let hC = 15.00, hB = 10.00, tempo = 0, rodando = false, ultimoMinLog = -1;
    let amplitudeMare = 1.5, periodoMareMinutos = 744, nivelMareAtual = 0;
    let simTime = new Date();
    let logBuffer = ["DATA_REAL\tHORA_SIM\tTIPO\tID_LOCAL\tREGIAO\tCOTA_REF\tNIVEL_ATUAL\tCAUDAL\tABERTURA_PERC\tNIVEL_MARE\n"];

    sensores.forEach(s => {
        L.circleMarker(s.pos, { radius: 3, color: '#00d2ff' }).addTo(map);
        visualMarkers[s.id] = { circle: L.circle(s.pos, { radius: 0, weight: 1, fillColor: '#f1c40f', fillOpacity: 0.2 }).addTo(map) };
    });

    function addSnapshot(tipo) {
        const caudal = document.getElementById('inpFlow').value;
        const açude = document.getElementById('inpGates').value;
        sensores.forEach(s => {
            let nivelBase = (s.reg === "C") ? hC : hB;
            let inf = getInfluenciaMare(s.id, s.reg);
            let nivelFinal = nivelBase + (nivelMareAtual * inf);
            logBuffer.push(`${new Date().toLocaleTimeString()}\t${simTime.toLocaleTimeString()}\t${tipo}\t${s.id}\t${s.reg}\t${s.cota}\t${nivelFinal.toFixed(3)}\t${caudal}\t${açude}\t${nivelMareAtual.toFixed(2)}\n`);
        });
        document.getElementById('logCount').innerText = logBuffer.length - 1;
    }

    function getInfluenciaMare(id, reg) {
        if (id.includes("FIGUEIRA")) return 1.0;
        if (id.includes("EREIRA") || id.includes("MONTEMOR")) return 0.7;
        if (id.includes("FORMOSELHA") || id.includes("PEREIRA")) return 0.5;
        if (id.includes("ARZILA") || id.includes("AMEAL")) return 0.3;
        if (id.includes("TAVEIRO")) return 0.1;
        return 0;
    }

    function simular() {
        let flow = parseInt(document.getElementById('inpFlow').value);
        let gatesInput = document.getElementById('inpGates');
        
        nivelMareAtual = Math.sin((tempo / periodoMareMinutos) * 2 * Math.PI) * amplitudeMare;
        document.getElementById('txtMareStat').innerText = `${nivelMareAtual.toFixed(2)}m`;

        const boxRisco = document.getElementById('alertBox');
        if (nivelMareAtual > 1.20 && flow > 2000) {
            boxRisco.className = "danger-blink";
            document.getElementById('riskStatus').innerText = "RISCO MÁXIMO";
        } else { boxRisco.className = ""; document.getElementById('riskStatus').innerText = "NORMAL"; }

        let abertura = parseInt(gatesInput.value) / 100;
        hC += ((13.0 + (flow / 3000) + ((1 - abertura) * 6.0)) - hC) * 0.1;
        hB += ((8.0 + (flow / 4000) + (abertura * 7.0)) + (nivelMareAtual * 0.4) - hB) * 0.08;

        if (simTime.getMinutes() % 5 === 0 && simTime.getMinutes() !== ultimoMinLog) {
            addSnapshot("STAT_5M");
            ultimoMinLog = simTime.getMinutes();
        }

        simTime.setMinutes(simTime.getMinutes() + 1);
        tempo++;
        updateUI();
        desenharGrafico();
    }

    function updateUI() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        sensores.forEach(s => {
            let nivel = ((s.reg === "C") ? hC : hB) + (nivelMareAtual * getInfluenciaMare(s.id, s.reg));
            let diff = nivel - s.cota;
            let est = diff > 1.0 ? "CRITICO" : (diff > 0 ? "ALERTA" : "OK");

            let row = tbody.insertRow();
            if (diff > 0) {
                row.className = diff > 1.0 ? 'severe-risk' : 'at-risk';
                visualMarkers[s.id].circle.setRadius(20 + diff * 500);
            } else { visualMarkers[s.id].circle.setRadius(0); }

            row.insertCell(0).innerText = s.id;
            row.insertCell(1).innerText = s.cota.toFixed(1);
            row.insertCell(2).innerText = nivel.toFixed(2);
            row.insertCell(3).innerText = est;
        });
        document.getElementById('simClock').innerText = simTime.toLocaleTimeString('pt-PT');
        document.getElementById('elapsed').innerText = `T+ ${tempo} MIN`;
    }

    function desenharGrafico() {
        const area = document.getElementById('graphArea');
        const x = (tempo * 2) % area.offsetWidth;
        if (x < 2) area.innerHTML = '';
        const bc = document.createElement('div'); bc.className = 'bar-c'; bc.style.left = x + 'px'; bc.style.height = Math.max(0, (hC - 10) * 4) + 'px';
        area.appendChild(bc);
        const bb = document.createElement('div'); bb.className = 'bar-b'; bb.style.left = x + 'px'; bb.style.height = Math.max(0, (hB - 5) * 4) + 'px';
        area.appendChild(bb);
    }

    document.getElementById('btnLog').onclick = () => {
        const blob = new Blob(logBuffer, { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Dados_Mondego_Full.txt`;
        a.click();
    };

    document.getElementById('btnRun').onclick = function() {
        rodando = !rodando;
        this.innerText = rodando ? "PARAR" : "INICIAR";
    };

    setInterval(() => { if(rodando) simular(); }, 1000);
</script>
</body>
</html>
