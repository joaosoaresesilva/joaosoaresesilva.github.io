<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA INTEGRADO MONDEGO: Visualização de Cheia</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b0e14; color: #e0e0e0; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        .dashboard { width: 1100px; background: #161b22; padding: 25px; border-radius: 12px; border: 1px solid #30363d; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* NOVO: Estilo das Zonas Alagadas */
        .flood-zones { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .zone-card { background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; position: relative; height: 120px; overflow: hidden; }
        .water-fill { position: absolute; bottom: 0; left: 0; width: 100%; background: #58a6ff; transition: height 0.3s ease, background 0.3s; opacity: 0.6; }
        .danger-fill { background: #f85149 !important; }
        .zone-label { position: relative; z-index: 2; font-weight: bold; text-shadow: 1px 1px 2px #000; }

        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #30363d; padding-bottom: 15px; margin-bottom: 20px; }
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; background: #0d1117; padding: 20px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 20px; }
        .status-panel { display: flex; justify-content: space-around; padding: 10px; background: #1c2128; border-radius: 4px; margin-bottom: 15px; font-weight: bold; border-left: 5px solid #58a6ff; }
        .critical { color: #f85149; text-shadow: 0 0 10px rgba(248, 81, 73, 0.5); }
        button { padding: 12px; cursor: pointer; background: #238636; color: white; border: none; border-radius: 6px; font-weight: bold; }
        button:hover { background: #2ea043; }
        input[type=range] { width: 100%; cursor: pointer; }
        .label-val { color: #d29922; font-family: monospace; font-size: 1.2em; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="header">
        <div>
            <h2 style="margin:0; color:#58a6ff;">Monitorização de Zonas Alagadas</h2>
            <small style="color:#8b949e;">Impacto Hidrodinâmico em Tempo Real</small>
        </div>
        <div style="text-align: right;">
            <div id="clock" style="font-size: 1.5em; font-family: monospace;">00:00</div>
        </div>
    </div>

    <div class="flood-zones">
        <div class="zone-card" id="cardCoimbra">
            <div class="zone-label">COIMBRA (Baixa)<br><small>Limite: 20.0m</small></div>
            <div id="fillCoimbra" class="water-fill"></div>
        </div>
        <div class="zone-card" id="cardAlfarelos">
            <div class="zone-label">ALFARELOS (Campos)<br><small>Limite: 11.5m</small></div>
            <div id="fillAlfarelos" class="water-fill"></div>
        </div>
    </div>

    <div class="status-panel">
        <div>NÍVEL COIMBRA: <span id="hCoimbraVal">15.50</span>m</div>
        <div>NÍVEL ALFARELOS: <span id="hAlfarelosVal">9.50</span>m</div>
        <div>ESTADO: <span id="txtEstado" style="color: #3fb950;">NOMINAL</span></div>
    </div>

    <div class="controls">
        <div>
            <label>Abertura do Açude: <b id="gVal" class="label-val">20</b>%</label>
            <input type="range" id="gateCtrl" min="0" max="100" value="20">
        </div>
        <div style="text-align: center; border-left: 1px solid #30363d; border-right: 1px solid #30363d;">
            <span style="font-size: 0.8em;">MARÉ (JUSANTE)</span>
            <div id="mareStatus" style="font-size: 1.1em; margin-top: 10px; color: #d29922;">---</div>
        </div>
        <div>
            <button id="stormBtn" style="width: 100%; background: #da3633;">LANÇAR DESCARGA (2200 m³/s)</button>
        </div>
    </div>

    <canvas id="mainChart"></canvas>
</div>

<script>
    const ctx = document.getElementById('mainChart').getContext('2d');
    const totalPontos = 96;
    let labelsHoras = [];
    for(let i=0; i<totalPontos; i++) {
        let h = Math.floor(i / 4).toString().padStart(2,'0');
        let m = ((i % 4) * 15).toString().padStart(2,'0');
        labelsHoras.push(`${h}:${m}`);
    }

    let qIn = new Array(totalPontos).fill(250);
    let qOutCoimbra = new Array(totalPontos).fill(250);
    let hCoimbra = new Array(totalPontos).fill(15.5);
    let hAlfarelos = new Array(totalPontos).fill(9.5);
    let hMare = new Array(totalPontos).fill(15.0);
    
    let tick = 0;
    let gateAperture = 0.2;
    const tauAC = 20; 
    const tauCA = 8;  

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labelsHoras,
            datasets: [
                { label: 'Aguieira (m³/s)', data: qIn, borderColor: '#ff9f43', pointRadius: 0, tension: 0.3 },
                { label: 'Cota Coimbra (m)', data: hCoimbra, borderColor: '#f85149', yAxisID: 'y1', borderWidth: 3, pointRadius: 0 },
                { label: 'Cota Alfarelos (m)', data: hAlfarelos, borderColor: '#3fb950', yAxisID: 'y1', borderWidth: 2, pointRadius: 0 },
                { label: 'Maré (m)', data: hMare, borderColor: '#444', borderDash: [5,5], yAxisID: 'y1', pointRadius: 0 }
            ]
        },
        options: {
            animation: false,
            scales: {
                y: { min: 0, max: 3500, grid: {color: '#30363d'} },
                y1: { position: 'right', min: 8, max: 25, grid: {drawOnChartArea: false} }
            }
        }
    });

    function processarSimulacao() {
        tick = (tick + 1) % totalPontos;
        document.getElementById('clock').innerText = labelsHoras[tick];

        let nivelMare = 15.0 + Math.sin((tick / totalPontos) * Math.PI * 4) * 1.5;
        
        let hC = hCoimbra[hCoimbra.length - 1];
        let diffPressao = Math.max(0.1, hC - nivelMare);
        let descargaCoimbra = gateAperture * 2800 * Math.sqrt(diffPressao / 2);

        let qChegadaCoimbra = qIn[qIn.length - tauAC] || qIn[0];
        let dhCoimbra = (qChegadaCoimbra - descargaCoimbra) / 7000;
        let novoHC = hC + dhCoimbra;

        let hA = hAlfarelos[hAlfarelos.length - 1];
        let qChegadaAlfarelos = qOutCoimbra[qOutCoimbra.length - tauCA] || qOutCoimbra[0];
        let escoamentoAlfarelos = 180 * Math.sqrt(Math.max(0.1, hA - 8.5));
        let dhAlfarelos = (qChegadaAlfarelos - escoamentoAlfarelos) / 15000;
        let novoHA = hA + dhAlfarelos;

        qIn.shift(); qIn.push(qIn[qIn.length-1]);
        qOutCoimbra.shift(); qOutCoimbra.push(descargaCoimbra);
        hCoimbra.shift(); hCoimbra.push(novoHC);
        hAlfarelos.shift(); hAlfarelos.push(novoHA);
        hMare.shift(); hMare.push(nivelMare);

        // ATUALIZAÇÃO VISUAL DAS ZONAS ALAGADAS
        // Coimbra: 14m (vazio) a 22m (máximo visual)
        let percC = Math.max(0, Math.min(100, (novoHC - 14) * 12.5));
        document.getElementById('fillCoimbra').style.height = percC + "%";
        if(novoHC >= 20.0) document.getElementById('fillCoimbra').classList.add('danger-fill');
        else document.getElementById('fillCoimbra').classList.remove('danger-fill');

        // Alfarelos: 8.5m (vazio) a 13m (máximo visual)
        let percA = Math.max(0, Math.min(100, (novoHA - 8.5) * 22));
        document.getElementById('fillAlfarelos').style.height = percA + "%";
        if(novoHA >= 11.5) document.getElementById('fillAlfarelos').classList.add('danger-fill');
        else document.getElementById('fillAlfarelos').classList.remove('danger-fill');

        // Dados numéricos
        document.getElementById('hCoimbraVal').innerText = novoHC.toFixed(2);
        document.getElementById('hAlfarelosVal').innerText = novoHA.toFixed(2);
        document.getElementById('mareStatus').innerText = nivelMare > 15 ? "ENCHENTE ↑" : "VAZANTE ↓";

        chart.update('none');
    }

    document.getElementById('gateCtrl').oninput = function() {
        gateAperture = this.value / 100;
        document.getElementById('gVal').innerText = this.value;
    };

    document.getElementById('stormBtn').onclick = function() {
        let pico = 2200;
        for(let i=0; i<30; i++) {
            setTimeout(() => { qIn[qIn.length - 1] = pico; }, i * 50);
        }
    };

    setInterval(processarSimulacao, 500);
</script>
</body>
</html>
