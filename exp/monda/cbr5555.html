<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Simulador Hidr치ulico: Coimbra vs Terras Baixas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #121212; color: white; }
        #map { height: 65vh; width: 100%; }
        .panel { padding: 15px; background: #1e1e1e; border-top: 4px solid #00d2ff; }
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .slider-box { background: #2d2d2d; padding: 12px; border-radius: 8px; border: 1px solid #444; text-align: center; }
        .stats-val { font-size: 1.4em; color: #00d2ff; font-weight: bold; display: block; margin-top: 5px; }
        input[type=range] { width: 100%; accent-color: #00d2ff; }
        button { padding: 12px; font-weight: bold; cursor: pointer; border-radius: 4px; border: none; width: 100%; transition: 0.3s; }
        #btnStart { background: #00b894; color: white; }
        #btnReset { background: #d63031; color: white; margin-top: 5px; }
        #msg { text-align: center; margin-top: 10px; font-weight: bold; color: #feca57; font-size: 0.9em; min-height: 2.4em; }
        .label-style { background: rgba(0,0,0,0.85); border: 1px solid #00d2ff; color: white; font-size: 10px; padding: 3px; border-radius: 3px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
    <div class="controls-grid">
        <div class="slider-box">
            <label>Caudal: <b id="lblFlow">2200</b> m췁/s</label>
            <input type="range" id="inpFlow" min="500" max="15000" step="100" value="2200">
        </div>
        <div class="slider-box">
            <label>Diques de Jusante:</label>
            <select id="selDam" style="width:100%; margin-top:10px; padding:5px; background: #333; color: white;">
                <option value="1">Sistema Intacto</option>
                <option value="0.5">Satura칞칚o/Fissuras</option>
                <option value="0">Ruptura Total</option>
            </select>
        </div>
        <div class="slider-box">
            <span>Tempo</span>
            <span id="valTime" class="stats-val">0h</span>
        </div>
        <div class="slider-box">
            <span>N칤vel Rio (CBR)</span>
            <span id="valLevel" class="stats-val">15.00m</span>
        </div>
        <div class="slider-box">
            <button id="btnStart">SIMULAR</button>
            <button id="btnReset">RESET</button>
        </div>
    </div>
    <div id="msg">Sistema pronto. Coimbra vulner치vel ao n칤vel direto.</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([40.1850, -8.5000], 11);
    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: 'OpenTopoMap' }).addTo(map);

    var zonas = [
        // ZONAS URBANAS (Sem prote칞칚o de dique de solo, dependem apenas do n칤vel)
        { nome: "ETA Boavista (16.5m)", centro: [40.1895, -8.4215], threshold: 16.5, max: 400, protegida: false },
        { nome: "CBR: Parque Verde/S.Clara (15.2m)", centro: [40.2018, -8.4338], threshold: 15.2, max: 450, protegida: false },
        { nome: "CBR: Baixa (15.7m)", centro: [40.2095, -8.4315], threshold: 15.7, max: 600, protegida: false },
        
        // ZONAS DE JUSANTE (Protegidas por diques)
        { nome: "Alfarelos: Esta칞칚o (8.2m)", centro: [40.1555, -8.6145], threshold: 8.2, max: 1500, protegida: true },
        { nome: "Ereira (6.2m)", centro: [40.1605, -8.7050], threshold: 6.2, max: 1600, protegida: true },
        { nome: "Maiorca (6.0m)", centro: [40.1750, -8.7400], threshold: 6.0, max: 1500, protegida: true }
    ];

    var focosDinamicos = [];
    var nivelBase = 15.0;
    var tempoHoras = 0;
    var timer = null;

    zonas.forEach(function(z) {
        z.shape = L.circle(z.centro, { color: z.protegida ? '#1dd1a1' : '#0984e3', weight: 2, fillColor: "#74b9ff", fillOpacity: 0, radius: 0 }).addTo(map);
        L.marker(z.centro, {opacity: 0}).addTo(map).bindTooltip(z.nome, {permanent: true, direction: 'top', className: 'label-style'});
    });

    function gerarFocoDinamico() {
        var statusDam = parseFloat(document.getElementById('selDam').value);
        var caudal = parseInt(document.getElementById('inpFlow').value);
        // S칩 surge se os diques falharem ou caudal for muito alto
        if (caudal > (3000 + (statusDam * 1500)) || statusDam < 0.6) {
            let lat = 40.12 + (Math.random() * 0.16);
            let lng = -8.75 + (Math.random() * 0.32); // Raio de 16km
            L.circle([lat, lng], { color: '#d63031', weight: 1, fillColor: "#ff7675", fillOpacity: 0.4, radius: 150 + (Math.random() * 400) }).addTo(map);
        }
    }

    function atualizarSimulacao() {
        var statusDam = parseFloat(document.getElementById('selDam').value);
        var caudal = parseInt(document.getElementById('inpFlow').value);
        var afetados = [];

        zonas.forEach(function(z) {
            let nLocal;
            
            if (z.protegida) {
                // L칩gica para JUSANTE: Dique segura at칠 certo ponto
                let protecaoReal = 6.5 * statusDam;
                let esforco = caudal / 4200;
                nLocal = z.threshold + (nivelBase - 15.0) + esforco - protecaoReal;
                
                // Trava: S칩 alaga se o dique for vencido pelo caudal
                if (nLocal > z.threshold && (caudal > (2400 + (statusDam * 1400)) || statusDam === 0)) {
                    exibirAlagamento(z, nLocal);
                    afetados.push(z.nome.split(" (")[0]);
                } else { z.shape.setRadius(0); }
            } else {
                // L칩gica para COIMBRA: Alagamento Direto (N칤vel do Rio)
                nLocal = nivelBase + (caudal / 8000); 
                if (nLocal > z.threshold) {
                    exibirAlagamento(z, nLocal);
                    afetados.push(z.nome.split(" (")[0]);
                } else { z.shape.setRadius(0); }
            }
        });

        if (tempoHoras % 6 === 0 && tempoHoras > 0) gerarFocoDinamico();

        document.getElementById('msg').innerHTML = afetados.length > 0 ? 
            "游뚿 <b>AVISO:</b> " + afetados.join(" | ") : "Cotas normais.";
    }

    function exibirAlagamento(z, nLocal) {
        let expansao = 1 + (tempoHoras / 50);
        z.shape.setRadius(Math.min((nLocal - z.threshold) * 700 * expansao, z.max * 2));
        z.shape.setStyle({ fillOpacity: 0.6, color: '#d63031' });
    }

    document.getElementById('btnStart').onclick = function() {
        if (timer) { clearInterval(timer); timer = null; this.innerText = "RETOMAR"; }
        else {
            this.innerText = "PAUSAR";
            timer = setInterval(function() {
                tempoHoras++;
                let caudal = parseInt(document.getElementById('inpFlow').value);
                nivelBase += (caudal - 1600) / 18000;
                if (nivelBase > 22.0) nivelBase = 22.0;

                document.getElementById('valTime').innerText = Math.floor(tempoHoras/24) + "d " + (tempoHoras%24) + "h";
                document.getElementById('valLevel').innerText = Math.max(8, nivelBase).toFixed(2) + "m";
                atualizarSimulacao();
            }, 500);
        }
    };

    document.getElementById('btnReset').onclick = () => location.reload();
    document.getElementById('inpFlow').oninput = function() { document.getElementById('lblFlow').innerText = this.value; };
</script>
</body>
</html>
