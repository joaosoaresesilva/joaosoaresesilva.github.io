<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Gestão Hidráulica: Aguieira & Açude Coimbra</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #fff; padding: 20px; font-size: 13px; }
        .dashboard { display: grid; grid-template-columns: 320px 1fr 250px; gap: 20px; }
        .controls, .history-panel { border: 2px solid #000; padding: 15px; background: #f4f4f4; }
        .control-group { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ccc; }
        
        .chart-container { position: relative; height: 400px; border-left: 2px solid #000; border-bottom: 2px solid #000; margin-left: 40px; background: #eef; }
        .acude-gate { position: absolute; left: 5%; width: 4px; background: #666; bottom: 0; z-index: 3; border-top: 3px solid #000; transition: height 0.5s; }
        
        .zone-point { position: absolute; width: 10px; height: 10px; background: #fff; border: 2px solid #000; border-radius: 50%; transform: translate(-50%, 50%); z-index: 4; }
        .zone-tag { position: absolute; font-size: 9px; transform: rotate(-45deg); white-space: nowrap; top: 15px; }
        
        .mini-chart { width: 100%; height: 100px; border: 1px solid #000; background: #fff; position: relative; margin-bottom: 10px; }
        .bar { position: absolute; bottom: 0; width: 2px; }
        
        button { background: #000; color: #fff; border: none; padding: 8px; cursor: pointer; width: 100%; font-family: inherit; margin-bottom: 5px; }
        .active { background: #0056b3; }
        .alert { color: red; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>
    <h2>CONTROLO OPERACIONAL: AÇUDE-PONTE E AGUIEIRA</h2>
    <div class="dashboard">
        <div class="controls">
            <div class="control-group">
                <label><b>CONTROLO AGUIEIRA (A JUSANTE)</b></label><br>
                <input type="range" id="q-in" min="200" max="4000" value="600">
                <span id="val-q">600</span> m³/s
            </div>
            
            <div class="control-group">
                <label><b>ESTADO DO AÇUDE COIMBRA</b></label><br>
                <button id="btn-acude" onclick="toggleAcude()">COMPORTAS: FECHADAS (NORMAL)</button>
                <small>Abertura automática se Q > 1200 m³/s</small>
            </div>

            <div class="control-group">
                <label><b>MARÉ</b></label>
                <input type="range" id="m-in" min="-100" max="450" value="0">
            </div>

            <div id="status-panel" class="status-box">
                STATUS: SISTEMA EM OPERAÇÃO NOMINAL
            </div>
        </div>

        <div class="chart-area">
            <div class="chart-container" id="chart">
                <div class="acude-gate" id="gate-visual" style="height: 45%;"></div>
                <div style="position:absolute; left:5%; bottom:46%; font-size:10px;">AÇUDE</div>
                
                <svg width="100%" height="100%" style="position:absolute; bottom:0;">
                    <path id="path-line" d="" fill="none" stroke="blue" stroke-width="3" />
                </svg>

                <div id="z-coimbra" class="zone-point" style="left: 5%;"><span class="zone-tag">Coimbra (Montante)</span></div>
                <div id="z-baixomon" class="zone-point" style="left: 30%;"><span class="zone-tag">Baixo Mondego</span></div>
                <div id="z-foz" class="zone-point" style="left: 100%;"><span class="zone-tag">Foz</span></div>
            </div>
        </div>

        <div class="history-panel">
            <label>NÍVEL NO AÇUDE (m)</label>
            <div class="mini-chart" id="hist-nivel"></div>
            <label>CAUDAL AGUIEIRA (m³/s)</label>
            <div class="mini-chart" id="hist-q"></div>
        </div>
    </div>

    <script>
        let acudeAberto = false;
        let bufferQ = new Array(30).fill(600); 
        let hNivel = [], hQ = [];

        function toggleAcude() {
            acudeAberto = !acudeAberto;
            const btn = document.getElementById('btn-acude');
            btn.innerText = acudeAberto ? "COMPORTAS: ABERTAS (CHEIA)" : "COMPORTAS: FECHADAS (NORMAL)";
            btn.classList.toggle('active');
        }

        function update() {
            let qInput = parseInt(document.getElementById('q-in').value);
            let mare = parseInt(document.getElementById('m-in').value) / 100;
            
            bufferQ.push(qInput);
            let qChegada = bufferQ.shift();

            // Lógica do Açude: Se o caudal for muito alto, as comportas TÊM de abrir
            if (qChegada > 1200 && !acudeAberto) toggleAcude();
            
            document.getElementById('val-q').innerText = qInput;
            document.getElementById('gate-visual').style.height = acudeAberto ? "10%" : "45%";

            // Cálculo da Cota em Coimbra (Montante do Açude)
            // Se fechado, o nível é mantido artificialmente alto (espelho de água)
            // Se aberto, o nível depende puramente do caudal (regime livre)
            let cotaCoimbra;
            if (!acudeAberto) {
                cotaCoimbra = 45 + (qChegada / 150); // Mantém nível alto
            } else {
                cotaCoimbra = 20 + (qChegada / 30); // Nível desce mas sobe com o caudal
            }

            // Desenho do Perfil
            let points = [
                {x: 5, y: cotaCoimbra},
                {x: 30, y: (qChegada/40) + (mare*5)},
                {x: 100, y: mare * 20}
            ];

            let pathD = "";
            points.forEach((p, i) => {
                let px = (p.x / 100) * document.getElementById('chart').offsetWidth;
                let py = 400 - (p.y / 100 * 400);
                pathD += (i === 0 ? "M" : "L") + px + "," + py;
                
                let dot = document.getElementById(['z-coimbra','z-baixomon','z-foz'][i]);
                dot.style.bottom = p.y + "%";
                dot.style.left = p.x + "%";
            });

            document.getElementById('path-line').setAttribute("d", pathD);
            
            // Histórico
            hNivel.push(cotaCoimbra);
            hQ.push(qInput);
            if(hNivel.length > 100) { hNivel.shift(); hQ.shift(); }
            
            drawChart('hist-nivel', hNivel, '#00f', 100);
            drawChart('hist-q', hQ, '#666', 4000);

            // Alertas
            const status = document.getElementById('status-panel');
            if (cotaCoimbra > 75) {
                status.innerHTML = "<span class='alert'>ALERTA: TRANSBORDO EM COIMBRA!</span>";
            } else if (acudeAberto && qChegada < 800) {
                status.innerText = "AVISO: PODE FECHAR AÇUDE PARA RECUPERAR ESPELHO";
            } else {
                status.innerText = "STATUS: SISTEMA ESTÁVEL";
            }
        }

        function drawChart(id, data, color, max) {
            const c = document.getElementById(id);
            c.innerHTML = "";
            data.forEach((v, i) => {
                const b = document.createElement('div');
                b.className = 'bar';
                b.style.left = (i * 2.5) + 'px';
                b.style.height = (v / max * 100) + '%';
                b.style.backgroundColor = color;
                c.appendChild(b);
            });
        }

        setInterval(update, 150);
    </script>
</body>
</html>
